# AI Platform Deployment Documentation

## 11.60 Identity Provider - MFA (TOTP, WebAuthn, Recovery Codes)

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Mandatory MFA configuration, enrollment workflows, admin controls, recovery procedures, and verification evidence.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/11-Backend-Identity-Provider/11.60-MFA-TOTP-WebAuthn-RecoveryCodes` |
| Filename (target) | `docs/11-Backend-Identity-Provider/11.60-MFA-TOTP-WebAuthn-RecoveryCodes.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + Identity Engineering |
| Status | Mandatory (Tier 0/1); recommended for Tier 2/3 per policy |
| Runs on | AI-DATA01 (IdP), accessed via AI-FRONTEND01 reverse proxy |
| Hard requirements | MFA enforced, recovery codes enabled, reset approval workflow, audit events logged |
| Related docs | 04.30 MFA Policy Standard; 04.70 Break-Glass; 03.30 Audit; 03.40 Retention; 11.10 Ports |
| Security note | Never store MFA seeds or recovery codes in shared docs. Users store codes securely. |
| Evidence requirement | Enrollment tests, recovery code generation test, reset procedure test, audit log evidence |
| Change trigger | Re-run after IdP upgrade, MFA method changes, or policy changes |
| Time zone | Africa/Johannesburg |
| Lab defaults | Zone E admin allowlist; LAN-only access |

## Contents

- 1. Purpose and outcomes
- 2. Threat model summary (MFA)
- 3. MFA methods supported and when to use each
- 4. MFA tiers (Tier 0-3) and enforcement model
- 5. User enrollment workflows (TOTP and WebAuthn)
- 6. Recovery codes: generation, storage, and usage
- 7. MFA reset policy (approval + audit)
- 8. Step-by-step: Configure MFA policy files (full replacement)
- 8.1 `/opt/idp/config/mfa-policy.yaml`
- 8.2 `/opt/idp/config/mfa-enrollment-checklist.md` (ops checklist file)
- 9. Step-by-step: Operator procedures (helpdesk-safe)
- 10. Verification checklist (mandatory)
- 11. Client rollout variables (template)

## 1. Purpose and outcomes

This document defines how Multi-Factor Authentication (MFA) is implemented for the platform Identity Provider.

Outcomes:

- Tier-based MFA enforcement (Tier 0/1 mandatory).
- Support for TOTP (Authenticator apps) and WebAuthn (security keys / passkeys).
- Recovery codes are enabled and required for high-privilege users.
- MFA resets follow an approval workflow and are fully audited.
- Operators have a safe, repeatable procedure with verification steps.

## 2. Threat model summary (MFA)

- T1: Password compromise -> Mitigation: MFA reduces account takeover risk.
- T2: MFA phishing / push fatigue -> Mitigation: prefer WebAuthn for Tier 0; educate users; restrict admin paths.
- T3: Lost device -> Mitigation: recovery codes + secondary method enrollment; controlled MFA reset process.
- T4: Helpdesk social engineering -> Mitigation: MFA reset requires approval and strong identity proofing; logged as high severity.
- T5: Recovery code leakage -> Mitigation: user storage guidance; codes generated once; regeneration logs invalidate previous codes.

## 3. MFA methods supported and when to use each

- TOTP (Time-based One-Time Password): baseline method using authenticator apps (Aegis, Microsoft Authenticator, Google Authenticator).
- WebAuthn (Passkeys / Security Keys): phishing-resistant method; preferred for Tier 0 admins.
- Recovery Codes: fallback if primary device unavailable; required for Tier 0/1.

### 3.1 Recommended user guidance (summary)

- Tier 0: enroll WebAuthn + TOTP; store recovery codes offline (password manager + printed sealed copy).
- Tier 1: enroll TOTP; optionally WebAuthn; store recovery codes.
- Tier 2/3: enroll at least one method where required by policy.

## 4. MFA tiers (Tier 0-3) and enforcement model

- Tier 0 (Platform/IdP Admins): MFA mandatory; WebAuthn preferred; recovery codes required.
- Tier 1 (Security/Audit/Automation operators): MFA mandatory (TOTP minimum); recovery codes required.
- Tier 2 (Project Owners/Editors): MFA recommended or enforced by client policy.
- Tier 3 (Standard users): optional unless client mandates it.

### 4.1 Enforcement approach

- Enforce MFA at IdP for group-based tiers (preferred) rather than app-by-app.
- Block issuance of tokens for Tier 0/1 users until MFA enrollment is complete.
- Admin console access requires MFA even if user already has an active session (step-up auth if supported).

## 5. User enrollment workflows (TOTP and WebAuthn)

### 5.1 TOTP enrollment (user workflow)

1. User navigates to the IdP profile/security page (via `https://id.<domain>`).
2. Select "Add authenticator" / "TOTP" method.
3. Scan the QR code using an authenticator app (Aegis recommended for Android; iOS passkeys supported).
4. Enter the 6-digit code to confirm enrollment.
5. Confirm next login prompts for TOTP code.

### 5.2 WebAuthn enrollment (user workflow)

6. User navigates to IdP profile/security page.
7. Select "Add security key / passkey (WebAuthn)".
8. Choose device option: security key (USB/NFC) or platform passkey (Windows Hello, macOS/iOS, Android).
9. Complete the browser prompt to register the key/passkey.
10. Name the credential clearly (e.g., `YubiKey-Primary` or `WindowsHello-Laptop`).
11. Confirm next login can use passkey/WebAuthn (where supported).

### 5.3 Recommended enrollment for Tier 0

- Enroll at least 2 methods: WebAuthn primary + TOTP fallback.
- Enroll WebAuthn on two devices/keys if possible (primary + backup).
- Generate and store recovery codes.

## 6. Recovery codes: generation, storage, and usage

### 6.1 Generation

12. After MFA method enrollment, user selects "Generate recovery codes".
13. User downloads or copies the codes (one-time view).
14. User confirms secure storage and acknowledges that regenerating codes invalidates old codes.

### 6.2 Storage guidance (POPIA-friendly)

- Store in a password manager as a secure note (preferred).
- Store an offline printed copy in a sealed envelope for Tier 0 (optional).
- Do not store in email, chat apps, or shared documents.
- Do not photograph the codes.

### 6.3 Usage

- If user cannot access primary MFA device, choose "Use a recovery code" at login.
- Each code is single-use; IdP marks used codes as invalid.
- After using a recovery code, user should re-enroll MFA methods or verify current MFA device is still available.

## 7. MFA reset policy (approval + audit)

- MFA reset is a high-risk action. Only Identity Admins (Tier 0) may perform resets.
- Resets require approval (manager + security owner for Tier 0/1).
- Identity proofing is required (in-person or verified process).
- All MFA reset events are logged with high severity and reviewed.
- After reset: user must re-enroll MFA immediately; account may remain disabled until enrollment completed.

### 7.1 Identity proofing checklist (summary)

- Confirm user identity via two independent factors (photo ID + known contact method).
- Confirm the request is recorded in the ticketing system.
- Confirm approvals are present.
- Perform reset and require immediate re-enrollment.

## 8. Step-by-step: Configure MFA policy files (full replacement)

These files define the MFA policy baseline and the operator checklist used during enrollment and resets.

Step 8.1 - Create `/opt/idp/config/mfa-policy.yaml` (full contents)  
Terminal/app: SSH to AI-DATA01. Editor: `nano`.

15. Open: `sudo nano /opt/idp/config/mfa-policy.yaml`
16. Delete any existing content.
17. Paste the full contents below.
18. Save and exit.

```yaml
# /opt/idp/config/mfa-policy.yaml
# MFA baseline policy (no secrets)

mfa:
  enabled: true
  methods:
    totp:
      enabled: true
      required_for_tiers: ["TIER0", "TIER1"]
    webauthn:
      enabled: true
      required_for_tiers: ["TIER0"]
  recovery_codes:
    enabled: true
    min_codes: 10
    required_for_tiers: ["TIER0", "TIER1"]
    regenerate_invalidates_old: true

enforcement:
  block_token_issuance_until_enrolled: true
  step_up_for_admin_console: true

reset_policy:
  enabled: true
  allowed_roles: ["AI-PLATFORM-ADMINS"]
  requires_approval: true
  requires_identity_proofing: true
  post_reset_require_enroll: true
  severity: "high"

audit:
  log_mfa_enroll: true
  log_mfa_reset: true
  log_recovery_codes_generated: true
  log_recovery_code_used: true
```

Verification:

```bash
sudo sed -n '1,220p' /opt/idp/config/mfa-policy.yaml
```

Step 8.2 - Create `/opt/idp/config/mfa-enrollment-checklist.md` (ops checklist file)  
This is a local operations checklist file used by Identity Admins. It contains no secrets.

19. Open: `sudo nano /opt/idp/config/mfa-enrollment-checklist.md`
20. Paste the full contents below.
21. Save and exit.

```markdown
# MFA Enrollment & Reset Checklist (Ops)

## Enrollment (New User / First Login)
- [ ] User account exists and is approved (ticket/ref)
- [ ] User sets a compliant password (min length per policy)
- [ ] Enroll TOTP (scan QR, verify code)
- [ ] Enroll WebAuthn (Tier 0 required; recommended for Tier 1)
- [ ] Generate recovery codes (10+)
- [ ] Confirm user stored codes securely (password manager / sealed copy)
- [ ] Confirm next login requires MFA
- [ ] Verify token contains expected groups claim (decode JWT)

## MFA Reset (Lost Device / Compromise)
- [ ] Ticket created and approvals recorded
- [ ] Identity proofing completed (2 independent checks)
- [ ] Reset MFA methods
- [ ] Force immediate re-enrollment (TOTP + recovery codes; WebAuthn for Tier 0)
- [ ] Revoke sessions/tokens if supported
- [ ] Capture audit evidence (timestamp, admin actor, user)
- [ ] Post-incident review scheduled (if compromise suspected)
```

Permissions:

```bash
sudo chown -R root:root /opt/idp/config
sudo chmod 0750 /opt/idp/config
sudo chmod 0640 /opt/idp/config/mfa-policy.yaml /opt/idp/config/mfa-enrollment-checklist.md
sudo ls -la /opt/idp/config | sed -n '1,120p'
```

## 9. Step-by-step: Operator procedures (helpdesk-safe)

### 9.1 Assist a user to enroll TOTP (script)

- Never ask a user to share their QR code or TOTP secret.
- Ask the user to share only the 6-digit code during enrollment if needed (time-limited).
- Confirm their device time is correct if codes fail.

### 9.2 Assist a Tier 0 admin to enroll WebAuthn

- Confirm supported browser (Chrome/Edge/Firefox) and OS (Windows Hello, macOS passkeys).
- Encourage a hardware key for admins where possible (primary + backup).
- Require naming conventions for passkeys.

### 9.3 Recovery code usage guidance

- If a recovery code was used, treat it as a sign that the user may be at risk of lost device access.
- Ensure the user re-enrolls MFA and generates new recovery codes if necessary.
- Audit event review: confirm that recovery code usage was legitimate.

### 9.4 MFA reset procedure (operator)

22. Confirm approvals + identity proofing.
23. Perform MFA reset as Tier 0 Identity Admin from Zone E allowlist only.
24. Require immediate re-enrollment.
25. Capture audit logs and store evidence.

## 10. Verification checklist (mandatory)

- V1: Tier 0 user cannot obtain tokens until MFA enrolled; enrollment required on next login.
- V2: WebAuthn works for Tier 0 (passkey/security key login succeeds).
- V3: TOTP works for Tier 1 and above; incorrect codes are rejected.
- V4: Recovery codes are generated and single-use; usage logs are recorded.
- V5: MFA reset requires approval and is logged with high severity.
- V6: No MFA secrets or recovery codes are stored in shared docs or logs.

## 11. Client rollout variables (template)

| Variable | Value |
|---|---|
| MFA enabled | `true` |
| TOTP required tiers | `Tier 0, Tier 1` |
| WebAuthn required tiers | `Tier 0` |
| Recovery codes required tiers | `Tier 0, Tier 1` |
| Minimum recovery codes | `10` |
| Access token minutes | `20 (example)` |
| Step-up auth for admin console | `enabled` |
| MFA reset allowed roles | `AI-PLATFORM-ADMINS only` |
| Approval required | `true` |
| Identity proofing required | `true` |
| Lockout policy | `per local-users-policy or IdP baseline` |
| Zone E allowlist | `<CIDR/IP list>` |
| Supported browsers | `Chrome/Edge/Firefox (latest)` |
| Recommended authenticator apps | `Aegis (Android), Microsoft Authenticator, Google Authenticator` |
| Recommended security keys | `YubiKey or equivalent` |
| Audit retention | `per 03.40` |
| Evidence repository | `<secure path>` |
| Ops checklist file | `/opt/idp/config/mfa-enrollment-checklist.md` |
