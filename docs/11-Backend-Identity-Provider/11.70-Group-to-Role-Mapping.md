# AI Platform Deployment Documentation

## 11.70 Identity Provider - Group-to-Role Mapping (Claims Standard)

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Canonical group taxonomy, mapping rules for AD or Local Users, token claims format, and downstream app consumption.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/11-Backend-Identity-Provider/11.70-Group-to-Role-Mapping` |
| Filename (target) | `docs/11-Backend-Identity-Provider/11.70-Group-to-Role-Mapping.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Identity Architecture |
| Status | Mandatory; must be consistent for UI, Gateway, Nextcloud, Search, optional automations |
| Applies to | AD-integrated mode (11.40) and Local Users mode (11.50) |
| Hard requirements | Single canonical claim name; no leakage; least privilege default; documented naming |
| Related docs | 04.40 RoleModel-RBAC-Groups; 04.60 SSO matrix; 10.50 RBAC; 21.35+ Nextcloud roles; 30.15 ACL inheritance |
| Security note | Apps must enforce deny-by-default and never trust client-side roles. |
| Evidence requirement | Token claim inspection + app RBAC tests |
| Change trigger | Re-run if groups change or new project codes/apps are added |
| Time zone | Africa/Johannesburg |
| Lab defaults | Projects: BANANA-PEEL, NIGHT-PENGUIN, DAD-JOKE, LASAGNA, MASTER |

## Contents

- 1. Purpose and outcomes
- 2. Claims standard (what goes in the token)
- 3. Canonical group taxonomy
- 4. Platform roles mapping
- 5. Project roles mapping
- 6. Mapping sources: AD groups vs Local IdP groups
- 7. Downstream consumption rules (UI, Gateway, Nextcloud, Search, automation)
- 8. Naming convention and project code rules
- 9. Full replacement mapping templates
- 9.1 `/opt/idp/config/claims-standard.yaml`
- 9.2 `/opt/idp/config/group-taxonomy.yaml`
- 9.3 `/opt/idp/config/project-codes.yaml`
- 10. Verification checklist (mandatory)
- 11. Client rollout variables (template)

## 1. Purpose and outcomes

Group-to-role mapping is the bridge between identity sources (AD or local users) and application authorization. The platform uses a consistent token claims standard so every app can make reliable RBAC decisions without being tightly coupled to a specific directory implementation.

Outcomes:

- One canonical claim name for groups/roles.
- Standard platform roles and project roles.
- Repeatable mapping templates for AD and Local Users mode.
- Consistent downstream RBAC enforcement across all apps.

## 2. Claims standard (what goes in the token)

- Claim name for group roles: `groups` (canonical).
- `groups` claim contains platform group names and project group names (strings).
- Tokens include standard JWT fields: `iss`, `sub`, `aud`, `exp`, `iat`.
- Tokens must not include excessive personal data (POPIA minimization).
- Tokens must be signed (`RS256`) and validated by the Gateway offline via JWKS.

### 2.1 Minimal identity fields (POPIA)

- `preferred_username` (or `upn`)
- `display_name` (optional)
- `email` (optional; only if required by UI/notifications)

## 3. Canonical group taxonomy

### 3.1 Platform groups

- `AI-PLATFORM-ADMINS` - platform super-admins (Tier 0).
- `AI-SECURITY-AUDITORS` - read-only access to security/audit evidence (Tier 1).
- `AI-OPS-READONLY` - operational read-only (Tier 2/3).

### 3.2 Project groups (canonical pattern)

Pattern: `AI-NC-PROJ-<PROJECT_CODE>-<ROLE>`

- ROLE values: `VIEW`, `EDIT`, `OWNER`
- Examples: `AI-NC-PROJ-BANANA-PEEL-VIEW`; `AI-NC-PROJ-MASTER-OWNER`

### 3.3 Optional functional groups (if used)

- `AI-AUTOMATION-OPERATORS` - operators allowed to run/approve workflows (n8n/Windmill).
- `AI-SEARCH-ADMINS` - search/index admins (rare; use least privilege).
- `AI-NEXTCLOUD-ADMINS` - Nextcloud platform admins (separate from IdP admins).

## 4. Platform roles mapping

Apps interpret platform groups consistently:

| Group | Meaning | Typical capabilities |
|---|---|---|
| `AI-PLATFORM-ADMINS` | Tier 0 platform admins | Manage IdP, SSO, security policy, break-glass; access restricted to Zone E |
| `AI-SECURITY-AUDITORS` | Security/audit read-only | Read audit logs, verification evidence, compliance dashboards; cannot change config |
| `AI-OPS-READONLY` | Ops read-only | View service status and basic dashboards; no admin changes |
| `AI-AUTOMATION-OPERATORS` (optional) | Automation operator | Can run/approve workflows; no direct DB/admin access |

## 5. Project roles mapping

Project role groups drive permissions in Nextcloud, Search/Knowledge Graph visibility, and ingestion pipelines.

| Role | Group suffix | Meaning (enforced by apps) |
|---|---|---|
| Viewer | `-VIEW` | Can view/search project content; cannot upload/modify; mind-map nodes limited to authorized projects |
| Editor | `-EDIT` | Can upload/modify content within project; can trigger ingestion; cannot change ACL blueprint |
| Owner | `-OWNER` | Can manage project folder ACLs (where allowed), approve sharing exceptions, manage project metadata |

## 6. Mapping sources: AD groups vs Local IdP groups

### 6.1 AD-integrated mode

- AD groups are not emitted directly (recommended).
- IdP maps AD group DNs -> canonical platform group strings (`group-mapping.yaml` in 11.40).
- Unmapped AD groups are ignored by default (`emit_unmapped_ad_groups=false`).

### 6.2 Local Users mode

- Local IdP group names must already be canonical (match patterns exactly).
- Local group catalog is defined in `local-groups.yaml` (11.50).

## 7. Downstream consumption rules

- Gateway: enforces API authorization based on `groups` claim; deny-by-default; no trust in UI inputs (10.50).
- UI: uses `groups` claim to show/hide features, but server-side remains authoritative.
- Nextcloud: maps groups to Nextcloud groups and folder ACLs per 21.35-21.37.
- Search/Knowledge Graph: inherits ACLs; visibility requires both sides of an edge to be authorized (30.55).
- n8n/Windmill (optional): access restricted to `AI-AUTOMATION-OPERATORS`; workflows use service accounts with least privilege.

## 8. Naming convention and project code rules

- `PROJECT_CODE` must be uppercase letters, numbers, and hyphens only (e.g., `BANANA-PEEL`).
- No spaces; keep codes stable (changing codes requires migration).
- Group names are case sensitive in many systems; treat as canonical exact strings.
- New projects must be registered in `project-codes.yaml` and created consistently across IdP, Nextcloud, and Search.

## 9. Full replacement mapping templates

These templates live under `/opt/idp/config` and define the canonical claims and groups standard.

### 9.1 Create `/opt/idp/config/claims-standard.yaml` (full contents)

1. SSH to AI-DATA01.
2. Open: `sudo nano /opt/idp/config/claims-standard.yaml`
3. Paste full contents below and save.

```yaml
# /opt/idp/config/claims-standard.yaml
# Canonical JWT claims standard (no secrets)

claims:
  groups_claim: "groups"
  username_claim: "preferred_username"
  email_claim: "email"            # optional; include only if required
  display_name_claim: "name"      # optional

security:
  signing_algorithm: "RS256"
  allow_none_alg: false
  allow_hs_alg: false
  offline_jwks_validation: true

minimization:
  include_email: false
  include_display_name: true
```

Verify:

```bash
sudo sed -n '1,220p' /opt/idp/config/claims-standard.yaml
```

### 9.2 Create `/opt/idp/config/group-taxonomy.yaml` (full contents)

4. Open: `sudo nano /opt/idp/config/group-taxonomy.yaml`
5. Paste full contents and save.

```yaml
# /opt/idp/config/group-taxonomy.yaml
# Canonical group taxonomy (no secrets)

platform_groups:
  - "AI-PLATFORM-ADMINS"
  - "AI-SECURITY-AUDITORS"
  - "AI-OPS-READONLY"
  - "AI-AUTOMATION-OPERATORS"   # optional
  - "AI-SEARCH-ADMINS"          # optional, avoid unless required
  - "AI-NEXTCLOUD-ADMINS"       # optional

project_groups:
  prefix: "AI-NC-PROJ-"
  roles:
    - "VIEW"
    - "EDIT"
    - "OWNER"
  separator: "-"
```

Verify:

```bash
sudo sed -n '1,200p' /opt/idp/config/group-taxonomy.yaml
```

### 9.3 Create `/opt/idp/config/project-codes.yaml` (full contents)

6. Open: `sudo nano /opt/idp/config/project-codes.yaml`
7. Paste full contents and save.

```yaml
# /opt/idp/config/project-codes.yaml
# Registered project codes (extend per client)

projects:
  - code: "BANANA-PEEL"
    name: "Operation Banana Peel"
  - code: "NIGHT-PENGUIN"
    name: "Project Night Penguin"
  - code: "DAD-JOKE"
    name: "Operation Dad Joke"
  - code: "LASAGNA"
    name: "The Lasagna Protocol"
  - code: "MASTER"
    name: "Master Chuck Norris"
```

Verify:

```bash
sudo sed -n '1,200p' /opt/idp/config/project-codes.yaml
```

## 10. Verification checklist (mandatory)

- V1: Token contains groups claim named exactly `groups`.
- V2: `groups` contains only canonical group strings (no raw AD DNs unless explicitly approved).
- V3: Viewer user has only `-VIEW` groups and is denied upload/modify actions.
- V4: Editor user has `-EDIT` group and can upload/modify within project only.
- V5: Owner user has `-OWNER` group and can perform owner-only actions within project.
- V6: Cross-project access is denied and does not leak metadata (10.90 tests).
- V7: Nextcloud group mapping aligns with 21.35-21.37.
- V8: Search/mind-map visibility obeys ACL inheritance rules (30.55).

## 11. Client rollout variables (template)

| Variable | Value |
|---|---|
| groups claim name | `groups` |
| platform group names | `AI-PLATFORM-ADMINS, AI-SECURITY-AUDITORS, AI-OPS-READONLY` |
| project group pattern | `AI-NC-PROJ-<CODE>-VIEW/EDIT/OWNER` |
| project code rules | `uppercase + hyphen, stable` |
| emit unmapped AD groups | `false` |
| include email claim | `false unless required` |
| include display name claim | `true` |
| signing algorithm | `RS256` |
| token audience strategy | `<per app or global>` |
| new project onboarding | `update project-codes.yaml + create groups + Nextcloud folders + search connectors` |
| optional automation group | `AI-AUTOMATION-OPERATORS` |
| optional search admin group | `AI-SEARCH-ADMINS` |
| optional nextcloud admin group | `AI-NEXTCLOUD-ADMINS` |
| evidence repository | `<secure path>` |
| access review cadence | `quarterly group review` |
| change control | `<system>` |
| owner for taxonomy | `<name/team>` |
| app mapping matrix doc | `04.60` |
