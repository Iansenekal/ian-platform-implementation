# AI Platform Deployment Documentation

## 11.40 Identity Provider - Active Directory Integration (LDAPS)

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Step-by-step LDAPS integration with AD, certificate trust, least privilege bind account, group-to-claim mapping, and verification evidence.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/11-Backend-Identity-Provider/11.40-AD-Integration-LDAPS` |
| Filename | `docs/11-Backend-Identity-Provider/11.40-AD-Integration-LDAPS.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + Identity Engineering |
| Status | Mandatory for AD clients |
| Runs on | AI-DATA01 |
| Hard requirements | LDAPS only, least-privilege bind, audit, LAN-only |
| Security note | Do not store bind passwords in docs; use `/opt/idp/secrets` |
| Evidence requirement | cert validation + bind test + group resolution + token claim test |

## 1) Purpose and Outcomes

- Secure AD authentication via LDAPS.
- AD group resolution and mapped `groups` claim issuance.
- Least-privilege bind credentials with secure storage.
- Verified certificate trust and network boundaries.

## 2) LDAPS Threat Model Summary

- T1 LDAP interception -> enforce LDAPS 636, block 389.
- T2 MITM via bad cert validation -> trusted CA chain + fail-closed.
- T3 Over-privileged bind account -> dedicated read-only scoped account.
- T4 Group-claim abuse -> directory-derived claims only + signed token validation.
- T5 Excess data exposure -> scoped OU search + attribute minimization.

## 3) Prerequisites

### 3.1 AD-side

- DC has LDAPS cert with Server Authentication EKU.
- CN/SAN matches DC hostname used by client.
- LDAPS listening on TCP 636.
- Base DN and scoped Users/Groups OUs known.

### 3.2 Ubuntu-side (AI-DATA01)

- DNS resolves DC records using internal DNS.
- AI-DATA01 can reach DCs TCP/636.
- CA chain available for trust installation.
- `ldap-utils`, `openssl`, `ca-certificates` installed.

## 4) Architecture and Trust Boundaries

- AI-DATA01 IdP performs outbound-only LDAPS to DCs.
- No inbound LDAP/LDAPS to AI-DATA01.
- End-users authenticate via IdP path only.
- AD groups mapped to platform-standard `groups` claim values.

## 5) Bind Account Standard

- Dedicated account (example: `svc_idp_bind`).
- Not Domain Admin; read-only directory lookup scope.
- Deny interactive logon.
- Credential stored in `/opt/idp/secrets/ad_bind_password` with strict permissions.
- Rotate per policy (default 90 days).

## 6) Certificates and Trust

Preferred: trust AD CS root/intermediate CA in host trust store.
Fallback: trust DC cert directly (less durable on cert rotation).

## 7) Validate LDAPS from AI-DATA01

Install tools:

```bash
sudo apt update
sudo apt install -y ldap-utils openssl ca-certificates
```

DNS + network checks:

```bash
getent hosts dc01.<domain>
getent hosts stibiumdc02.<domain>
nc -vz <DC1_IP> 636
nc -vz <DC2_IP> 636
```

Certificate verification:

```bash
openssl s_client -connect <DC1_IP>:636 -servername dc01.<domain> -showcerts </dev/null | sed -n '1,220p'
```

PASS: certificate matches host and verify return code is `0 (ok)`.

## 8) Configure IdP Directory Integration

### 8.1 `/opt/idp` folders

```bash
sudo mkdir -p /opt/idp/{config,secrets,logs,backups,scripts}
sudo chmod 0750 /opt/idp
sudo chown -R root:root /opt/idp
```

### 8.2 Secrets files

- `/opt/idp/secrets/ad_bind_dn`
- `/opt/idp/secrets/ad_bind_password`
- owner `root:root`, mode `0600`

### 8.3 `ad-ldaps.yaml`

Use template artifact:
`infrastructure/keycloak/11.40-ad-ldaps.yaml.example`

### 8.4 `group-mapping.yaml`

Use template artifact:
`infrastructure/keycloak/11.40-group-mapping.yaml.example`

## 9) Group Claim Validation

- Authenticate with test AD user.
- Decode JWT payload locally.
- Confirm `groups` claim includes mapped platform and project groups.

PASS: expected mapped groups are present.

## 10) UFW and Network Allowlists

- Outbound `AI-DATA01 -> DCs:636` permitted (restrict to DC IPs when egress policy is strict).
- No inbound 636 opened on AI-DATA01.
- Inbound default deny on AI-DATA01 remains enforced.

## 11) Troubleshooting

- TLS verify failed: install CA chain and retry.
- Can't contact LDAP server: check route/firewall/UFW/DC listener.
- Invalid creds: verify bind DN/password/account status.
- No groups returned: check group membership, nested groups, scope/filter.
- Wrong emitted groups: fix mapping file to platform naming.

## 12) Verification Checklist

- V1: `openssl s_client` verify code `0` to at least one DC (prefer both).
- V2: `ldapsearch` bind over LDAPS returns user DN + group data.
- V3: IdP authenticates AD user and issues valid token.
- V4: token contains expected mapped `groups` claim.
- V5: downstream RBAC tests pass for mapped groups.
- V6: evidence captured and stored.

## 13) Client Rollout Variables

| Variable | Value |
|---|---|
| AD domain | `<lab.local>` |
| Base DN | `<DC=...>` |
| Users/Groups base DN | `<OU=...>` |
| DC1/DC2 hosts + IPs | `<values>` |
| LDAPS port | `636` |
| Bind DN file | `/opt/idp/secrets/ad_bind_dn` |
| Bind password file | `/opt/idp/secrets/ad_bind_password` |
| Groups claim | `groups` |
| Nested groups | `true/false` |
| User filter | `(&(objectClass=user)(sAMAccountName={username}))` |
| CA trust strategy | `Trust AD CS CA chain` preferred |
| UFW inbound | default deny; IdP upstream from frontend only |
| Outbound policy | allow 636 to DCs only (if enforced) |
| Rotation policy | bind credential cadence |
| Evidence repository | `<secure path>` |
