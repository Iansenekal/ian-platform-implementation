# AI Platform Deployment Documentation

## 11.50 Identity Provider - Local Users (No Directory Services)

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Local user and group lifecycle, MFA enforcement, RBAC mapping, break-glass controls, and audit-grade operational procedures.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/11-Backend-Identity-Provider/11.50-Local-Users-NoDirectory` |
| Filename (target) | `docs/11-Backend-Identity-Provider/11.50-Local-Users-No-Directory.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + Identity Operations |
| Status | Mandatory for clients without AD/Entra or other directory services |
| Runs on | AI-DATA01 (IdP), deployment default `10.10.5.187` |
| Hard requirements | Named users only, MFA policy, least privilege, audit logs, POPIA retention, break-glass defined |
| Related docs | 04.20 Auth Modes; 04.30 MFA policy; 04.40 RBAC groups; 04.70 Break-glass; 03.20 Secrets; 03.30 Audit; 03.40 Retention; 04.60 SSO matrix |
| Security note | No shared accounts; no passwords in docs; store secrets per 03.20; enforce lockout and password policy |
| Evidence requirement | User create/disable tests, MFA enrollment, role claims validation, and audit evidence |
| Change trigger | Re-run after policy changes, MFA changes, or app integration changes |
| Time zone | Africa/Johannesburg |
| Lab defaults | LAN `10.10.5.0/24`; legacy examples may show AI-DATA01 `10.10.5.178`, AI-FRONTEND01 `10.10.5.179` |

## Contents

- 1. Purpose and outcomes
- 2. Threat model summary (local users)
- 3. Local users operational model (who creates accounts, how approvals work)
- 4. Password policy baseline (POPIA-friendly)
- 5. MFA policy baseline (Tier 0-3)
- 6. Local groups and RBAC naming conventions (aligned to 04.40)
- 7. User lifecycle procedures (create, onboard, role change, suspend, terminate)
- 8. Break-glass accounts for no-directory environments
- 9. Step-by-step: Create and store local-user policy configuration (full replacement files)
- 9.1 Folder structure under `/opt/idp`
- 9.2 `/opt/idp/config/local-users-policy.yaml`
- 9.3 `/opt/idp/config/local-groups.yaml`
- 9.4 `/opt/idp/config/local-users-template.csv` (seed)
- 10. Step-by-step: Verification tests (claims, MFA, lockout)
- 11. Audit logging requirements (what must be logged)
- 12. Backup/restore considerations for local users
- 13. Verification checklist (mandatory)
- 14. Client rollout variables (template)

## 1. Purpose and outcomes

Some client environments do not have directory services (Active Directory, Entra ID, LDAP). In those environments, the IdP must manage local users and groups while still meeting the platform's security and POPIA requirements.

Outcomes:

- Secure local user authentication.
- Central MFA enforcement.
- Group claims emitted to apps for RBAC.
- Operational procedures for onboarding, offboarding, and role changes.
- Audit and retention aligned to POPIA.
- Break-glass controls for emergency recovery.

This is the local-user lifecycle standard for no-directory deployments.

## 2. Threat model summary (local users)

- T1: Password compromise due to weaker user hygiene -> strong password policy + MFA + lockout.
- T2: Shared accounts -> strictly prohibited; enforce named accounts + auditing.
- T3: Account sprawl/orphaned accounts -> lifecycle workflow with approvals and periodic monthly access review.
- T4: Privilege creep -> group-based RBAC with approvals; quarterly group review; least privilege defaults.
- T5: Admin takeover -> Tier 0 MFA, Zone E allowlist, break-glass stored offline, audit monitoring.
- T6: Data minimization failures -> store minimum user attributes; define retention; audit access to identity data.

## 3. Local users operational model (who creates accounts, how approvals work)

- Account creation authority: designated Identity Admins (Tier 0) only.
- Account requests require documented approval (manager + security owner).
- Role assignment occurs via group membership only (no ad-hoc per-app roles).
- Every change (create/disable/role change/MFA reset) must be logged and reviewed.

### 3.1 Periodic access review

- Monthly: review disabled and dormant accounts.
- Quarterly: review all group memberships and project roles.
- Annually: review password/MFA policy and retention alignment with POPIA.

## 4. Password policy baseline (POPIA-friendly)

- Minimum length: 14 characters (Tier 0/1: 16+).
- Complexity: passphrase style encouraged; avoid forced complexity that reduces usability.
- Reuse: prevent last 10 passwords (where supported).
- Lockout: 5 failed attempts -> 15 minute lockout (Tier 0: 3 attempts).
- Password rotation: only on compromise or policy requirement; enforce periodic review (e.g., 180 days) for high-privilege accounts.
- Credential storage: bcrypt/argon2 only (implementation responsibility of IdP).

## 5. MFA policy baseline (Tier 0-3)

- Tier 0 (IdP/Platform Admins): WebAuthn preferred + TOTP fallback; recovery codes required.
- Tier 1 (Auditors/Automation Operators): TOTP mandatory; recovery codes required.
- Tier 2 (Project Owners/Editors): TOTP recommended or mandated by client policy.
- Tier 3 (Standard users): optional or mandated by client policy.
- MFA reset requires Identity Admin approval and is logged as a high-severity audit event.

## 6. Local groups and RBAC naming conventions (aligned to 04.40)

- Platform groups: `AI-PLATFORM-ADMINS`, `AI-SECURITY-AUDITORS`, `AI-OPS-READONLY`.
- Project groups: `AI-NC-PROJ-<CODE>-VIEW` / `EDIT` / `OWNER`.
- Group names must exactly match what apps expect (04.60 and 10.50).
- Do not create per-app roles; create a group once and reuse across apps.

## 7. User lifecycle procedures (create, onboard, role change, suspend, terminate)

### 7.1 Create new user (summary)

- Collect minimal attributes: username, display name, email (if needed), manager, project assignments.
- Create user disabled by default (preferred) until MFA enrollment is completed.
- Assign groups (project + platform) based on approved request.
- Force first login to set password and enroll MFA.

### 7.2 Onboarding checklist (summary)

- User sets password (meets policy).
- User enrolls MFA (TOTP/WebAuthn) and stores recovery codes securely.
- Admin verifies group claim issuance with token decode.
- User completes first successful SSO into UI and Nextcloud (if used).

### 7.3 Role change procedure (summary)

- Document approval.
- Adjust group membership only (no manual per-app grants).
- Re-test claims and application access.
- Log and store evidence.

### 7.4 Suspension/termination (summary)

- Immediate disable in IdP (same-day).
- Remove from sensitive groups (Tier 0/1).
- Revoke sessions/tokens if IdP supports it.
- Retain audit events per retention policy; remove non-required personal attributes where allowed.

## 8. Break-glass accounts for no-directory environments

Local-user environments rely heavily on IdP availability. Break-glass procedures must exist and be tested.

- Maintain 2 break-glass admin accounts (Tier 0) stored offline in a sealed envelope or secure vault.
- Break-glass accounts are excluded from normal use; use only for recovery.
- Break-glass usage requires incident ticket and post-incident review.
- Rotate break-glass passwords every 6-12 months or after any use.

## 9. Step-by-step: Create and store local-user policy configuration (full replacement files)

These policy files are platform-standard templates stored under `/opt/idp/config`. They do not contain passwords. They define how local user mode must behave.

Step 9.1 - Ensure folder structure under `/opt/idp`  
Terminal/app: SSH to AI-DATA01.

```bash
sudo mkdir -p /opt/idp/{config,secrets,logs,backups,scripts}
sudo chown -R root:root /opt/idp
sudo chmod 0750 /opt/idp
sudo ls -la /opt/idp
```

Step 9.2 - Create `/opt/idp/config/local-users-policy.yaml` (full contents)  
Terminal/app: SSH to AI-DATA01. Editor: `nano`.

1. Open: `sudo nano /opt/idp/config/local-users-policy.yaml`
2. Delete any existing content.
3. Paste the full contents below.
4. Save and exit.

```yaml
# /opt/idp/config/local-users-policy.yaml
# Local user mode policy (no secrets)

mode: "local_users"

password_policy:
  min_length: 14
  require_passphrase: true
  prevent_reuse_last: 10
  lockout:
    enabled: true
    max_failed_attempts: 5
    lockout_minutes: 15

mfa_policy:
  enabled: true
  methods:
    - "webauthn"     # preferred for Tier 0
    - "totp"         # baseline for all tiers
  recovery_codes:
    enabled: true
    min_codes: 10
  reset_requires_approval: true

session_policy:
  access_token_minutes: 20
  refresh_tokens_enabled: true
  refresh_rotation: true
  max_session_hours: 12

account_lifecycle:
  create_disabled_until_mfa_enrolled: true
  require_manager_approval: true
  require_security_owner_approval_for_tier0: true
  disable_on_termination: true
  dormant_account_days: 45
  dormant_action: "disable"   # disable | notify | none

audit_policy:
  log_user_create: true
  log_user_disable: true
  log_password_reset: true
  log_mfa_enroll: true
  log_mfa_reset: true
  log_group_changes: true
  log_login_success: true
  log_login_failure: true
  severity_on_mfa_reset: "high"
```

Verification:

```bash
sudo sed -n '1,220p' /opt/idp/config/local-users-policy.yaml
```

Step 9.3 - Create `/opt/idp/config/local-groups.yaml` (full contents)  
Defines the canonical group catalog for local-user mode. Apps consume these names via token `groups` claim.

5. Open: `sudo nano /opt/idp/config/local-groups.yaml`
6. Paste the full contents below.
7. Save and exit.

```yaml
# /opt/idp/config/local-groups.yaml
# Canonical group catalog for local-user mode

token_groups_claim: "groups"

platform_groups:
  - "AI-PLATFORM-ADMINS"
  - "AI-SECURITY-AUDITORS"
  - "AI-OPS-READONLY"

project_role_groups_pattern:
  prefix: "AI-NC-PROJ-"
  roles: ["VIEW", "EDIT", "OWNER"]

# Seed project codes (extend per client)
projects:
  - "BANANA-PEEL"
  - "NIGHT-PENGUIN"
  - "DAD-JOKE"
  - "LASAGNA"
  - "MASTER"
```

Verification:

```bash
sudo sed -n '1,200p' /opt/idp/config/local-groups.yaml
```

Step 9.4 - Create `/opt/idp/config/local-users-template.csv` (seed)  
Use a CSV template to capture approved user onboarding requests. Do not store passwords in this file.

This file is an operational template; access restricted to Identity Admins.

8. Open: `sudo nano /opt/idp/config/local-users-template.csv`
9. Paste the full contents below.
10. Save and exit.

```csv
username,display_name,email,manager,platform_groups,project_assignments,notes
jane.doe,Jane Doe,jane.doe@client.local,manager.name,AI-OPS-READONLY,"BANANA-PEEL:VIEW;MASTER:EDIT","Example user - approved"
```

Set permissions:

```bash
sudo chown root:root /opt/idp/config/local-users-template.csv
sudo chmod 0640 /opt/idp/config/local-users-template.csv
sudo ls -la /opt/idp/config/local-users-template.csv
```

## 10. Step-by-step: Verification tests (claims, MFA, lockout)

### 10.1 Create two test users

- `TestUser-Viewer`: member of `AI-NC-PROJ-<CODE>-VIEW`
- `TestUser-Admin`: member of `AI-PLATFORM-ADMINS`

### 10.2 MFA enrollment test

- Login as each user and enroll MFA (TOTP).
- Export or record recovery codes securely.
- Confirm MFA required on next login.

### 10.3 Token claim test

Acquire an access token and decode the JWT locally (no external calls):

```bash
export TOKEN='<PASTE_ACCESS_TOKEN>'
python3 - << 'PY'
import base64, json, os
parts = os.environ["TOKEN"].split(".")
pad = "=" * (-len(parts[1]) % 4)
print(json.dumps(json.loads(base64.urlsafe_b64decode(parts[1] + pad)), indent=2))
PY
```

- PASS: `groups` claim includes assigned platform and project groups.

### 10.4 Lockout test

- Attempt 5 failed logins to trigger lockout.
- Confirm account is locked for 15 minutes (or configured).
- Confirm event is logged in audit log.

## 11. Audit logging requirements (what must be logged)

- User creation, disablement, deletion (if allowed), and re-enable.
- Group membership changes (who, what, when).
- MFA enrollment, MFA reset, recovery code regeneration.
- Login success and failure events (include source IP).
- Admin console actions (Tier 0).
- Exports or admin reads of user lists (if any).

POPIA note: do not log passwords, MFA secrets, or full personal data fields beyond what's required.

## 12. Backup/restore considerations for local users

- Local user mode increases IdP state importance: the IdP database must be backed up and restore-tested.
- Backup scope: IdP database + `/opt/idp/config` + `/opt/idp/secrets` + CA trust files if applicable.
- Restore tests must verify: users exist, MFA requirements still enforced, and tokens issue correctly.

## 13. Verification checklist (mandatory)

- V1: Local users can login and are forced to enroll MFA (policy).
- V2: Tier 0 accounts require MFA and are restricted to Zone E admin paths.
- V3: Token includes correct `groups` claim; apps enforce RBAC correctly.
- V4: Lockout triggers after configured failed attempts; audit event recorded.
- V5: MFA reset requires approval and is logged.
- V6: Backup contains IdP DB and config/secrets; restore test plan documented.

## 14. Client rollout variables (template)

| Variable | Value |
|---|---|
| Identity mode | `Local Users` (no directory) |
| Password min length | `14` (Tier0/1: 16+) |
| Lockout attempts/minutes | `5 attempts / 15 minutes` |
| MFA methods | `TOTP baseline; WebAuthn preferred for Tier 0` |
| Recovery codes | `10 codes minimum` |
| Access token minutes | `20` |
| Refresh tokens | `enabled with rotation` |
| Dormant account days/action | `45 / disable` |
| Approval workflow | `manager + security owner (Tier0 requires security owner)` |
| Admin allowlist (Zone E) | `<CIDR/IP list>` |
| Token groups claim | `groups` |
| Platform groups | `AI-PLATFORM-ADMINS, AI-SECURITY-AUDITORS, AI-OPS-READONLY` |
| Project group pattern | `AI-NC-PROJ-<CODE>-VIEW/EDIT/OWNER` |
| Break-glass accounts | `2 offline, rotate 6-12 months` |
| Audit retention | `per 03.40` |
| Evidence repository | `<secure path>` |
| Backup schedule | `per 06.10` |
| Restore test cadence | `quarterly recommended` |
| User attributes stored | `minimal (username, display_name, optional email)` |
| User template file | `/opt/idp/config/local-users-template.csv` |
| Change control | `<system>` |
| Operator contacts | `<names>` |
