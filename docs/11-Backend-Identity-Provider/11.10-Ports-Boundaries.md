# AI Platform Deployment Documentation

## 11.10 Identity Provider - Ports and Trust Boundaries

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Authoritative port map, UFW allowlists, zone boundaries, and who-can-talk-to-what for the IdP.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/11-Backend-Identity-Provider/11.10-Ports-Boundaries` |
| Filename | `docs/11-Backend-Identity-Provider/11.10-Ports-Boundaries.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + DevOps |
| Status | Mandatory |
| Runs on | AI-DATA01 (IdP), published via AI-FRONTEND01 reverse proxy |
| Hard requirement | IdP is never publicly exposed |
| Evidence requirement | UFW rules + `ss` output + negative tests |
| Change trigger | Re-run after any IdP port/proxy change |
| Time zone | Africa/Johannesburg |
| Lab defaults | AI-DATA01 `10.10.5.178`, AI-FRONTEND01 `10.10.5.179`, LAN `10.10.5.0/24` |

## 1) Trust Boundary Summary

- End-users never access AI-DATA01 IdP ports directly.
- End-users access `AI-FRONTEND01:443` only.
- AI-FRONTEND01 reverse proxy is the normal IdP access path.
- Zone E admins may access admin routes only via strict allowlist.
- AI-DATA01 outbound is restricted to internal dependencies.

## 2) Authoritative IdP Ports List

Default internal upstream port is `8080` (or `8443` when internal TLS upstream is used).

| Port | Proto | Bind | LAN-exposed | Allowed source(s) | Purpose |
|---|---|---|---|---|---|
| 443 | TCP | AI-FRONTEND01 | Yes | LAN clients | IdP LAN HTTPS hostname |
| 8080 | TCP | AI-DATA01 | No | AI-FRONTEND01 only | IdP upstream |
| 8443 | TCP | AI-DATA01 | No | AI-FRONTEND01 only | Optional IdP HTTPS upstream |
| 636 | TCP | AI-DATA01 outbound | N/A | AI-DATA01 -> DC IPs | LDAPS (AD mode) |
| 53 | UDP/TCP | AI-DATA01 outbound | N/A | AI-DATA01 -> DNS | DNS resolution |
| 123 | UDP | AI-DATA01 outbound | N/A | AI-DATA01 -> NTP | Time sync |
| 22 | TCP | AI-DATA01 | Admin only | Zone E allowlist | SSH admin |

## 3) Who Talks to the IdP

### 3.1 Normal user traffic

- Zone B/C users -> AI-FRONTEND01:443 only.
- AI-FRONTEND01 -> AI-DATA01:`<IdP_INTERNAL_PORT>` only.
- Direct LAN user access to AI-DATA01 IdP ports is denied.

### 3.2 Admin traffic (Zone E)

- Zone E -> AI-FRONTEND01:443 for admin console (preferred).
- Tier 0 MFA required for admin access.
- Full admin access audit required.

### 3.3 AD mode directory traffic

- AI-DATA01 -> DCs:636 only.
- No inbound LDAP/LDAPS to AI-DATA01.

## 4) UFW Policy Model for AI-DATA01

- Default deny inbound, allow outbound.
- Allow AI-FRONTEND01 (`10.10.5.179`) to `<IdP_INTERNAL_PORT>/tcp`.
- Allow SSH (`22/tcp`) only from Zone E allowlist.
- Optional monitoring ports allowed only from monitoring host.

Verification commands:

```bash
sudo ufw status verbose
sudo ufw show raw | sed -n '1,220p'
```

## 5) Reverse Proxy Boundary (AI-FRONTEND01)

- Terminate HTTPS with internal CA.
- Apply admin path allowlists.
- Forward only required IdP paths upstream.
- Apply login endpoint rate limiting.
- Publish only `id.<domain>` on AI-FRONTEND01:443.

## 6) Admin Boundary (Zone E)

- Zone E allowlist + Tier 0 MFA + audit logging required.
- Break-glass handled per 04.70.
- If admin endpoints share hostname, enforce path-level allowlist.

## 7) Verification Checklist

### 7.1 Listening ports (AI-DATA01)

```bash
sudo ss -tulpn
```

PASS: IdP internal port bound to expected interface and not broadly exposed.

### 7.2 Negative tests (normal workstation)

```powershell
Test-NetConnection 10.10.5.178 -Port <IdP_INTERNAL_PORT>
```

PASS: blocked/fails.

### 7.3 Positive test via proxy hostname

```bash
curl -k https://id.<domain>/.well-known/openid-configuration | head -n 30
```

PASS: succeeds via AI-FRONTEND01:443.

## 8) Client Rollout Variables

| Variable | Value |
|---|---|
| IdP internal port | `8080` (example) |
| IdP hostname | `id.<domain>` |
| Proxy hostname | `id.<domain>` on AI-FRONTEND01:443 |
| AI-DATA01 IP | `10.10.5.178` |
| AI-FRONTEND01 IP | `10.10.5.179` |
| Zone E allowlist | `<CIDR/IP list>` |
| SSH allowlist | `Zone E only` |
| AD mode | `Yes/No` |
| DC IPs (LDAPS) | `<IPs>` |
| LDAPS port | `636` |
| DNS | `10.10.5.160` |
| NTP sources | `<internal>` |
| Admin console exposure | `proxy-only` preferred |
| Rate limiting | enabled at proxy |
| Internal CA | `platform-root-ca.crt` |
| Audit logging | enabled |
| Retention | per `03.40` |
| Evidence repository | `<secure path>` |
