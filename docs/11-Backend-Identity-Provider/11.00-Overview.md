# AI Platform Deployment Documentation

## 11.00 Identity Provider - Overview

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
IdP scope, design choices, trust boundaries, MFA tiers, AD vs Local Users support, and install sequencing.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/11-Backend-Identity-Provider/11.00-Overview` |
| Filename | `docs/11-Backend-Identity-Provider/11.00-Overview.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + Platform Engineering |
| Status | Mandatory |
| Runs on | AI-DATA01 (recommended) |
| Primary purpose | Local Identity + MFA + Group Claims (OIDC-first; SAML optional) |
| Hard requirements | LAN-only runtime, internal TLS, least privilege, audit logging, POPIA retention |
| Supported identity sources | Active Directory via LDAPS or Local Users |
| Install order position | After 01-04 design docs; before 10/20/21 app deployments |
| Evidence requirement | All 11.* verification checklists completed with evidence |

## 1) Purpose and Outcomes

The IdP is the platform authentication and claims authority for UI, gateway, Nextcloud, monitoring, and optional automation.

Outcomes:

- Single sign-on across platform apps.
- Central MFA enforcement with recovery controls.
- Group claims for RBAC.
- AD-integrated mode or local-user mode.
- Audit-grade events and POPIA-aligned retention.

## 2) Scope

The IdP is responsible for:

- User authentication and session lifecycle.
- MFA enforcement and recovery controls.
- OIDC token issuance/signing.
- Discovery metadata and JWKS publication.
- Group/role claim issuance.
- Directory integration (LDAPS) or local user lifecycle.
- Admin allowlisting and admin audit logging.

## 3) Non-Scope

The IdP is not responsible for:

- App-specific authorization logic.
- Nextcloud file permission internals.
- UFW policy on other hosts.
- Search/indexing logic.
- Workstation/device endpoint management.

## 4) Design Decisions

- OIDC-first for all supported apps.
- SAML optional only when required.
- Internal TLS mandatory for IdP endpoints.
- Gateway token validation must be offline-capable via JWKS.
- Keycloak-ready compatibility for future migration/coexistence.

### 4.1 Token policy baseline

- Access token lifetime: short (10-30 minutes baseline).
- Refresh tokens: optional with strict rotation/revocation.
- Algorithms: asymmetric only (`RS256`), no `HS*`, no `none`.
- Required claims: `sub`, `iss`, `exp`, `iat`, plus `groups` for RBAC.

## 5) Architecture Placement and Trust Boundaries

Recommended placement: IdP on AI-DATA01 with strict internal access controls.

- UI ingress on AI-FRONTEND01 forwards restricted IdP traffic to AI-DATA01.
- Only AI-FRONTEND01 and Zone E admin allowlist may reach IdP endpoints.
- Gateway validates tokens via IdP discovery/JWKS over internal TLS.

### 5.1 Administrative boundary (Zone E)

- Admin console restricted to Zone E (or dedicated admin subnet).
- IdP admin accounts require Tier 0 MFA.
- Break-glass is controlled by documented process.

## 6) Identity Sources (AD vs Local Users)

- Mode A (preferred): AD-integrated via LDAPS, group claims mapped from AD.
- Mode B: Local users and groups managed directly in IdP with strict lifecycle controls.

Both modes require same MFA and audit controls.

## 7) MFA Policy Tiers (Summary)

- Tier 0 (platform/IdP admins): mandatory MFA, WebAuthn preferred + TOTP fallback.
- Tier 1 (security/audit/automation operators): mandatory MFA.
- Tier 2 (project owners/editors): recommended or policy-mandated.
- Tier 3 (standard users/read-only): optional or policy-mandated.

## 8) Group-to-Role Mapping Standard

- Single `groups` claim in token.
- Platform groups: `AI-PLATFORM-ADMINS`, `AI-SECURITY-AUDITORS`, `AI-OPS-READONLY`.
- Project groups: `AI-NC-PROJ-<CODE>-VIEW|EDIT|OWNER`.

## 9) Operational Controls

- Backup: IdP config/db/secrets included per 06.*.
- Monitoring: liveness/readiness + auth error trends.
- Audit: auth/admin/MFA events retained per 03.30/03.40/50.30.
- Break-glass: documented and tested.
- Change control: app registration changes update SSO matrix and evidence.

## 10) Install Sequencing

1. Architecture and trust-zone docs (01.* and 02.*)
2. Security baselines (03.*)
3. Identity design docs (04.*)
4. Deploy IdP (11.*)
5. Deploy gateway (10.*) and validate token/RBAC flow
6. Deploy UI ingress (20.*) and validate SSO
7. Deploy Nextcloud (21.*) and validate SSO + permissions
8. Deploy Search/Graph (30.*) and validate ACL inheritance
9. Deploy optional automation (40/41) with SSO/least-privilege
10. Complete monitoring/logging and backup/DR validation (50.*, 06.*)

## 11) Client Rollout Variables

| Variable | Value |
|---|---|
| Internal domain | `<client.local>` |
| IdP hostname | `id.<domain>` |
| IdP LAN URL | `https://id.<domain>` |
| Placement VM | `AI-DATA01` |
| Identity mode | `AD-integrated` or `Local Users` |
| AD domain / LDAPS endpoint | `<values if AD>` |
| MFA baseline | `Tier0/1 mandatory; Tier2/3 per policy` |
| Allowed token algorithms | `RS256` |
| Token lifetime | `10-30 minutes` |
| Groups claim | `groups` |
| Username claim | `preferred_username` or `upn` |
| Zone E admin allowlist | `<CIDR/IP list>` |
| Internal CA root cert | `platform-root-ca.crt` |
| Audit retention | `per 03.40/50.30` |
| Backup scope | `config + db + secrets per 06.*` |
| Break-glass accounts | `per 04.70` |
| Evidence repository | `<secure path>` |
