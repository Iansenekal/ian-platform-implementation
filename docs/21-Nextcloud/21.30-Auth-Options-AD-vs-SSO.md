# AI Platform Deployment Documentation
## 21.30 Nextcloud - Authentication Options (AD vs SSO vs Local Users)

LAN-only - POPIA-friendly - Two-VM on Proxmox - Ubuntu 24.04

Document Control
- Document ID: `docs/21-Nextcloud/21.30-Auth-Options-AD-vs-SSO`
- Filename: `docs/21-Nextcloud/21.30-Auth-Options-AD-vs-SSO.md`
- Version: `v1.0`
- Date: `2026-02-09`
- Owner: Choice IT / Security Architecture + Identity
- Status: Mandatory - one auth mode must be selected per client
- Scope: Authentication and identity mapping only (`21.35` to `21.37` own authorization model)
- Hard requirements: LAN-only; MFA policy; least privilege; audit events; no cloud runtime dependency
- Related docs: `04.*`, `11.*`, `21.10`, `21.35`, `21.45`, `03.20`
- Decision outcome: choose a primary mode and fallback break-glass approach
- Evidence requirement: login tests per mode + group mapping proof + MFA proof
- Time zone: `Africa/Johannesburg`
- Lab defaults: `dns01.lab.local (10.10.5.160)`, `nc.lab.local`, `id.lab.local`
- Note: SSO is platform default; AD direct is supported where required

## 1. Executive Decision Summary
Default choice: SSO via platform IdP with MFA enforced at IdP.

Why:
- centralized policy for MFA/lockout/session controls
- consistent cross-app login posture
- simpler audit and lifecycle governance

Supported alternatives:
- AD/LDAPS direct integration when SSO is not feasible
- Local users only where no directory service exists

## 2. Option Comparison
SSO via IdP:
- best for most clients
- strongest consistency for MFA and lifecycle controls
- medium operational complexity

AD direct LDAPS:
- best for AD-centric clients without IdP preference
- requires explicit MFA strategy at Nextcloud/upstream
- medium-high complexity with app-specific policy drift risk

Local users:
- only for no-directory environments
- highest governance burden and operational risk
- requires strict approval, MFA, lockout, and review controls

## 3. Recommended Default: SSO via Platform IdP
- Nextcloud delegates login through OIDC/SAML to IdP
- IdP enforces MFA tiers and account policy
- Nextcloud consumes stable identity/group claims
- avoids separate credential store in Nextcloud

SSO prerequisites:
- DNS resolution for `id.<domain>` and `nc.<domain>`
- internal TLS trust installed (`20.20`)
- canonical group claim mapping aligned to `11.70`
- Nextcloud SSO module configured for group mapping

OIDC is preferred; SAML is acceptable where organizational standard requires it.

## 4. AD/LDAPS Direct Integration
Use when:
- client mandates direct AD binding
- no IdP rollout is planned in near term

Rules:
- LDAPS only (`636`)
- trusted internal CA chain required
- service account must be least-privileged and secrets-managed

Limitations:
- MFA is not automatically centralized
- policy consistency across apps is weaker than SSO mode

## 5. Local Users Governance Model
Local users are valid only when directory services are unavailable.

Mandatory controls:
- approval-based provisioning workflow
- mandatory MFA enrollment before full access
- strong passphrase and lockout policy
- scheduled access review and stale-account cleanup
- external sharing disabled by default

## 6. MFA Application for Nextcloud
- SSO mode: MFA enforced by IdP (preferred)
- AD direct mode: MFA must still be enforced (Nextcloud or approved upstream control)
- Local users mode: MFA mandatory with recovery controls and break-glass process

## 7. Group Mapping and Naming
- Canonical taxonomy from `11.70` and Nextcloud ACL model from `21.36`
- project scopes: `AI-NC-PROJ-<CODE>-VIEW/EDIT/OWNER`
- no broad permissive root groups such as `Everyone`
- Search/KG service accounts are non-interactive and least-privileged

## 8. Break-Glass and Recovery
- Maintain emergency local admin account with strong controls
- offline recovery material with dual approval
- usage must be audited and time-bound
- restore normal auth mode immediately after recovery

## 9. Verification Checklist
SSO mode:
- login redirect/return succeeds
- Tier 0/1 MFA enforced
- group mapping yields expected visibility and edit boundaries

AD direct mode:
- LDAPS bind succeeds
- user/group resolution succeeds
- MFA enforcement evidence exists

Local users mode:
- forced MFA enrollment at onboarding
- lockout/password policy demonstrated
- access-review schedule defined and evidenced

## 10. Client Rollout Variables
- selected auth mode: `SSO` / `AD_LDAPS` / `LOCAL_USERS`
- SSO protocol: `OIDC` preferred or `SAML`
- IdP hostname: `id.<domain>`
- Nextcloud hostname: `nc.<domain>`
- AD domain/DCs and LDAPS endpoint if AD mode
- group claim source and naming convention
- admin/audit groups
- MFA and recovery-code policy
- session/idle timeouts
- break-glass account + custody model
- external sharing default and exception workflow
- access review cadence and evidence path
