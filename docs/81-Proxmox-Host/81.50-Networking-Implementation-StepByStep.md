# 81.50 Proxmox Host Networking Implementation (Step-by-Step)

Document ID: `docs/81-Proxmox-Host/81.50-Networking-Implementation-StepByStep`  
Version: `v1.0`  
Date: `2026-02-10`  
Owner: `Infrastructure / Platform Ops`

## Purpose
Implement the approved Proxmox networking design (vmbr0 baseline and optional VLANs) with deterministic steps, full file-path guidance, and verification gates.

## Scope
Proxmox host networking only. VM-level UFW policies are handled in VM deployment runbooks.

## Prerequisites
- `81.20` install complete.
- `81.30` hardening complete.
- `81.40` networking design approved.

## Where To Perform Steps
- Proxmox Web UI: `https://<pve-ip>:8006` from LAN admin workstation.
- Proxmox shell: Web UI Shell or SSH from allowlisted admin workstation.
- File edits: `/etc/network/interfaces` on Proxmox host shell.

## Inputs (Fill Before Start)
| Item | Value |
|---|---|
| Proxmox host name | `pve01.lab.local` (example) |
| Management IP/CIDR | `10.10.5.xxx/24` |
| Gateway | `10.10.5.1` |
| DNS | `10.10.5.160` |
| Primary NIC | `eno1` (example) |
| Bridge name | `vmbr0` |
| VLAN IDs (optional) | `none` or explicit list |

## Baseline Implementation (vmbr0, no VLANs)

### 1) Pre-check current networking
Run on Proxmox host shell:

```bash
ip -br link
ip -br addr
cat /etc/network/interfaces
```

### 2) UI steps to confirm or create vmbr0
1. `Datacenter -> <node> -> System -> Network`
2. Confirm `vmbr0` exists and is `Linux Bridge`.
3. Confirm `vmbr0` has management IP/CIDR.
4. Confirm `Bridge ports` includes physical NIC (example `eno1`).
5. If missing/incorrect: `Create -> Linux Bridge`.
6. Set:
   - Name: `vmbr0`
   - Bridge ports: `<physical NIC>`
   - IPv4/CIDR: `<management IP/CIDR>`
   - Gateway (IPv4): `<gateway>`
   - Autostart: enabled
7. Click `Create`.
8. Click `Apply Configuration`.

Important:
- Keep physical console access available in case connectivity is lost.

### 3) Shell verification (baseline)

```bash
ip -br addr | grep -E "vmbr0"
bridge link
ip r | head
ping -c 2 10.10.5.1
ping -c 2 10.10.5.160
ss -tulpen | grep -E ":8006\\b" || true
```

Pass criteria:
- `vmbr0` has expected management IP.
- Physical NIC is enslaved to bridge.
- Default route points to gateway.
- Gateway and DNS reachable.
- Proxmox UI listener present on 8006.

## Optional VLAN Patterns (Only if approved in 81.40)

### Pattern A: One bridge per VLAN (access)
- Explicit bridge mapping per VLAN.
- Usually requires separate NICs/links.

### Pattern B: Trunk + VLAN tags per VM (recommended)
- Keep `vmbr0` as trunk/vlan-aware bridge.
- Apply VLAN tags per VM NIC in Proxmox.

UI example for VM NIC tag:
1. `Datacenter -> <node> -> <VM> -> Hardware`
2. Edit `Network Device (net0)`
3. Set `VLAN Tag` (example `20`)
4. Save and verify VM addressing/routing.

## VM Connectivity Validation
Run minimal checks inside at least one VM:

```bash
ip a
ip r | head
ping -c 2 10.10.5.1
ping -c 2 10.10.5.160
getent hosts dns01.lab.local || true
```

## Recovery Path (If UI apply fails)
1. Use host physical console.
2. Login as root.
3. Inspect `/etc/network/interfaces`.
4. Revert to last-known-good config.
5. Restart networking or reboot.
6. Confirm host reachability before reattempt.

## Repo Implementation Helpers
- Input template: `infrastructure/proxmox/networking/81.50-network-inputs.env.example`
- Render interfaces file: `infrastructure/proxmox/networking/render-interfaces.sh`
- Host verification: `infrastructure/proxmox/networking/81.50-network-verify.sh`
- Config examples:
  - `infrastructure/proxmox/networking/interfaces.vmbr0-baseline.example`
  - `infrastructure/proxmox/networking/interfaces.vlan-trunk.example`

## Mandatory Evidence
- Screenshot of `System -> Network` showing `vmbr0` (and VLAN settings if used).
- Saved copy of `/etc/network/interfaces`.
- Saved output of verification commands.

## Verification Checklist
- `vmbr0` exists, active, and bound to correct NIC.
- Management IP reachable from admin workstation.
- Gateway and DNS reachable from Proxmox host.
- VLAN tags (if used) match approved design and switchport mode.
- At least one VM proven to have LAN connectivity.
- Evidence captured and stored.

## Client Rollout Variables
| Variable | Client value |
|---|---|
| Physical NIC used for vmbr0 | `<fill>` |
| vmbr0 management IP/CIDR | `<fill>` |
| Gateway | `<fill>` |
| DNS server(s) | `<fill>` |
| VLAN IDs used (if any) | `<fill>` |
| Switchport mode (access/trunk) | `<fill>` |
| Bridge mapping (vmbr0/vmbr1) | `<fill>` |
| Test VM for connectivity proof | `<fill>` |
