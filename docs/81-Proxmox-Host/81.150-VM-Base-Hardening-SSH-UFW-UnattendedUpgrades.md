# 81.150 VM Base Hardening (SSH, UFW, Unattended Upgrades)

Document ID: `docs/81-Proxmox-Host/81.150-VM-Base-Hardening-SSH-UFW-UnattendedUpgrades`  
Version: `v1.0`  
Date: `2026-02-10`  
Owner: `Security / Platform Ops`

## Purpose
Apply a consistent Ubuntu VM hardening baseline for `AI-DATA01`, `AI-FRONTEND01`, and optional `DNS01`, aligned to `02.20` and `03.*` controls.

## Scope
Base hardening only. Service-specific firewall rules are handled in service deployment runbooks.

## Prerequisites
- Ubuntu 24.04 minimal install complete.
- SSH access verified.

## Rollout Variables
- SSH admin subnet allowlist (lab default `10.10.5.0/24`).
- Admin SSH username.
- SSH port policy (default `22`).
- PasswordAuthentication policy (recommended `no`).
- UFW defaults (`deny incoming`, `allow outgoing`).
- Timezone (`Africa/Johannesburg`).

## Hardening Coverage
- SSH hardening:
- root login disabled
- key-based auth required
- password auth disabled (unless controlled exception)
- reduced forwarding/tunneling surface
- UFW baseline:
- reset rules
- default deny incoming / allow outgoing
- explicit SSH allowlist from admin subnet(s)
- fail2ban baseline:
- `sshd` jail with retry/time/bantime controls
- Unattended security upgrades:
- security origin only
- periodic update/download/upgrade enabled
- auto-reboot disabled by baseline policy

## Repo Implementation
- Apply script:
- `infrastructure/vm-provisioning/hardening/base-hardening.sh`
- Inputs template:
- `infrastructure/vm-provisioning/hardening/81.150-hardening-inputs.env.example`
- Verification script:
- `infrastructure/vm-provisioning/hardening/verify-hardening.sh`
- Baseline file templates:
- `infrastructure/vm-provisioning/hardening/sshd_config.baseline`
- `infrastructure/vm-provisioning/hardening/sshd.local.baseline`
- `infrastructure/vm-provisioning/hardening/50unattended-upgrades.baseline`
- `infrastructure/vm-provisioning/hardening/20auto-upgrades.baseline`

## Execution Pattern (Per VM)
1. Copy env file and set VM-specific values.
2. Run hardening apply script as root (or via `sudo`).
3. Keep current SSH session open and test new SSH session before closing.
4. Run hardening verification script and archive outputs.

## Mandatory Verification
- `PasswordAuthentication no`, `PermitRootLogin no`.
- UFW enabled, default deny incoming, SSH allowlist present.
- `fail2ban` active with `sshd` jail enabled.
- unattended-upgrades dry-run works.
- listening ports reviewed and expected.

## Evidence
- `sshd -T | egrep 'passwordauthentication|permitrootlogin|port'`
- `ufw status verbose` and `ufw show added`
- `fail2ban-client status sshd`
- first lines of `unattended-upgrade --dry-run --debug`
- `ss -tulpen`
