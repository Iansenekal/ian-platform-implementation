# AI Platform Deployment Documentation
## 70.40 Document Workflow + eSign - Document Versioning and Hashing

LAN-only - POPIA-friendly - Version-safe approvals - Hash-bound evidence

Document Control
- Document ID: `docs/70-Document-Workflow-eSign/70.40-Document-Versioning-and-Hashing`
- Filename: `docs/70-Document-Workflow-eSign/70.40-Document-Versioning-and-Hashing.md`
- Version: `v1.0`
- Date: `2026-02-10`
- Owner: Platform Engineering + Compliance
- Status: Workflow Standard
- Hard requirements: approval binds to specific version and hash; no unsafe approval carry-over; server-side hashing; tamper-evident evidence
- Related docs: `70.30`, `70.11`, `21.*`, `03.30`

## 1. Purpose
- prevent approval-to-wrong-version ambiguity
- define deterministic server-side hashing and recording
- enforce explicit workflow version-binding and safe rework behavior

## 2. Definitions
- `document_id`: stable artifact identifier across revisions
- `document_version`: discrete revision with unique hash
- `document_hash`: SHA-256 over exact stored file bytes
- `workflow_instance`: approval run for one specific version
- `finalized_version`: latest approved authoritative revision

## 3. Versioning Rules
### 3.1 New version required
- content byte changes
- material metadata changes (title/classification/scope/effective date)
- policy/routing changes that alter required approvals
- any rework after reject

### 3.2 New version not required
- non-material filename correction with identical bytes (must still be recorded)
- workflow-state folder movement without content changes

Safe default: when uncertain, create a new version and re-approve.

## 4. Version Naming Convention
- recommended semantic versioning (`v1.0`, `v1.1`, `v2.0`) with changelog
- optional date-based versioning where needed
- each version includes author and change summary metadata

## 5. Hashing Standard
### 5.1 Algorithm
- SHA-256 is mandatory
- hash computed server-side

### 5.2 Hash input
- exact Nextcloud-stored file bytes at approval time
- if PDF is generated for signing, hash and receipt must represent authoritative artifact per policy

### 5.3 Hash recording
- record hash in signature receipt, structured audit event, and evidence summary
- avoid leaking document identifiers into generic logs

## 6. Workflow Binding to Version
- workflow instance binds to one version and hash
- each approval records hash reference at decision time
- detected byte changes during active workflow invalidate instance and require resubmission

## 7. Rework and Approval Carry-Over
- default: no approval carry-over across versions for compliance flows
- optional low-risk carry-over only for formatting-only changes with explicit policy and evidence
- reject invalidates active version chain and triggers new workflow instance

## 8. Multiple Formats Handling
- define authoritative format per document type (often finalized PDF)
- DOCX and PDF treated as distinct artifacts unless deterministic derivation policy applies
- rescanned docs are new versions with scan metadata

## 9. Evidence-Pack Structure
- receipts organized by `document_id` and `document_version`
- per-version summary lists hash, approvals, timestamps, and receipt references
- Evidence-Pack entries are sealed read-only after version completion

## 10. Verification Procedure
1. Identify target `document_id` and `document_version`.
2. Compute SHA-256 over Final bytes.
3. Locate matching receipt in Evidence-Pack.
4. Compare hash and verify receipt signature/chain mapping.
5. Check audit for mid-workflow modifications; treat mismatch as incident.

## 11. Failure Modes and Safe Defaults
- missing version metadata: block submission
- hash computation failure: block approval and alert
- file change during workflow: invalidate instance and require resubmission
- hash/receipt mismatch: quarantine as tamper incident

## 12. Verification Checklist
1. Submit `v1.0`, approve step, confirm hash captured.
2. Modify bytes during active step; confirm workflow halts.
3. Submit `v1.1`, confirm approval chain restarts for `v1.1` only.
4. Confirm separate receipts exist for `v1.0` and `v1.1`.
5. Compute SHA-256 for `v1.1` and confirm receipt match.

## 13. Client Rollout Variables
- versioning convention
- authoritative format per document type
- carry-over approval policy
- formatting-only change policy
- per-version evidence retention
