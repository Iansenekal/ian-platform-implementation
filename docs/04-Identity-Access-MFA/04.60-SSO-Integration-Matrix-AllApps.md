# AI Platform Deployment Documentation

## 04.60 SSO Integration Matrix - All Apps

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
SSO standards, OIDC/SAML selection, redirect URI templates, claims model, and per-application verification.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/04-Identity-Access-MFA/04.60-SSO-Integration-Matrix-AllApps` |
| Filename (target) | `docs/04-Identity-Access-MFA/04.60-SSO-Integration-Matrix-AllApps.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Client Delivery Team |
| Status | Approved SSO integration blueprint; implemented during module deployments |
| Install Order Position | After 04.40 RBAC; before 11.* IdP deployment and before app deployments (10.*, 20.*, 21.*, 30.*, 40/41) |
| Applies to | UI, Gateway, Nextcloud, OpenSearch Dashboards, Search/Graph, optional n8n, optional Windmill, monitoring tools if deployed |
| Primary requirement | Central IdP is the only authentication authority; MFA at IdP; RBAC via group claims |
| Related docs | 04.10 Identity Architecture; 04.20 Auth Modes; 04.30 MFA; 04.40 RBAC; 11.* IdP; 10.40/10.50 Gateway; 21.30 Nextcloud auth; 30.15 ACL |
| Security note | Admin consoles require BOTH Zone E allowlist and MFA; no direct backend exposure |
| Change control | Any change to SSO protocol, client IDs, redirect URIs, scopes, or claims mapping must be versioned and audited |

## Contents

- 1. Purpose and outcomes
- 2. SSO standards (platform-wide)
- 3. Protocol selection (OIDC vs SAML)
- 4. Canonical hostnames and routing (Two-VM)
- 5. Claims and scopes standard (roles, groups, project scopes)
- 6. Session and token lifecycle policy (baseline)
- 7. SSO Integration Matrix (All Apps)
- 8. Per-application configuration checklist (what must be set)
- 9. Verification checklist (mandatory)
- 10. Client rollout variables (template)

## 1. Purpose and outcomes

This document is the single source of truth for how Single Sign-On (SSO) is implemented across the platform. It standardizes which protocol is used per application (OIDC or SAML), which endpoints and hostnames are published, which claims are required for RBAC and project scoping, and how to verify each integration.

The platform is LAN-only: all user-facing SSO endpoints are published via AI-FRONTEND01 over HTTPS 443.

Outcomes:

- A consistent SSO design that works in both AD-integrated and Local Users environments.
- A complete matrix of all apps and how they authenticate.
- A standard claims model used by Gateway and downstream apps.
- A verification runbook to confirm SSO + RBAC + MFA are correctly enforced.

## 2. SSO standards (platform-wide)

- S1: Identity Provider (IdP) is the ONLY authentication authority. Apps must not maintain separate password databases if avoidable.
- S2: MFA is enforced at the IdP (04.30). Apps should not implement MFA independently unless required for a specific risk case.
- S3: RBAC is group-driven (04.40). Applications consume roles/groups from IdP-issued tokens or from mapped role claims.
- S4: All SSO and RBAC changes are audited: client registrations, secrets rotation, redirect URI changes, group mapping changes.
- S5: User-facing exposure is centralized on AI-FRONTEND01:443. AI-DATA01 remains non-user-reachable (except allowlisted admin paths if required).
- S6: TLS is mandatory; internal CA preferred. No HTTP endpoints.
- S7: Least privilege applies to service accounts and machine-to-machine credentials (03.10, 03.20).

## 3. Protocol selection (OIDC vs SAML)

### 3.1 Default choice: OpenID Connect (OIDC)

- OIDC is the default for modern web apps and APIs.
- Works cleanly with JWT access tokens and Gateway validation.
- Supports strong claims for roles/groups and fine-grained scoping.

### 3.2 When SAML is acceptable

- Use SAML when the application supports SAML well but has limited OIDC support.
- SAML is often used for enterprise dashboard tools; OIDC remains preferred when available.

### 3.3 Practical rule

- If an app supports OIDC: choose OIDC.
- If an app does not support OIDC but supports SAML: choose SAML.
- If an app supports neither: keep it behind a protected reverse proxy (admin-only), and use strong local accounts as a last resort. Document the exception.

## 4. Canonical hostnames and routing (Two-VM)

Recommended internal DNS names (published by DNS server on LAN):

- `ui.<domain>` -> AI-FRONTEND01 (Next.js UI)
- `id.<domain>` -> AI-FRONTEND01 (reverse-proxy route to IdP)
- `api.<domain>` -> AI-FRONTEND01 (reverse-proxy route to Gateway)
- `nextcloud.<domain>` -> AI-FRONTEND01 (reverse-proxy route to Nextcloud, if enabled)
- `dashboards.<domain>` -> AI-FRONTEND01 (admin-only route to OpenSearch Dashboards, if enabled)
- `n8n.<domain>` -> AI-FRONTEND01 (optional, admin-only by allowlist)
- `windmill.<domain>` -> AI-FRONTEND01 (optional, admin-only or power-user by policy)
- `grafana.<domain>` -> AI-FRONTEND01 (if deployed)

Rule: Even if an app runs on AI-DATA01, its user-facing hostname is still routed through AI-FRONTEND01 so we can apply a single enforcement point for TLS, allowlists, and standard headers.

## 5. Claims and scopes standard (roles, groups, project scopes)

### 5.1 Minimum identity claims

- `sub` (stable unique subject identifier)
- `preferred_username` (or username)
- `email` (where available)
- `name` / display name (optional)

### 5.2 Authorization claims (RBAC)

- `groups`: list of group names (preferred), OR
- `roles`: derived role list if the IdP supports role mapping, OR
- both (recommended where possible)

Group naming must follow 04.40 (e.g., `AI-PLATFORM-ADMINS`, `AI-NC-PROJ-<CODE>-VIEW`).

### 5.3 Project scoping claims (recommended)

- `project_scopes`: explicit list of project codes user can access (derived from project group membership).
- If `project_scopes` is not issued, the Gateway must derive project access from group names.

### 5.4 Scopes (OIDC)

- `openid` (mandatory)
- `profile` (recommended)
- `email` (recommended)
- `groups` (if supported by IdP)
- `offline_access` (only if refresh tokens are required and approved)

## 6. Session and token lifecycle policy (baseline)

- Access tokens: short-lived (example: 10-15 minutes).
- Refresh tokens / sessions: time-bound (example: 8-24 hours) with re-auth for admin roles.
- Admin roles: enforce step-up authentication where possible (re-MFA for sensitive actions).
- Logout: end IdP session and clear UI session cookies; verify front-channel logout behavior where supported.
- Cookies (UI): Secure + HttpOnly + SameSite=Lax/Strict (depending on flow); no tokens in localStorage for admin-grade security.

## 7. SSO Integration Matrix (All Apps)

This matrix states the approved SSO approach per application/module. Published URL is always via AI-FRONTEND01:443.

| Module/App | Published URL | Runs on | Protocol | Primary Auth Source | MFA | RBAC source | Provisioning source | Admin allowlist | Notes / constraints | Secrets location | Verification focus |
|---|---|---|---|---|---|---|---|---|---|---|---|
| Platform UI (Next.js) | `https://ui.<domain>` | AI-FRONTEND01 | OIDC (Auth Code + PKCE) | IdP | Per tier (04.30) | Groups/roles claims | AD or Local (04.20) | Admin routes: Yes | UI uses IdP for login; calls API via Gateway only | `/opt/frontend/secrets` | Login redirect + session cookie + role visibility |
| API Gateway (FastAPI) | `https://api.<domain>` | AI-DATA01 | OIDC JWT validation (Bearer) | IdP-issued tokens | Indirect (IdP) | Groups/roles -> authorization decisions | N/A (service) | N/A (not user-facing) | Gateway is enforcement point for RBAC/project scope | `/opt/gateway/secrets` | Token validation, 403 on unauthorized, audit logs |
| Identity Provider (IdP) | `https://id.<domain>` | AI-DATA01 (published via frontend) | OIDC provider | AD (LDAPS) or Local store | Yes (policy) | Issues groups/roles claims | AD sync or local admin | Yes (console) | Treat as Tier-0 service; admin console restricted + MFA | `/opt/idp/secrets` | MFA enrollment/reset, audit events, groups claim |
| Nextcloud | `https://nextcloud.<domain>` | AI-DATA01 or AI-FRONTEND01 (choice) | OIDC login (preferred) + LDAP/AD optional | IdP (SSO) | Indirect (IdP) | Group-driven ACLs (04.40 + 21.35) | AD LDAP for users/groups OR local | Admin routes: Yes | Granular roles: Admin/User/Read-Only + project VIEW/EDIT/OWNER | `/opt/nextcloud/secrets` | SSO login, group mapping, folder ACL enforcement |
| OpenSearch Dashboards (admin) | `https://dashboards.<domain>` | AI-DATA01 (published via frontend) | OIDC (preferred) or SAML | IdP | Yes (admins) | Roles mapped from groups | Local (dashboards) | Yes (mandatory) | Admin-only by allowlist; no public access | `/opt/opensearch/secrets` | OIDC login, role mapping, admin allowlist enforced |
| Search + Knowledge Graph UI | `https://ui.<domain>/search` (path) | AI-FRONTEND01 | OIDC via main UI session | IdP | Per tier | Gateway filters results by ACL inheritance | N/A | Admin routes: Yes (if any) | Mind-map must not leak hidden nodes/edges/metadata | `/opt/frontend/secrets` | ACL inheritance + mind-map visibility rules |
| n8n (optional) | `https://n8n.<domain>` | AI-DATA01 or AI-FRONTEND01 (choice) | OIDC/SAML if licensed; otherwise exception | IdP (if SSO supported) | Yes (admins) | n8n roles + project separation (if used) | Local (n8n) | Yes (recommended) | n8n SSO is Enterprise-feature; if Community edition, document exception and lock down access | `/opt/n8n/secrets` | SSO works if enabled; otherwise strict allowlist + strong local accounts |
| Windmill (optional) | `https://windmill.<domain>` | AI-DATA01 or AI-FRONTEND01 (choice) | SSO/OIDC (preferred) | IdP | Per tier | Windmill roles mapped from groups | Local (Windmill) | Yes (recommended) | Use SSO; restrict admin functions; audit workflow changes | `/opt/windmill/secrets` | SSO login, role mapping, audit workflow changes |
| Monitoring UI (Grafana, if deployed) | `https://grafana.<domain>` | AI-DATA01 (published via frontend) | OIDC (preferred) or SAML | IdP | Yes (admins) | Grafana roles mapped from groups | Local (Grafana) | Yes (mandatory) | Admin-only by allowlist; dashboards may have broader view-only groups | `/opt/monitoring/secrets` | SSO + role mapping + read-only dashboards |

Important: For optional modules, the platform remains secure even if the module is not deployed. If a module is deployed, it must follow the protocol and allowlist rules above.

## 8. Per-application configuration checklist (what must be set)

### 8.1 IdP-side checklist (OIDC client registration)

- Create one OIDC client per application (UI, Nextcloud, Dashboards, n8n, Windmill, Grafana).
- Assign client type: confidential (server-side) for web apps; avoid public clients for admin tools.
- Set redirect URIs (exact match).
- Set post-logout redirect URIs (where supported).
- Set scopes: `openid` + `profile` + `email` + `groups` (if supported).
- Set token lifetimes (short access tokens).
- Map groups/roles claims into the token consistently (04.40).
- Rotate client secrets and store them in `/opt/<app>/secrets` (03.20).

### 8.2 Application-side checklist (common)

- Configure Issuer URL (IdP) and discovery endpoint (`/.well-known/openid-configuration`).
- Configure `client_id` and `client_secret` (from secrets file).
- Configure redirect/callback path and verify it matches IdP client settings.
- Configure roles/groups mapping (if the app supports it). If not, enforce roles via Gateway and app-level permissions.
- Ensure admin UI routes are allowlisted (Zone E) and protected by MFA.

### 8.3 Redirect URI templates (placeholders)

- UI: `https://ui.<domain>/api/auth/callback/<provider>`
- Nextcloud: `https://nextcloud.<domain>/apps/oidc_login/oidc`
- Dashboards: `https://dashboards.<domain>/auth/openid/login`
- n8n: `https://n8n.<domain>/rest/sso/oidc/redirect` (if supported)
- Windmill: `https://windmill.<domain>/oauth/callback` (provider-specific)
- Grafana: `https://grafana.<domain>/login/generic_oauth`

### 8.4 Exception handling (apps without SSO)

- If an app cannot do OIDC/SAML in the chosen edition, document the exception and compensate with:
- Admin-only exposure (Zone E allowlist)
- Strong local accounts (no shared accounts)
- Mandatory MFA at IdP for reaching the admin portal (e.g., via a secured access gateway), where feasible
- Additional auditing and access reviews

- If the exception is unacceptable to the client, replace the component with one that supports OIDC/SAML.

## 9. Verification checklist (mandatory)

### 9.1 DNS and TLS verification

Application/terminal: Windows PowerShell from a LAN workstation.

```powershell
nslookup ui.<domain>
nslookup id.<domain>
nslookup api.<domain>
nslookup nextcloud.<domain>
```

Expected: correct IPs returned.

Application/terminal: SSH to AI-FRONTEND01.

```bash
curl -vk https://ui.<domain>/
curl -vk https://id.<domain>/
curl -vk https://api.<domain>/health || true
```

Expected: valid TLS and successful responses from routed endpoints.

### 9.2 SSO flow verification (browser)

- UI login redirects to IdP and returns successfully with a session.
- Admin user is challenged for MFA (Tier 0).
- Read-only user can authenticate but cannot perform edits.
- Logout clears the UI session and ends IdP session where supported.

### 9.3 RBAC enforcement verification (Gateway)

- A Standard user can access only permitted project scopes.
- A user without project group cannot see project items in search or mind-map.
- Admin routes are not reachable from non-allowlisted IPs (Zone E required).

### 9.4 Audit events verification

- Login success/failure events are visible in IdP logs.
- MFA enrollment and reset events are visible and contain ticket/reference notes.
- Group membership changes generate an audit event.
- Gateway logs include `correlation_id` and RBAC decision outcomes.

## 10. Client rollout variables (template)

| Variable | Value |
|---|---|
| Client name | `<ClientName>` |
| Internal domain | `<client.local>` |
| DNS server(s) | `<IP(s)>` |
| Frontend VM IP | `<AI-FRONTEND01 IP>` |
| Backend VM IP | `<AI-DATA01 IP>` |
| Published hostnames | `ui.*, id.*, api.*, nextcloud.*, dashboards.*, n8n.*, windmill.*` |
| Chosen IdP product | `<IdPName>` |
| Auth mode | `AD Integrated / Local Users` |
| OIDC issuer URL | `<https://id.client.local>` |
| Claims mapping | `groups and/or roles; project scopes` |
| Access token TTL | `<10-15m>` |
| Session/refresh TTL | `<8-24h>` |
| Admin allowlist (Zone E) | `<CIDR/IP list>` |
| MFA enforcement tiers | `Tier 0/1 mandatory` |
| Nextcloud auth mode | `OIDC login + LDAP (optional)` |
| Dashboards auth mode | `OIDC (preferred)` |
| n8n auth mode | `Enterprise OIDC/SAML OR documented exception` |
| Windmill auth mode | `OIDC (preferred)` |
| Monitoring auth mode | `OIDC (preferred)` |
| Client secret rotation cadence | `<90 days>` |
| Break-glass owners | `<two custodians>` |
| Audit retention profile | `T2/T3 per 03.40` |
| Change control ticketing | `<system>` |
| SSO test accounts | `<admin, auditor, standard, read-only>` |
