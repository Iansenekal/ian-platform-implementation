# AI Platform Deployment Documentation

## 04.20 Authentication Modes - AD Integrated vs Local Users

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Decision tree, prerequisites, step-by-step procedures, and verification commands.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/04-Identity-Access-MFA/04.20-Auth-Modes-AD-vs-LocalUsers` |
| Filename (target) | `docs/04-Identity-Access-MFA/04.20-Auth-Modes-AD-vs-LocalUsers.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Client Delivery Team |
| Status | Mandatory design + implementation standard for identity mode selection |
| Install Order Position | After 04.10; before 04.30 MFA and before 11.* Identity Provider deployment |
| Applies to | Identity Provider, Gateway, UI, Nextcloud, Search/Graph, optional n8n/Windmill |
| Primary requirement | Support both AD-integrated clients and clients with no directory services |
| Related docs | 04.00 Overview; 04.10 TwoVM; 04.30 MFA; 04.40 RBAC groups; 04.60 SSO matrix; 11.* IdP deployment |
| Security note | LDAPS is mandatory for AD-mode; local users require stronger onboarding/offboarding controls |
| Change control | Switching modes is a high-impact change and must be planned, tested, and audited |

## Contents

- 1. Purpose and outcomes
- 2. Quick decision summary (choose your mode)
- 3. Shared baseline (applies to both modes)
- 4. Mode A - AD Integrated (preferred)
- 4.1 Requirements and prerequisites
- 4.2 AD group design (baseline + projects)
- 4.3 Service accounts and least privilege
- 4.4 LDAPS connectivity and certificate requirements
- 4.5 Step-by-step procedure (AD mode)
- 4.6 Verification checklist (AD mode)
- 5. Mode B - Local Users (no directory services)
- 5.1 When to use local users
- 5.2 Password policy + account lifecycle standard
- 5.3 Group and role management standard
- 5.4 Step-by-step procedure (Local Users mode)
- 5.5 Verification checklist (Local Users mode)
- 6. Migration Notes (Local Users -> AD, or AD -> Local)
- 7. Security threats and mandatory mitigations (mode-specific)
- 8. Client rollout variables (template)

## 1. Purpose and outcomes

This document defines the two supported authentication modes for the platform:

- Mode A - AD Integrated (preferred): Active Directory is the source of users and groups (via LDAPS and/or SSO).
- Mode B - Local Users (no directory services): the Identity Provider is the source of users and groups.

Both modes produce the same end result for applications: users authenticate through the IdP, MFA can be enforced consistently, and RBAC is derived from group membership.

Outcomes:

- A simple decision rule for selecting the correct mode per client.
- A consistent group naming convention and role model regardless of mode.
- Step-by-step procedures and verification commands for each mode.
- A safe migration posture for clients moving toward AD/Keycloak later.

## 2. Quick decision summary (choose your mode)

### 2.1 Decision tree (practical)

- If the client has Active Directory today: choose Mode A (AD Integrated).
- If the client has no directory service: choose Mode B (Local Users).
- If the client has Entra ID only (cloud) but requires LAN-only runtime: prefer Mode A if they also have on-prem AD; otherwise Mode B with a planned directory roadmap.
- Avoid mixed-mode unless there is a documented migration plan with a target end state and a cutover date.

### 2.2 Why AD Integrated is preferred

- User lifecycle is centralized (joiners/movers/leavers).
- Group membership can be managed using existing HR/IT processes.
- Password policy and account lockout are typically mature in AD.
- Better alignment with least privilege and audit requirements.

## 3. Shared baseline (applies to both modes)

Regardless of AD or Local Users mode, the following are non-negotiable:

- Users authenticate only via AI-FRONTEND01:443 (UI/SSO routes). No direct access to AI-DATA01 for normal LAN users.
- Identity Provider is the single authority for authentication, MFA, sessions, and group-to-role claims.
- Gateway validates tokens and enforces authorization. UI and other apps do not bypass the Gateway.
- MFA is mandatory for privileged roles (Platform Admin, IdP Admin, Auditors).
- All identity events are audited (success/fail logins, MFA events, admin/group changes).
- Group naming convention is stable and documented (04.40).

### 3.1 Shared terminology

- IdP = Identity Provider (deployed on AI-DATA01; published via AI-FRONTEND01 routes).
- RBAC = Role-Based Access Control, based on group membership.
- Project groups = per-project VIEW/EDIT/OWNER groups used by Nextcloud and Search scope.
- Zone E = admin allowlist network; required to access admin consoles.

## 4. Mode A - AD Integrated (preferred)

### 4.1 Requirements and prerequisites

- Client has on-prem Active Directory (recommended Windows Server 2019/2022).
- DNS is working reliably and hostnames resolve (`ui`/`id`/`api`).
- Time sync is correct across VMs and DCs (critical for TLS and tokens).
- LDAPS is available (TCP 636) using a certificate trusted by the IdP (internal CA or AD CS).
- A least-privilege bind account exists for directory queries (not Domain Admin).
- AD groups exist for platform roles and project scopes (see 4.2).

### 4.2 AD group design (baseline + projects)

Use the same naming convention in AD as in local mode to keep the platform consistent.

Baseline groups (minimum):

- `AI-PLATFORM-ADMINS`
- `AI-SECURITY-AUDITORS`
- `AI-USERS-STANDARD`
- `AI-USERS-POWER`
- `AI-USERS-READONLY`
- `AI-AUTOMATION-OPERATORS` (optional)
- `AI-BREAKGLASS-OWNERS` (small set)

Project groups (per project code `<CODE>`):

- `AI-NC-PROJ-<CODE>-VIEW`
- `AI-NC-PROJ-<CODE>-EDIT`
- `AI-NC-PROJ-<CODE>-OWNER`
- `AI-SEARCH-PROJ-<CODE>-QUERY`

Note: detailed permissions per group are defined in 04.40 and 21.35-21.37.

### 4.3 Service accounts and least privilege

- Create a dedicated directory bind account for the IdP (e.g., `svc_ai_idp_ldap`).
- Permissions: read-only directory queries for users and groups. No admin rights.
- If possible, restrict the bind account to a specific OU scope containing platform users/groups.
- Treat bind credentials as secrets (03.20). Rotate every 90 days or per client policy.

### 4.4 LDAPS connectivity and certificate requirements

- LDAPS (TCP 636) is mandatory. Plain LDAP (389) is not allowed for authentication.
- The IdP must trust the issuing CA of the DC's LDAPS certificate.
- Preferred: AD CS or internal CA. Export the CA root certificate and install it in the IdP container/host trust store as needed.
- Test LDAPS connectivity before configuring the IdP.

### 4.5 Step-by-step procedure (AD mode)

This procedure describes the sequence and verification. The exact IdP configuration is implemented in 11.40.

Step A1 - Confirm DNS resolution  
Application/terminal: Windows PowerShell on an admin workstation.

```powershell
nslookup dns01.lab.local
nslookup ui.lab.local 10.10.5.160
nslookup id.lab.local 10.10.5.160
nslookup api.lab.local 10.10.5.160
```

Expected: correct IPs returned with no timeout.

Step A2 - Confirm time sync  
Application/terminal: SSH to AI-DATA01 and AI-FRONTEND01.

```bash
timedatectl status
```

Expected: correct timezone and synchronized clock.

Step A3 - Validate LDAPS port reachability  
Application/terminal: SSH to AI-DATA01 (because IdP runs there).

```bash
nc -vz <DC_HOSTNAME_OR_IP> 636
```

Expected: succeeded. If blocked, fix firewall/network before proceeding.

Step A4 - Validate LDAPS certificate chain (high level)  
Application/terminal: SSH to AI-DATA01.

```bash
echo | openssl s_client -connect <DC_HOSTNAME_OR_IP>:636 -showcerts 2>/dev/null | openssl x509 -noout -issuer -subject -dates
```

Expected: certificate is valid and dates are current.

Step A5 - Prepare AD groups and add test users  
Application: Active Directory Users and Computers (GUI) on a domain-joined admin workstation.

1. Create baseline groups listed in 4.2 (if not already present).
2. Create one test project group set (VIEW/EDIT/OWNER) for a pilot project code.
3. Create a test user per role tier (standard, read-only, admin, auditor).
4. Add users to the correct groups.

Verification (PowerShell on a DC or admin workstation):

```powershell
Get-ADUser <testuser> -Properties MemberOf | Select-Object -ExpandProperty MemberOf
```

Step A6 - Configure IdP to use AD directory (LDAPS)  
Application: IdP admin console (via AI-FRONTEND01 routes) performed by Platform Admin in Zone E.

Exact clicks/fields are implemented in 11.40. This document defines what must be configured:

- Directory connection: LDAPS host, port 636, Base DN, Bind DN, Bind password (from secrets file).
- User lookup filter and group lookup filter aligned to client OUs.
- Group mapping rules: map AD groups to platform roles and project scopes (04.40).
- MFA enforcement rules: mandatory for admins/auditors; optional for others (04.30).

Verification: attempt IdP login with each test user and confirm group claims are issued.

### 4.6 Verification checklist (AD mode)

- Login as Standard User: succeeds; sees only standard functions.
- Login as Read-Only User: succeeds; edit actions are denied by RBAC.
- Login as Admin: MFA required; admin routes accessible only from Zone E.
- Login as Auditor: MFA required; can view audit dashboards read-only.
- Audit logs show: login success/failure, MFA challenge, group mapping change events.
- Boundary checks: normal LAN user cannot reach AI-DATA01 identity endpoints directly.

Boundary verification (Windows PowerShell from a normal LAN PC):

```powershell
Test-NetConnection 10.10.5.178 -Port 443
```

Expected: fails (backend not directly reachable).

## 5. Mode B - Local Users (no directory services)

### 5.1 When to use local users

- Client has no Active Directory or directory service today.
- Client is in early-stage deployment and will add directory services later (migration plan).
- Client has a small number of users but still requires MFA + RBAC + audit trails.

### 5.2 Password policy + account lifecycle standard

Local users require stronger operational discipline because there is no external identity governance.

- Passwords: minimum length 14, complexity required, no reuse, no shared accounts.
- Lockout: lock after N failed attempts (client-defined) and require admin reset (audited).
- Onboarding: user created only after approval; assigned baseline groups; MFA enrollment enforced per role tier.
- Offboarding: disable account immediately; revoke sessions; rotate any shared connector credentials; audit the action.
- Access review: Monthly access review of local users and group membership (audited).

### 5.3 Group and role management standard

- Use the same group names as AD mode (Section 4.2) to avoid drift.
- Avoid per-user exceptions; use groups for permissions.
- Use project groups for Nextcloud and search scope (VIEW/EDIT/OWNER).
- Keep the number of platform admins minimal; enforce MFA and allowlist for admin access.

### 5.4 Step-by-step procedure (Local Users mode)

Step B1 - Confirm baseline network boundaries  
Application/terminal: Windows PowerShell from a normal LAN workstation.

```powershell
Test-NetConnection 10.10.5.179 -Port 443
Test-NetConnection 10.10.5.178 -Port 443
```

Expected: Frontend reachable; backend not reachable.

Step B2 - Create baseline groups in the IdP  
Application: IdP admin console (via AI-FRONTEND01 routes) Platform Admin from Zone E.

Create baseline groups (`AI-PLATFORM-ADMINS`, `AI-USERS-READONLY`, etc.) and project groups.

- Create baseline groups first.
- Create project group set for pilot project code (VIEW/EDIT/OWNER).
- Record groups and purpose in the client configuration register.

Step B3 - Create local test users and assign groups  
Application: IdP admin console (Zone E).

1. Create test users: standard, read-only, power user, admin, auditor.
2. Assign each to the appropriate baseline group(s).
3. Assign project users to project VIEW/EDIT/OWNER groups.

Verification: each test user can log in and sees correct app access levels.

Step B4 - Enforce MFA rules  
Application: IdP admin console (Zone E). Exact settings are in 04.30.

- Admins and Auditors: MFA mandatory (TOTP; WebAuthn optional).
- Standard users: client choice (recommended on for higher-risk clients).
- Configure recovery codes and document break-glass storage process (04.70).

Step B5 - Integrate apps using the same claims model  
Application: Gateway and UI configuration (implemented in 10.* and 20.*).

- Ensure tokens include group/role claims in a consistent format.
- Ensure Gateway maps group claims to roles and project scopes (04.40).
- Ensure Nextcloud uses groups for folder ACLs and role tiers (21.35+).

### 5.5 Verification checklist (Local Users mode)

- Standard User login: succeeds; cannot access admin routes; can access only permitted projects.
- Read-Only login: succeeds; edit actions denied; download/view allowed per ACL.
- Admin login: MFA required; admin console reachable only from Zone E allowlist.
- Auditor login: MFA required; read-only access to audit dashboards.
- Audit logs contain: user creation/disable, group changes, MFA enrollment/reset, login events.
- Monthly access review process is scheduled and documented.

## 6. Migration Notes (Local Users -> AD, or AD -> Local)

### 6.1 Local Users -> AD Integrated (recommended migration)

- Keep group names identical so role mapping remains stable.
- Create matching AD groups and migrate users to AD accounts.
- Run a pilot: map AD groups in IdP while keeping local users temporarily.
- Cutover: disable local user accounts once AD logins are confirmed.
- Post-cutover: rotate any local-only credentials and confirm audit continuity.

### 6.2 AD Integrated -> Local Users (avoid unless necessary)

- Use only if AD is being decommissioned and a directory replacement is not available.
- Plan a controlled cutover: export user list, recreate local accounts, enforce MFA, and validate access per group.
- Increase frequency of access reviews post-cutover.

## 7. Security threats and mandatory mitigations (mode-specific)

| Threat | AD mode mitigations | Local mode mitigations | Notes |
|---|---|---|---|
| Plain LDAP interception | Require LDAPS; block TCP 389 | n/a | LDAPS mandatory |
| Over-privileged bind account | Read-only bind account; OU scoping | n/a | Rotate credentials |
| Account lifecycle drift | AD governance + HR process | Strict onboarding/offboarding; monthly reviews | Local mode needs discipline |
| Admin console exposure | Zone E allowlist + MFA + audit | Zone E allowlist + MFA + audit | Same for both modes |
| Group mapping abuse | Change approval + audit events | Change approval + audit events | Mapping is privileged |

## 8. Client rollout variables (template)

| Variable | Value |
|---|---|
| Client name | `<ClientName>` |
| Chosen auth mode | `AD Integrated` / `Local Users` |
| Internal domain | `<client.local>` |
| DNS server(s) | `<IP(s)>` |
| IdP published hostname | `<id.client.local>` |
| UI published hostname | `<ui.client.local>` |
| API published hostname | `<api.client.local>` |
| Admin allowlist (Zone E) | `<CIDR or IP list>` |
| MFA methods | `TOTP; WebAuthn (admins optional)` |
| MFA enforcement tiers | `Admins/Auditors mandatory; others per client` |
| Baseline groups | `AI-PLATFORM-ADMINS, AI-SECURITY-AUDITORS, AI-USERS-*` |
| Project codes | `<list>` |
| Project group template | `AI-NC-PROJ-<CODE>-VIEW/EDIT/OWNER; AI-SEARCH-PROJ-<CODE>-QUERY` |
| AD domain (if AD mode) | `<domain.local>` |
| LDAPS server(s) (if AD mode) | `<IP(s)>` |
| Base DN (if AD mode) | `<DC=...>` |
| Bind account (if AD mode) | `<svc_ai_idp_ldap>` |
| Bind credential rotation | `90 days (default)` |
| Local password policy (if local mode) | `min length 14, complexity, lockout` |
| Local user access review cadence | `Monthly` |
| Break-glass owners | `<two-person custody>` |
| Audit review owner | `<name/role>` |
