# AI Platform Deployment Documentation

## 06.20 Backup + DR - Restore Procedure (Step-by-Step)

LAN-only runtime • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04  
Defines the standard restore workflow: preparation, restore order, validation, and evidence reporting. (No code.)

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/06-Backup-DR/06.20-Restore-Procedure` |
| Filename (target) | `docs/06-Backup-DR/06.20-Restore-Procedure.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Platform Ops |
| Status | Runbook (mandatory) |
| Scope | Restore process for platform components (AI-DATA01 and AI-FRONTEND01) |
| Hard requirements | LAN-only; least privilege; no plaintext secrets; evidence required; post-restore security validation |
| Related docs | 06.00 Scope; 06.10 Schedules; 06.30 DR Runbook; 03.20 Secrets; 50.40 Monitoring verification |
| Time zone | Africa/Johannesburg |
| Approver | Platform Owner + Security |
| Note | Follow the order. Do not expose services during restore. Re-apply UFW allowlists before bringing services up |
| Lab defaults | AI-DATA01 `10.10.5.178`; AI-FRONTEND01 `10.10.5.179` |

## Contents

- 1. Restore objective and success criteria
- 2. Required inputs (what you need before starting)
- 3. Restore order (critical sequence)
- 4. Standard restore workflow (step-by-step)
- 5. Component-specific restore notes
- 6. Post-restore security validation
- 7. Post-restore functional validation
- 8. Evidence pack and sign-off
- 9. Client rollout variables (template)

## 1. Restore objective and success criteria

- Objective: return the platform to a known-good operational state using the most recent valid backup set.
- Success: services start cleanly; data integrity validated; SSO/RBAC enforced; monitoring healthy; no unexpected ports open.
- POPIA: restore only what is required; verify retention policies remain enforced after restore.

## 2. Required inputs (what you need before starting)

- A chosen backup set ID (date/time) for AI-DATA01 and AI-FRONTEND01.
- Access to the backup destination (LAN-only) with approved credentials.
- Approved access to secret backup material (dual-control if applicable).
- Platform inventory: list of enabled modules for this client.
- Change record: why the restore is needed (incident/ticket) and who approved it.
- A clean restore environment plan: in-place restore vs. restore-to-new VM.

## 3. Restore order (critical sequence)

1. Restore configuration and firewall policy assets (so the host is safe before services start).
2. Restore secrets (encrypted handling) - required before services can authenticate.
3. Restore databases/stateful data (Postgres, OpenSearch, Nextcloud DB, automation DBs).
4. Restore file stores (Nextcloud data, document stores, graph stores).
5. Restore application configs (gateway, IdP, UI) and then bring services up in dependency order.
6. Run monitoring and audit verification checks; validate SSO/RBAC and user access.

## 4. Standard restore workflow (step-by-step)

### 4.1 Step 1 - Establish a controlled restore window

7. Announce maintenance window to stakeholders and record start time.
8. Disable user access pathways (do not expose services to users during restore).
9. Confirm the restore target: in-place vs new VM. Prefer restore-to-new VM for major incidents when possible.

### 4.2 Step 2 - Secure the host before restoring data

10. Confirm UFW default-deny posture is active before services start.
11. Confirm SSH access is restricted and only restoration operators are logged in.
12. Confirm time sync is correct (timestamps matter for audit and evidence).

### 4.3 Step 3 - Retrieve and verify the backup set

13. Identify the exact backup set to restore (date/time, component list).
14. Verify integrity: checksums/backup tool verification output and last successful run logs.
15. Confirm the backup set includes: `/opt/<stack>/`, secrets (encrypted), and stateful volumes.

### 4.4 Step 4 - Restore configuration assets (`/opt/<stack>/`, systemd, policy)

16. Restore configuration directories for each enabled stack on the target VM(s).
17. Restore service definitions (`systemd` units) that control auto-start and watchdog behavior.
18. Restore UFW policy assets used to apply allowlists (do not open broad LAN access).

### 4.5 Step 5 - Restore secrets safely

19. Restore secret files only from the encrypted backup set.
20. Apply correct permissions and ownership rules (secrets must not become world-readable).
21. If secrets were rotated after the backup date, decide whether to use restored secrets or re-inject current secrets (document decision).

### 4.6 Step 6 - Restore databases and state

22. Restore Postgres databases first (foundation for many services).
23. Restore OpenSearch snapshots/indices next (search and audit stores).
24. Restore automation DBs (n8n/Windmill) if enabled.
25. Restore Nextcloud DB if enabled and dependent apps are planned.
26. Run integrity validation steps specific to each DB engine (consistency and reachability).

### 4.7 Step 7 - Restore file stores and volumes

27. Restore Nextcloud data directory (if enabled) after DB is restored.
28. Restore any document stores, ingestion caches, and knowledge-graph stores as in scope.
29. Validate filesystem permissions and ownership after restore.

### 4.8 Step 8 - Bring services up in dependency order

30. Start core dependencies (databases/search) first, then identity, then gateway, then UI.
31. Start automation tools (if enabled) after identity and gateway are healthy.
32. Start monitoring last and validate it sees everything correctly.

### 4.9 Step 9 - Validate security posture (before opening to users)

33. Confirm ports exposure matches the Ports Matrix and UFW policy model.
34. Confirm SSO is enforcing MFA for admin roles and correct RBAC mapping.
35. Confirm secrets are not leaked into logs and that audit logging is functional.

### 4.10 Step 10 - Validate functionality and declare service restored

36. Run functional smoke tests for gateway endpoints and UI login flows.
37. Validate Nextcloud access and permission model (if enabled).
38. Validate search functionality and ACL inheritance (if enabled).
39. Re-enable user access pathways after validation passes.
40. Record end time and publish a restoration summary.

## 5. Component-specific restore notes

- Postgres: restore roles/permissions and confirm application users can connect via localhost-only as designed.
- OpenSearch: confirm cluster health and ensure indices are in expected state with retention applied.
- Nextcloud: confirm data directory + DB alignment and run app-integrity checks; ensure external sharing policies are intact.
- IdP: confirm realm/client config, MFA policy, and break-glass accounts exist; validate group-to-role mapping.
- n8n/Windmill: validate credential references and ensure secrets were not restored into plaintext exports.

## 6. Post-restore security validation

- UFW: confirm default deny, only allowlisted ports are open, and LAN-only posture is intact.
- SSH hardening: confirm only approved admin access methods are enabled; review recent logins.
- Secrets: confirm permissions, confirm no secrets in logs; confirm secret backup access was recorded.
- Identity: validate MFA enforcement and RBAC for admin, operator, auditor roles.
- Audit: confirm P0 audit events are being captured after restore.

## 7. Post-restore functional validation

- Gateway/API reachable only from AI-FRONTEND01 and allowed tools; returns expected health status.
- Frontend UI reachable from LAN; SSO flow succeeds; session behavior correct.
- Search returns results consistent with permissions; no cross-project leakage.
- Automation tools (if enabled) run a controlled test workflow/job successfully.
- Monitoring shows all targets UP and no repeated errors; alert tests pass.

## 8. Evidence pack and sign-off

- Restore ticket ID and approval record.
- Backup set ID used (date/time) and integrity verification proof.
- Screenshots/log extracts showing services healthy post-restore.
- Security validation evidence (ports/UFW checks; SSO/MFA checks).
- Functional smoke test evidence (login, gateway, search, Nextcloud if enabled).
- Monitoring status evidence and alert test evidence.
- Lessons learned and any follow-up actions.

## 9. Client rollout variables (template)

| Variable | Value |
|---|---|
| Backup tool in use (client standard) | `<fill>` |
| Restore target approach (in-place / restore-to-new VM) | `<fill>` |
| Who can approve restores | `<fill>` |
| Who can access secret backups (dual-control) | `<fill>` |
| Primary restore operator | `<fill>` |
| Functional smoke test owner | `<fill>` |
| Post-restore security validation owner | `<fill>` |
| Maintenance window notification method | `<fill>` |
| Rollback plan (if restore fails) | `<fill>` |
