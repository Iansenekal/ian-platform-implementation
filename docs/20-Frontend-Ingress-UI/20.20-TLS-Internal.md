# AI Platform Deployment Documentation

## 20.20 Frontend Ingress + UI - Internal TLS (Private CA)

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Private CA strategy, certificate lifecycle, client trust deployment, and verification procedures for internal HTTPS.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/20-Frontend-Ingress-UI/20.20-TLS-Internal` |
| Filename (target) | `docs/20-Frontend-Ingress-UI/20.20-TLS-Internal.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + DevOps |
| Status | Mandatory; internal HTTPS is required |
| Runs on | AI-FRONTEND01 (reverse proxy terminates TLS) |
| Hard requirements | No public ACME; internal CA only; short-lived certs; restricted key permissions; verify cert chain |
| Related docs | 03.20 Secrets; 02.20 UFW model; 11.* IdP TLS expectations; 20.10 Ports |
| Evidence requirement | openssl `s_client` output + curl tests + client trust validation |
| Change trigger | Re-run after CA rotation or certificate renewal |
| Time zone | Africa/Johannesburg |
| Lab defaults | DNS: `10.10.5.160`; LAN: `10.10.5.0/24` |
| Note | This doc focuses on the TLS model and trust distribution; per-service proxy config lives in other docs. |

## Contents

- 1. Purpose and outcomes
- 2. Internal TLS architecture (where TLS terminates)
- 3. CA strategy (Root + Intermediate)
- 4. Certificate naming (SANs) and hostname plan
- 5. Key management and permissions (POPIA-friendly)
- 6. Step-by-step: Generate internal CA (lab method)
- 7. Step-by-step: Issue service certificates for AI-FRONTEND01
- 8. Step-by-step: Deploy CA trust to clients (Windows/macOS/Ubuntu)
- 9. Verification procedures (mandatory)
- 10. Rotation and renewal policy
- 11. Client rollout variables (template)

## 1. Purpose and outcomes

Because the platform is LAN-only and must not rely on public cloud services, HTTPS is provided using an internal Private CA.

Outcomes:

- Internal TLS on all user-facing hostnames (`ui.<domain>`, `id.<domain>`, `api.<domain>` as needed).
- No reliance on public ACME/Let's Encrypt.
- Secure key storage with strict permissions.
- Repeatable certificate issuance and rotation model.
- Clients trust the CA without bypassing certificate validation.

## 2. Internal TLS architecture (where TLS terminates)

- TLS terminates at the AI-FRONTEND01 reverse proxy (Caddy/NGINX).
- Upstream traffic to AI-DATA01 can be HTTP on a trusted LAN segment, or internal TLS can be used between tiers (optional).
- IdP and Gateway are not directly accessed by clients; the proxy is the user-facing certificate endpoint.

## 3. CA strategy (Root + Intermediate)

- Preferred: Offline Root CA + online Intermediate CA used for issuing service certificates.
- Root CA private key stored offline (not on servers).
- Intermediate CA private key stored on a secure admin workstation or a dedicated CA VM with restricted access.
- If lab simplicity is required, a single CA may be used temporarily, but plan to migrate to Root+Intermediate for production clients.

### 3.1 Why Root+Intermediate

- If an intermediate is compromised, you can revoke and re-issue without replacing the trusted root everywhere.
- Supports better governance and POPIA-friendly controls.

## 4. Certificate naming (SANs) and hostname plan

- Each service hostname should have its own certificate with correct SANs.
- Avoid wildcard certificates unless governance approves (wildcards expand blast radius).
- Recommended hostnames: `ui.<domain>`, `id.<domain>`, `api.<domain>`, `nc.<domain>` (Nextcloud).
- All hostnames must resolve via internal DNS (`10.10.5.160`).

## 5. Key management and permissions (POPIA-friendly)

- Private keys stored under `/opt/frontend/certs` (or `/opt/<service>/certs`) with `chmod 600` and root ownership.
- Do not store keys in Git repos, documentation, or shared drives.
- Limit access to keys to root and the reverse proxy service account only.
- Rotation policy: short-lived certs (e.g., 90 days) or per client governance; renew before expiry.

## 6. Step-by-step: Generate internal CA (lab method)

This lab method uses `openssl`. In production, you may instead use AD CS, Smallstep, or an approved internal CA solution.

Terminal/app: SSH to a secure admin host or AI-FRONTEND01 during lab build.

Step 6.1 - Create CA folder structure (safe paths)

```bash
sudo mkdir -p /opt/pki/{root,intermediate,issued,csr}
sudo chmod 0750 /opt/pki
sudo chown -R root:root /opt/pki
sudo ls -la /opt/pki
```

Step 6.2 - Create a Root CA (offline recommended)

- If doing this on AI-FRONTEND01 for lab, treat it as temporary and rotate later.
- Do not copy Root CA key to multiple systems.

```bash
cd /opt/pki/root
sudo openssl genrsa -out root-ca.key 4096
sudo openssl req -x509 -new -nodes -key root-ca.key -sha256 -days 3650 -out root-ca.crt \
  -subj "/C=ZA/ST=Gauteng/L=Johannesburg/O=Client-Lab/OU=AI-Platform/CN=Client-Lab Root CA"
```

Permissions:

```bash
sudo chmod 600 /opt/pki/root/root-ca.key
sudo chmod 644 /opt/pki/root/root-ca.crt
sudo ls -la /opt/pki/root
```

Verification:

```bash
openssl x509 -in /opt/pki/root/root-ca.crt -noout -subject -issuer -dates
```

Step 6.3 - Create an Intermediate CA (recommended)

```bash
cd /opt/pki/intermediate
sudo openssl genrsa -out int-ca.key 4096
sudo openssl req -new -key int-ca.key -out int-ca.csr \
  -subj "/C=ZA/ST=Gauteng/L=Johannesburg/O=Client-Lab/OU=AI-Platform/CN=Client-Lab Intermediate CA"
```

Sign intermediate with Root CA:

```bash
sudo openssl x509 -req -in /opt/pki/intermediate/int-ca.csr -CA /opt/pki/root/root-ca.crt -CAkey /opt/pki/root/root-ca.key \
  -CAcreateserial -out /opt/pki/intermediate/int-ca.crt -days 1825 -sha256
```

Permissions + verification:

```bash
sudo chmod 600 /opt/pki/intermediate/int-ca.key
sudo chmod 644 /opt/pki/intermediate/int-ca.crt
openssl verify -CAfile /opt/pki/root/root-ca.crt /opt/pki/intermediate/int-ca.crt
```

Step 6.4 - Build CA bundle for clients

```bash
sudo bash -lc 'cat /opt/pki/intermediate/int-ca.crt /opt/pki/root/root-ca.crt > /opt/pki/ca-bundle.crt'
ls -la /opt/pki/ca-bundle.crt
```

- PASS: `ca-bundle.crt` exists and includes intermediate + root chain.

## 7. Step-by-step: Issue service certificates for AI-FRONTEND01

Issue separate certificates per hostname (recommended). Example hostnames: `ui.lab.local`, `id.lab.local`, `nc.lab.local`.

Step 7.1 - Create an OpenSSL SAN config for `ui.<domain>`

1. Open: `sudo nano /opt/pki/csr/ui-san.cnf`
2. Paste the full contents below.
3. Replace `<UI_FQDN>` and IP placeholders.
4. Save and exit.

```ini
# /opt/pki/csr/ui-san.cnf
[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
distinguished_name = dn
req_extensions     = req_ext

[ dn ]
C=ZA
ST=Gauteng
L=Johannesburg
O=Client-Lab
OU=AI-Platform
CN=<UI_FQDN>

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = <UI_FQDN>
IP.1  = 10.10.5.186
```

Step 7.2 - Generate key + CSR and sign with Intermediate CA

```bash
sudo mkdir -p /opt/frontend/certs
sudo chmod 0750 /opt/frontend/certs
sudo chown -R root:root /opt/frontend

cd /opt/pki/issued
sudo openssl genrsa -out ui.key 2048
sudo openssl req -new -key ui.key -out ui.csr -config /opt/pki/csr/ui-san.cnf
sudo openssl x509 -req -in ui.csr -CA /opt/pki/intermediate/int-ca.crt -CAkey /opt/pki/intermediate/int-ca.key \
  -CAcreateserial -out ui.crt -days 365 -sha256 -extensions req_ext -extfile /opt/pki/csr/ui-san.cnf
```

Deploy cert + key to `/opt/frontend/certs`:

```bash
sudo cp /opt/pki/issued/ui.crt /opt/frontend/certs/ui.crt
sudo cp /opt/pki/issued/ui.key /opt/frontend/certs/ui.key
sudo cp /opt/pki/ca-bundle.crt /opt/frontend/certs/ca-bundle.crt
sudo chmod 600 /opt/frontend/certs/ui.key
sudo chmod 644 /opt/frontend/certs/ui.crt /opt/frontend/certs/ca-bundle.crt
sudo ls -la /opt/frontend/certs
```

Step 7.3 - Repeat for `id.<domain>` and `nc.<domain>`

- Create `id-san.cnf` and `nc-san.cnf` with the correct FQDN + IP.
- Issue separate certs (`id.crt`/`id.key`, `nc.crt`/`nc.key`).
- Store them under `/opt/frontend/certs` with `chmod 600` for keys.

## 8. Step-by-step: Deploy CA trust to clients (Windows/macOS/Ubuntu)

### 8.1 Windows 11 (Local Machine Trust)

5. Copy `root-ca.crt` to your Windows PC.
6. Open: Start -> Run -> `mmc`
7. File -> Add/Remove Snap-in -> Certificates -> Computer account -> Local computer -> Finish -> OK
8. Expand: Certificates (Local Computer) -> Trusted Root Certification Authorities -> Certificates
9. Right-click Certificates -> All Tasks -> Import -> select `root-ca.crt` -> Finish
10. If using an Intermediate CA, import `int-ca.crt` into Intermediate Certification Authorities -> Certificates.

Verification (PowerShell):

```powershell
certutil -store Root | findstr /I "Client-Lab Root CA"
```

### 8.2 macOS (System Keychain Trust)

11. Copy `root-ca.crt` to the Mac.
12. Open Keychain Access -> System -> Certificates.
13. File -> Import Items -> select `root-ca.crt`.
14. Double-click the imported certificate -> Trust -> Always Trust.

Verification (Terminal):

```bash
security find-certificate -a -c "Client-Lab Root CA" /Library/Keychains/System.keychain | head -n 20
```

### 8.3 Ubuntu clients (System trust store)

15. Copy `root-ca.crt` to the Ubuntu client (`/tmp/root-ca.crt`).
16. Move into `/usr/local/share/ca-certificates` and update the trust store.

```bash
sudo cp /tmp/root-ca.crt /usr/local/share/ca-certificates/client-lab-root-ca.crt
sudo update-ca-certificates
```

Verification:

```bash
grep -R "Client-Lab Root CA" /etc/ssl/certs/ca-certificates.crt >/dev/null && echo "Trusted"
```

## 9. Verification procedures (mandatory)

### 9.1 Verify TLS chain with openssl

```bash
openssl s_client -connect ui.<domain>:443 -servername ui.<domain> </dev/null 2>/dev/null | grep -E "subject=|issuer=|Verify return code"
```

- PASS: `Verify return code: 0 (ok)` from a trusted client.

### 9.2 Verify curl without -k (no insecure bypass)

```bash
curl https://ui.<domain>/ -I | head -n 20
```

- PASS: succeeds without `-k` once CA is trusted.

### 9.3 Verify certificate expiry windows

```bash
openssl x509 -in /opt/frontend/certs/ui.crt -noout -dates
```

- PASS: not expired; renewal scheduled before expiry.

## 10. Rotation and renewal policy

- Service certificates: renew every 90-365 days per governance; shorter is more secure.
- Intermediate CA: renew every 2-5 years; rotate if compromised.
- Root CA: renew every 5-10 years; rotate only with planned client trust update.
- If any private key is suspected compromised: replace immediately and re-issue dependent certs.

## 11. Client rollout variables (template)

| Variable | Value |
|---|---|
| Domain/search domain | `lab.local` |
| Internal DNS server | `10.10.5.160` |
| UI FQDN | `ui.<domain>` |
| IdP FQDN | `id.<domain>` |
| Gateway FQDN | `api.<domain>` |
| Nextcloud FQDN | `nc.<domain>` |
| Certificate strategy | `Root + Intermediate (preferred)` |
| Root CA subject | `Client-Lab Root CA` |
| Intermediate CA subject | `Client-Lab Intermediate CA` |
| CA bundle file | `/opt/pki/ca-bundle.crt` |
| Service cert path | `/opt/frontend/certs/*.crt` |
| Service key path | `/opt/frontend/certs/*.key` |
| Key permissions | `0600 root:root` |
| Cert permissions | `0644 root:root` |
| Renewal window | `renew at 30 days before expiry` |
| Cert validity | `365 days (example)` |
| Wildcard policy | `Avoid; per-host certs` |
| Client trust method | `Windows MMC / macOS Keychain / Ubuntu update-ca-certificates` |
| Evidence repository | `<secure path>` |
| Rotation cadence | `<policy>` |
| CRL/Revocation (optional) | `<if implemented>` |
| Upgrade impacts | `proxy reload required after cert replace` |
