# AI Platform Deployment Documentation

## 20.30 Frontend Ingress + UI - SSO Flow (OIDC)

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
End-to-end SSO user journey, token handling rules, session model, and verification evidence for UI <-> IdP <-> Gateway.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/20-Frontend-Ingress-UI/20.30-UI-SSO-Flow` |
| Filename (target) | `docs/20-Frontend-Ingress-UI/20.30-UI-SSO-Flow.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Full-Stack Engineering + Security Architecture |
| Status | Mandatory; UI must integrate with IdP before production use |
| Applies to | OIDC Authorization Code Flow + PKCE (recommended) |
| Hard requirements | No tokens in localStorage; secure cookies; short-lived access tokens; offline JWKS validation at Gateway |
| Related docs | 11.00/11.10 IdP; 11.60 MFA; 11.70 Groups claim; 10.40 Token validation; 10.50 RBAC; 20.20 TLS |
| Evidence requirement | Discovery fetch; login flow; token claim inspection; logout; negative tests |
| Change trigger | Re-run after IdP changes, client ID rotation, or UI auth library changes |
| Time zone | Africa/Johannesburg |
| Lab defaults | `ui.lab.local`, `id.lab.local`, `api.lab.local` |
| Note | This is a flow + policy doc, not application code. |

## Contents

- 1. Purpose and outcomes
- 2. Actors and endpoints (who talks to what)
- 3. OIDC flow (Authorization Code + PKCE) step-by-step
- 4. Session model and token storage rules
- 5. Token contents (claims) and group/RBAC usage
- 6. MFA interaction points
- 7. Logout and session revocation
- 8. Threat model and mitigations (frontend-focused)
- 9. Verification checklist (mandatory)
- 10. Client rollout variables (template)

## 1. Purpose and outcomes

This document defines the canonical SSO flow for the LAN-only UI using the Identity Provider (IdP) via OIDC.

Outcomes:

- Consistent login experience for all users.
- MFA is enforced at the IdP (Tier-based).
- UI never becomes the source of truth for authorization (Gateway remains authoritative).
- Tokens are handled securely without browser persistence risks.

## 2. Actors and endpoints (who talks to what)

- User browser: accesses UI hostname over HTTPS (`ui.<domain>`).
- UI server (AI-FRONTEND01): serves pages and initiates OIDC login redirects.
- IdP (AI-DATA01): authenticates user, enforces MFA, and issues tokens.
- Gateway (AI-DATA01): validates tokens offline via JWKS and enforces RBAC.

### 2.1 Key endpoints

| Purpose | Hostname | Endpoint | Notes |
|---|---|---|---|
| OIDC Discovery | `id.<domain>` | `/.well-known/openid-configuration` | Must be reachable from UI and (optionally) browser |
| JWKS | `id.<domain>` | `/protocol/openid-connect/certs` (example) | Gateway fetches and caches keys |
| Authorization endpoint | `id.<domain>` | `/authorize` | Browser redirect target |
| Token endpoint | `id.<domain>` | `/token` | Server-side exchange; never from browser if possible |
| Userinfo (optional) | `id.<domain>` | `/userinfo` | Only if needed; minimize usage |
| Logout endpoint | `id.<domain>` | `/logout` | End-session flow |
| API base | `api.<domain>` | `/api/*` | Proxied via AI-FRONTEND01 and enforced by Gateway |

## 3. OIDC flow (Authorization Code + PKCE) step-by-step

### 3.1 Step-by-step sequence (happy path)

1. User browses to `https://ui.<domain>` and clicks Sign In.
2. UI creates a PKCE `code_verifier` and `code_challenge`; generates a `nonce` and `state`.
3. UI redirects browser to IdP authorization endpoint with `client_id`, `redirect_uri`, `scope`, `code_challenge`, `state`, `nonce`.
4. IdP prompts for username/password and enforces MFA if required (Tier rules).
5. IdP redirects back to UI `redirect_uri` with an authorization code (and the original `state`).
6. UI validates `state`, then exchanges the authorization code for tokens at IdP token endpoint (server-side).
7. UI establishes a session (secure cookie) and stores minimal user profile data (non-sensitive).
8. UI calls the Gateway for API data; Gateway validates the access token and enforces RBAC using `groups` claim.

### 3.2 Notes on where the token exchange occurs

- Preferred: token exchange occurs server-side on AI-FRONTEND01 (prevents tokens being exposed to browser JS).
- If SPA-only mode is required, use PKCE and store tokens in memory only; never localStorage.

## 4. Session model and token storage rules

### 4.1 Storage rules (mandatory)

- Do not store access tokens or refresh tokens in localStorage or sessionStorage.
- Prefer secure, HttpOnly cookies for session identifiers or encrypted session data.
- If tokens must be present in the browser, store in memory only (cleared on reload) and use short expiries.
- Set cookie flags: `Secure`, `HttpOnly`, `SameSite=Lax` (or `Strict` where possible).

### 4.2 Token lifetimes (recommended defaults)

| Token | Recommended lifetime | Reason |
|---|---|---|
| Access token | 15-30 minutes | Limits blast radius if stolen; supports idle timeout |
| Refresh token | Disabled if possible; else 7-14 days with rotation | Minimize long-lived credentials on LAN |
| Session cookie | 8-12 hours or idle-based | Matches workday; reduces shared PC risk |

## 5. Token contents (claims) and group/RBAC usage

- Gateway enforces authorization using the canonical `groups` claim (11.70).
- UI may use `groups` claim only for UX (feature visibility), not for enforcement.
- Tokens should be POPIA-minimized: avoid extra claims that reveal personal information.
- Preferred claims: `sub`, `preferred_username`, `groups`, `exp`, `iss`, `aud`.

### 5.1 Groups claim examples (canonical)

Example `groups` claim values:

- `AI-PLATFORM-ADMINS`
- `AI-NC-PROJ-BANANA-PEEL-VIEW`
- `AI-NC-PROJ-MASTER-EDIT`

## 6. MFA interaction points

- MFA prompts happen entirely at the IdP during authentication.
- Tier 0/1 must be blocked from token issuance until MFA enrollment is complete (11.60).
- If step-up auth is enabled, sensitive admin actions can trigger re-authentication at IdP.

## 7. Logout and session revocation

- UI logout clears UI session cookie immediately.
- UI triggers IdP end-session endpoint (where supported) to invalidate IdP session.
- If refresh tokens exist, revoke them (IdP feature dependent).
- Gateway should reject expired or revoked tokens; short access token lifetimes help.

## 8. Threat model and mitigations (frontend-focused)

- Threat: token theft via XSS -> Mitigation: HttpOnly cookies; CSP; sanitize UI; no tokens in localStorage.
- Threat: CSRF -> Mitigation: SameSite cookies; CSRF tokens for state-changing requests; strict origin checks.
- Threat: session fixation -> Mitigation: rotate session after login; validate state/nonce.
- Threat: open redirect -> Mitigation: strict allowlist of redirect_uri in IdP; validate redirect targets.
- Threat: privilege escalation by UI manipulation -> Mitigation: all authorization enforced by Gateway.

## 9. Verification checklist (mandatory)

### 9.1 Discovery endpoint reachable

```bash
curl -k https://id.<domain>/.well-known/openid-configuration | head -n 60
```

- PASS: returns discovery JSON over HTTPS.

### 9.2 Login flow works (happy path)

- PASS: user can login and is redirected back to UI.
- PASS: session cookie is set with Secure + HttpOnly.
- Evidence: browser dev tools screenshot (cookie flags) without revealing tokens.

### 9.3 MFA enforced for Tier 0/1

- PASS: Tier 0 user is required to use MFA; cannot proceed without it.
- PASS: recovery codes can be used once and log event is present (do not capture codes).

### 9.4 Token claims include groups

- PASS: access token has canonical `groups` claim; matches role assignments.
- Evidence: decoded claims JSON (redact identifiers if needed).

```bash
python3 - << 'PY'
import base64, json
jwt='PASTE_TOKEN_HERE'
parts=jwt.split('.')
pad='='*(-len(parts[1])%4)
print(json.dumps(json.loads(base64.urlsafe_b64decode(parts[1]+pad)), indent=2))
PY
```

### 9.5 Negative tests

- PASS: user without project group cannot access project data (UI shows denial; API returns 403).
- PASS: direct workstation access to AI-DATA01 service ports is blocked (per 02.*).
- PASS: logout clears UI session and prevents further API calls without re-authentication.

## 10. Client rollout variables (template)

| Variable | Value |
|---|---|
| UI FQDN | `ui.<domain>` |
| IdP FQDN | `id.<domain>` |
| Gateway base | `https://api.<domain>/api` |
| OIDC flow | `Authorization Code + PKCE` |
| Client ID | `<from IdP>` |
| Client secret | `Avoid if possible (public client) or store in /opt/.../secrets if used` |
| Redirect URIs | `https://ui.<domain>/auth/callback (example)` |
| Scopes | `openid profile groups (email optional)` |
| groups claim name | `groups` |
| Access token lifetime | `20 minutes (example)` |
| Refresh token use | `Disabled if possible; else rotation enabled` |
| Session cookie name | `<name>` |
| Cookie SameSite | `Lax (default)` |
| Cookie Secure | `true` |
| Cookie HttpOnly | `true` |
| Step-up auth | `enabled for admin routes (if supported)` |
| MFA tiers | `Tier 0/1 mandatory` |
| Idle timeout | `<minutes>` |
| Logout endpoint | `https://id.<domain>/logout` |
| Audit evidence path | `<secure path>` |
| Client trust (CA) | `installed on endpoints per 20.20` |
| Change control | `<system>` |
