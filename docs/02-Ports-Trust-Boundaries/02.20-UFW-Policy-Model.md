# AI Platform Deployment Documentation

## 02.20 UFW Policy Model

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Host firewall allowlists • Deterministic apply scripts • Verification runbook

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/02-Ports-Trust-Boundaries/02.20-UFW-Policy-Model` |
| Filename | `docs/02-Ports-Trust-Boundaries/02.20-UFW-Policy-Model.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Client Delivery Team |
| Status | Implementation-ready |
| Install Order Position | After 02.00 + 02.10; before module deployments |
| Applies to | `AI-FRONTEND01 (10.10.5.179)` and `AI-DATA01 (10.10.5.178)` |
| Change control | Any new allowed port/path requires updates to 02.00 + 02.10 + 02.20 and re-validation |
| Safety note | Keep a Proxmox console session open during UFW changes |

## 1) Purpose and Design Goals

This document defines the enforceable UFW firewall policy model for the platform and converts the approved Ports Matrix (02.00) and Who-Talks-To-What policy (02.10) into deterministic, repeatable host-level allowlists.

Design goals:

- LAN-only runtime with no public exposure.
- Backend isolation: AI-DATA01 is not user-browsable.
- Least exposure: Postgres/OpenSearch remain localhost-only.
- Deterministic and auditable scripts under `infrastructure/firewall/`.
- Safe operations with lockout prevention and rollback.

## 2) Baseline Assumptions and Policies

### 2.1 Trust zones

- Zone A: User LAN (`10.10.5.0/24` in lab)
- Zone B: AI-FRONTEND01 (`10.10.5.179`)
- Zone C: AI-DATA01 (`10.10.5.178`)
- Zone D: Infrastructure (DNS `10.10.5.160`, internal NTP)
- Zone E: Admin allowlist (client-defined)

### 2.2 Non-negotiable firewall policies

- F1: Default inbound deny on both VMs.
- F2: AI-FRONTEND01 inbound `443/tcp` from LAN CIDR only.
- F3: AI-DATA01 inbound `443/tcp` from AI-FRONTEND01 only.
- F4: SSH optional; if enabled, allowlisted Zone E + rate-limited.
- F5: Postgres (`5432`) and OpenSearch (`9200`) localhost-bound only, with no inbound UFW rule.
- F6: Monitoring ports are localhost-only or collector-only.
- F7: Cloud mirroring disabled by default; enable by approved exception only.

### 2.3 Outbound stance

Default outbound allow is acceptable for OS updates and internal services. Strict egress allowlisting can be applied later as a controlled hardening change.

## 3) Firewall Strategy

UFW enforces:

- Ingress boundary: users reach only `AI-FRONTEND01:443`.
- East-west boundary: `AI-FRONTEND01 -> AI-DATA01:443` only.
- Admin boundary: admin ports restricted to Zone E.
- Local-only boundary: data services stay non-networked.

## 4) Standard Rule Sets

### 4.1 AI-FRONTEND01 inbound

- Allow `443/tcp` from `LAN_CIDR`.
- Optional: allow `22/tcp` from `ADMIN_ALLOWLIST` with UFW rate limiting.
- Deny all other inbound.

### 4.2 AI-DATA01 inbound

- Allow `443/tcp` only from `FRONTEND_IP`.
- Optional: allow `22/tcp` from `ADMIN_ALLOWLIST` with UFW rate limiting.
- Deny all other inbound.

### 4.3 Localhost-only services on AI-DATA01

- Postgres: `127.0.0.1:5432`
- OpenSearch: `127.0.0.1:9200`
- Tika (recommended): `127.0.0.1:9998`

## 5) Optional Rule Modules

- Monitoring collector (optional): allow `9100/9187/9114` from collector IP only.
- SMB indexing (optional): outbound `AI-DATA01 -> SMB targets:445` only.
- Cloud mirroring: explicit approved exception only.

## 6) Lockout Prevention and Rollback

### 6.1 Lockout prevention

1. Open Proxmox console before UFW changes.
2. Ensure SSH allow rule for your admin IP exists before enabling UFW.
3. Apply in maintenance window, keep a second SSH session open.
4. Validate immediately from admin and non-admin clients.

### 6.2 Rollback

- `sudo ufw disable`
- `sudo ufw --force reset`
- Re-apply using scripts from `infrastructure/firewall/`.

## 7) Implementation (Repo Artifacts)

The deterministic scripts/templates for this policy are in:

- `infrastructure/firewall/vars.env.example`
- `infrastructure/firewall/apply-ufw-frontend.sh`
- `infrastructure/firewall/apply-ufw-backend.sh`
- `infrastructure/firewall/verify-ufw.sh`
- `infrastructure/firewall/README.md`

Deploy these to each VM under `/opt/ai-platform/firewall/` and run with `sudo`.

## 8) Verification Runbook (Mandatory)

V1 From non-admin LAN workstation:

- `AI-FRONTEND01:443` must succeed.
- `AI-FRONTEND01:22` must fail.
- `AI-DATA01:443/5601/9200/5432` must fail.

V2 From admin allowlisted workstation:

- SSH to both VMs succeeds only when `ENABLE_SSH=yes` and source IP is allowlisted.

V3 From AI-FRONTEND01:

- `curl -kI https://10.10.5.178/` returns HTTP response.

V4 On AI-DATA01:

- `ss -lntp | egrep '(:5432|:9200|:9998)'` shows localhost-only bindings.

V5 Drift check:

- `sudo ufw status numbered` matches policy; no ad-hoc rules.

## 9) Acceptance Criteria

- UFW enabled and default inbound deny on both VMs.
- AI-FRONTEND01 allows only `443` from LAN (+optional SSH from allowlist).
- AI-DATA01 allows only `443` from frontend (+optional SSH from allowlist).
- Backend ports unreachable from normal LAN clients.
- Localhost-only binds enforced for Postgres/OpenSearch.
- Verification V1-V5 passes and evidence captured.

## 10) Client Rollout Variables

| Variable | Value |
|---|---|
| Client name | `<ClientName>` |
| LAN CIDR | `<CIDR>` |
| AI-FRONTEND01 | `<IP> / <hostname>` |
| AI-DATA01 | `<IP> / <hostname>` |
| DNS servers | `<DNS1>, <DNS2>` |
| NTP source | `<NTP IP/hostname>` |
| Admin allowlist (Zone E) | `<IP list or CIDR>` |
| Enable SSH | `yes|no` |
| Enable monitoring collector | `yes|no` |
| Monitoring collector IP | `<IP>` |
| SMB indexing targets (optional) | `<IP/host list>` |
| Cloud mirroring approval | `disabled by default` |
