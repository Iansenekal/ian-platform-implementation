# AI Platform Deployment Documentation

## 10.40 Backend Gateway - Auth Token Validation

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
OIDC/JWT validation standard (issuer/JWKS), internal CA trust, failure handling, and verification.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/10-Backend-Gateway/10.40-Auth-Token-Validation` |
| Filename (target) | `docs/10-Backend-Gateway/10.40-Auth-Token-Validation.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + Backend Engineering |
| Status | Mandatory; must be implemented before any Gateway endpoint is exposed to the UI |
| Install Order Position | After 04.* Identity/MFA/RBAC and after 10.10 Ports/Boundaries; before 10.50 RBAC Authorization |
| Runs on | AI-DATA01 (Gateway), called only by AI-FRONTEND01 reverse proxy |
| Primary requirement | Only accept IdP-issued tokens; validate offline via JWKS; deny-by-default for any ambiguity |
| Security note | Never log full tokens; do not call out to public/cloud endpoints; internal CA trust required |
| Dependencies | IdP discovery + JWKS over internal DNS/TLS; correct time sync; internal CA trusted by AI-DATA01 |
| Related docs | 04.60 SSO Matrix; 04.30 MFA; 04.40 RBAC; 03.20 Secrets; 03.30 Audit; 10.10 Ports; 10.20 Threat Model; 10.50 RBAC |
| Evidence requirement | Capture command outputs + pass/fail results for the 10.90 verification pack |

## Contents

- 1. Purpose and outcomes
- 2. Architecture (token flow in Two-VM)
- 3. Validation policy (what is accepted vs rejected)
- 4. Required claims and conventions
- 5. Internal CA trust (mandatory for LAN TLS)
- 6. Step-by-step: Configure Gateway token validation
- 6.1 Create folder structure under /opt/gateway
- 6.2 Create the OIDC validation config file (full contents)
- 6.3 Create the Gateway .env template (full contents)
- 6.4 Apply file permissions (mandatory)
- 6.5 Validate IdP discovery + JWKS reachability
- 7. Failure behavior and logging rules (POPIA-safe)
- 8. Verification checklist (mandatory)
- 9. Troubleshooting guide (common failures)
- 10. Client rollout variables (template)

## 1. Purpose and outcomes

The Gateway MUST validate every request using an access token issued by the platform Identity Provider (IdP). This document defines the exact validation policy, required claims, and step-by-step configuration so that:

- only IdP-issued tokens are accepted
- tokens are validated OFFLINE using JWKS (no cloud calls)
- failures are handled securely (no information leakage)
- logs are audit-grade while remaining POPIA-safe

Outcomes:

- AI-DATA01 trusts only the internal IdP issuer and its signing keys (JWKS).
- Tokens with wrong issuer/signature/expiry/required claims are rejected with `401`.
- Authorization decisions are separated (10.50), but authentication is never bypassed.
- Evidence is collected via verification commands and negative tests.

## 2. Architecture (token flow in Two-VM)

- User authenticates via the IdP (MFA enforced per 04.30) using the UI on AI-FRONTEND01.
- UI obtains an access token from the IdP (OIDC).
- UI calls the API via `https://api.<domain>` (AI-FRONTEND01:443).
- AI-FRONTEND01 reverse proxy forwards the request to the Gateway on AI-DATA01:`<GatewayPort>`.
- Gateway validates the `Authorization: Bearer <token>` using the IdP JWKS and policy below.

Important boundary rule: the Gateway does not trust anything from the client except a verifiable token signature and claims. Client-supplied headers must not override identity claims.

## 3. Validation policy (what is accepted vs rejected)

### 3.1 Mandatory checks (must pass)

- VP1: HTTPS required for all IdP endpoints (issuer/discovery/JWKS).
- VP2: Token signature must validate against current IdP JWKS keys.
- VP3: Token `iss` must equal the configured issuer URL exactly.
- VP4: Token must not be expired (`exp`) and must not be used before `nbf` (if present).
- VP5: Allowed algorithms only (default: RS256). Reject `none` algorithm and reject HS* for IdP-issued JWTs.
- VP6: Token must contain required claims (minimum: `sub`, `iss`, `exp`, `iat`).
- VP7: If audience is used, token `aud` must include the configured Gateway audience.
- VP8: Clock skew tolerance is limited (default: 60 seconds). Time sync is mandatory.

### 3.2 Rejection rules (secure defaults)

- RJ1: Missing Authorization header -> `401` (no details).
- RJ2: Invalid/expired token -> `401` (no token content in logs).
- RJ3: Wrong issuer -> `401`.
- RJ4: Missing required claims -> `401`.
- RJ5: Valid token but insufficient role/group -> `403` (handled in 10.50; still logged).

## 4. Required claims and conventions

Required claims (minimum baseline):

- `sub`: stable subject identifier
- `iss`: issuer URL
- `exp`: expiry timestamp
- `iat`: issued-at timestamp

Recommended claims (strongly preferred):

- `preferred_username` or `upn`: human identifier for audit logs
- `email`: optional (use only if needed)
- `groups` or `roles`: required for RBAC (04.40)
- `jti`: token identifier (useful for correlation)

Group claim convention: prefer a single claim name (example: `groups`). All RBAC enforcement must read roles/groups only from the validated token claim.

## 5. Internal CA trust (mandatory for LAN TLS)

Because the platform is LAN-only, internal TLS is typically issued by an internal CA. AI-DATA01 MUST trust the internal CA, otherwise it cannot securely fetch IdP discovery and JWKS over HTTPS.

This section installs the CA root certificate into Ubuntu's trust store on AI-DATA01.

Step 5.1 - Copy the internal CA root certificate to AI-DATA01  
Terminal/app: SSH to AI-DATA01 (Ubuntu).

1. Obtain the CA root certificate file from your approved internal CA source (example filename: `platform-root-ca.crt`).
2. Copy it to AI-DATA01 (use SCP from your admin workstation or place it via approved transfer method).
3. Place the file at: `/usr/local/share/ca-certificates/platform-root-ca.crt`

Commands to run on AI-DATA01:

```bash
sudo install -d -m 0755 /usr/local/share/ca-certificates
sudo cp -f <PATH_TO_YOUR_CA_CERT>/platform-root-ca.crt /usr/local/share/ca-certificates/platform-root-ca.crt
sudo chmod 0644 /usr/local/share/ca-certificates/platform-root-ca.crt
```

Verification command:

```bash
ls -l /usr/local/share/ca-certificates/platform-root-ca.crt
```

Step 5.2 - Update the system trust store  
Terminal/app: SSH to AI-DATA01 (Ubuntu).

```bash
sudo update-ca-certificates
```

Verification command:

```bash
grep -R "platform-root-ca" -n /etc/ssl/certs | head -n 5 || true
```

Step 5.3 - Verify IdP TLS trust works from AI-DATA01  
Terminal/app: SSH to AI-DATA01 (Ubuntu).

```bash
curl -vk https://id.<domain>/.well-known/openid-configuration
```

Pass criteria: curl succeeds without certificate chain errors.

## 6. Step-by-step: Configure Gateway token validation

This configuration is written in files under `/opt/gateway` so it is backup-friendly and consistent with the platform standards.

Important: This document provides the complete file contents to paste. Replace placeholders such as `<domain>`, `<GatewayPort>`, and `<audience>`.

### 6.1 Create folder structure under /opt/gateway

Terminal/app: SSH to AI-DATA01 (Ubuntu).

```bash
sudo install -d -m 0750 /opt/gateway
sudo install -d -m 0750 /opt/gateway/config
sudo install -d -m 0700 /opt/gateway/secrets
sudo install -d -m 0750 /opt/gateway/scripts
```

Verification command:

```bash
sudo ls -la /opt/gateway
sudo ls -la /opt/gateway/config
sudo ls -la /opt/gateway/secrets
sudo ls -la /opt/gateway/scripts
```

### 6.2 Create the OIDC validation config file (full contents)

File path: `/opt/gateway/config/oidc.yaml`  
Terminal/app: SSH to AI-DATA01 (Ubuntu). Editor: `nano` (recommended).

4. Open: `sudo nano /opt/gateway/config/oidc.yaml`
5. Delete any existing content.
6. Paste the full contents below.
7. Save and exit.

```yaml
# /opt/gateway/config/oidc.yaml
# Backend Gateway OIDC/JWT validation policy (LAN-only)

issuer_url: "https://id.<domain>"
discovery_url: "https://id.<domain>/.well-known/openid-configuration"

# Optional: set jwks_url only if you must override discovery.
# In most cases, leave blank and use discovery.
jwks_url: ""

# Only accept asymmetric algorithms from the IdP.
allowed_algs:
  - "RS256"

# If your IdP issues a specific audience for the Gateway, list it here.
# If you do not use audience validation, set audience_required: false.
audience_required: true
audiences:
  - "ai-gateway"
  - "api.<domain>"

# Required JWT claims (minimum)
required_claims:
  - "sub"
  - "iss"
  - "exp"
  - "iat"

# Claims used for identity/audit
username_claim: "preferred_username"
email_claim: "email"

# RBAC groups claim (read-only; authorization handled in 10.50)
groups_claim: "groups"

# Clock skew tolerance in seconds
clock_skew_seconds: 60

# JWKS caching (seconds)
jwks_cache_ttl_seconds: 900

# Logging controls (POPIA-safe)
log_failure_reasons: true
redact_bearer_token: true
```

Verification command:

```bash
sudo sed -n '1,200p' /opt/gateway/config/oidc.yaml
```

### 6.3 Create the Gateway .env template (full contents)

File path: `/opt/gateway/.env.template`  
Terminal/app: SSH to AI-DATA01 (Ubuntu). Editor: `nano`.

8. Open the file: `sudo nano /opt/gateway/.env.template`
9. Paste the complete contents below.
10. Save and exit.

```bash
# /opt/gateway/.env.template
# Backend Gateway runtime configuration (no secrets in this file)

# Network
GATEWAY_BIND_HOST=0.0.0.0
GATEWAY_BIND_PORT=<GatewayPort>   # example: 8443

# Trust boundary: only accept forwarded requests from AI-FRONTEND01 reverse proxy
TRUSTED_PROXY_IP=10.10.5.186
FORWARDED_HEADERS_ENABLED=true

# OIDC/JWT validation
OIDC_CONFIG_PATH=/opt/gateway/config/oidc.yaml

# Logging (POPIA-safe)
LOG_LEVEL=INFO
LOG_REDACT_TOKENS=true

# Correlation
CORRELATION_ID_HEADER=X-Correlation-ID
REQUEST_ID_HEADER=X-Request-ID
```

Note: This is a TEMPLATE. During deployment you will copy it to `/opt/gateway/.env` and replace placeholders such as `<GatewayPort>`.

Verification command:

```bash
sudo sed -n '1,200p' /opt/gateway/.env.template
```

### 6.4 Apply file permissions (mandatory)

Terminal/app: SSH to AI-DATA01 (Ubuntu).

```bash
sudo chown -R root:root /opt/gateway
sudo chmod 0750 /opt/gateway /opt/gateway/config /opt/gateway/scripts
sudo chmod 0700 /opt/gateway/secrets
sudo chmod 0640 /opt/gateway/config/oidc.yaml
sudo chmod 0640 /opt/gateway/.env.template
```

Verification command:

```bash
sudo ls -la /opt/gateway
sudo ls -la /opt/gateway/config
```

### 6.5 Validate IdP discovery + JWKS reachability

Terminal/app: SSH to AI-DATA01 (Ubuntu).

11. Confirm IdP discovery resolves and is reachable.
12. Extract the `jwks_uri` from the discovery document.
13. Fetch the JWKS document.

Commands:

```bash
curl -sS https://id.<domain>/.well-known/openid-configuration | head -n 60
```

Optional helper (requires `jq`):

```bash
curl -sS https://id.<domain>/.well-known/openid-configuration | jq -r .jwks_uri
```

Then fetch JWKS (replace `<JWKS_URI>` with output):

```bash
curl -sS "<JWKS_URI>" | head -n 60
```

Pass criteria: discovery and JWKS return HTTP 200 and JSON content.

## 7. Failure behavior and logging rules (POPIA-safe)

- FB1: Authentication failures return `401` with a generic message (do not reveal which claim failed).
- FB2: Authorization failures return `403` (handled by 10.50) and should include a `correlation_id` for support.
- FB3: Logs MUST NOT include raw bearer tokens. Only log: token hash prefix (optional), subject, issuer, reason code.
- FB4: Logs MUST avoid document bodies or search result bodies; log counts and timing only.
- FB5: Log all admin-route attempts with source IP and outcome.

## 8. Verification checklist (mandatory)

### 8.1 Time sync (precondition)

Terminal/app: SSH to AI-DATA01 and AI-FRONTEND01.

```bash
timedatectl status
```

- Pass: NTP enabled and synchronized; timezone correct.

### 8.2 Network boundary (precondition)

Terminal/app: Windows PowerShell from a normal workstation (not AI-FRONTEND01).

```powershell
Test-NetConnection 10.10.5.187 -Port <GatewayPort>
```

- Pass: blocked (fails).

Terminal/app: SSH to AI-FRONTEND01.

```bash
nc -vz 10.10.5.187 <GatewayPort>
```

- Pass: succeeds from AI-FRONTEND01.

### 8.3 Token validation tests (functional)

How to obtain a test access token (choose ONE safe method):

- Option A (recommended): Login to the UI in a browser, open Developer Tools, and copy the access token used for API calls.
- Option B: Use an approved OIDC test client in a non-production environment.

Do not email tokens or store them in shared notes.

Terminal/app: SSH to AI-FRONTEND01 (acts as the only allowed API caller).

```bash
export TOKEN='<PASTE_ACCESS_TOKEN_HERE>'
curl -sk -H "Authorization: Bearer $TOKEN" https://api.<domain>/whoami
```

- Pass: returns identity/claims summary (no sensitive data).

Negative test, missing token:

```bash
curl -sk https://api.<domain>/whoami -i | head -n 20
```

- Pass: `401 Unauthorized`.

Negative test, tampered token:

```bash
export BADTOKEN="${TOKEN}x"
curl -sk -H "Authorization: Bearer $BADTOKEN" https://api.<domain>/whoami -i | head -n 20
```

- Pass: `401 Unauthorized`.

## 9. Troubleshooting guide (common failures)

### 9.1 Certificate trust errors (`curl: (60) SSL certificate problem`)

- Confirm internal CA is installed on AI-DATA01 (Section 5).
- Confirm the IdP certificate chain includes the correct issuing CA.
- Re-run `sudo update-ca-certificates` and retry curl.

### 9.2 Issuer mismatch errors

- Issuer URL must match EXACTLY (including `https` scheme and host).
- Confirm: discovery document `issuer` matches your configured `issuer_url`.

### 9.3 Time drift / token expired immediately

- Check `timedatectl` on all VMs; fix NTP sources.
- Reduce skew only after confirming clocks are correct; do not increase skew to hide drift.

### 9.4 JWKS key rotation issues

- Ensure JWKS cache TTL is reasonable (default 900s).
- Ensure the Gateway refreshes JWKS when signature validation fails (implementation detail).
- Check IdP admin for key rotation events and audit logs.

## 10. Client rollout variables (template)

| Variable | Value |
|---|---|
| Internal domain | `<client.local>` |
| IdP URL | `https://id.<domain>` |
| Issuer URL (exact) | `https://id.<domain>` |
| Gateway URL (published) | `https://api.<domain> (via AI-FRONTEND01:443)` |
| GatewayPort (internal) | `<GatewayPort> (default 8443)` |
| Allowed algorithms | `RS256` |
| Audience required | `true/false` |
| Allowed audiences | `ai-gateway, api.<domain>` |
| Groups claim name | `groups (or roles)` |
| Username claim | `preferred_username (or upn)` |
| Clock skew seconds | `60` |
| JWKS cache TTL | `900` |
| Internal CA cert name | `platform-root-ca.crt` |
| Admin allowlist Zone E | `<CIDR/IP list>` |
| Log retention profile | `Per 03.40` |
| Sensitive log redaction | `Enabled` |
| Token acquisition method for verification | `UI devtools (preferred)` |
| Evidence repository path | `<secure path>` |
