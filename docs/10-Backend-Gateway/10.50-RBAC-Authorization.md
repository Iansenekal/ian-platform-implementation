# AI Platform Deployment Documentation

## 10.50 Backend Gateway - RBAC Authorization

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Group-based RBAC + project-scoped authorization, deny-by-default policies, and verification evidence.

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/10-Backend-Gateway/10.50-RBAC-Authorization` |
| Filename (target) | `docs/10-Backend-Gateway/10.50-RBAC-Authorization.md` (Word-authored equivalent) |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Security Architecture + Backend Engineering |
| Status | Mandatory; must be implemented before any business endpoints are enabled |
| Install Order Position | After 10.40 Auth Token Validation; before 10.80 Healthchecks and 10.90 Verification |
| Runs on | AI-DATA01 (Gateway) |
| Primary requirement | Deny-by-default. Permissions derive only from validated token claims (groups/roles). |
| Security note | No client-supplied roles. No metadata leakage. Every allow/deny decision is auditable. |
| Dependencies | 04.40 RoleModel-RBAC-Groups; 04.30 MFA policy; 03.30 Audit logging; 30.* ACL inheritance rules |
| Related docs | 10.20 Threat model; 10.10 Ports; 02.10 WhoTalksToWhat; 21.* Nextcloud permissions (as source ACL) |
| Evidence requirement | Capture allow/deny tests and logs as evidence (10.90 checklist) |

## Contents

- 1. Purpose and outcomes
- 2. Authorization model summary
- 3. Roles, groups, and naming conventions (aligned to 04.40)
- 4. Permission layers (platform RBAC + project scope + source ACL inheritance)
- 5. Endpoint classification and required permissions
- 6. Step-by-step: Configure Gateway authorization policy
- 6.1 Create `/opt/gateway/config/rbac.yaml` (full contents)
- 6.2 Create `/opt/gateway/config/projects.yaml` (full contents)
- 6.3 Create `/opt/gateway/config/policy-matrix.yaml` (full contents)
- 6.4 Apply permissions and restart services (verification commands)
- 7. Audit logging rules for authorization decisions
- 8. Verification checklist (mandatory)
- 9. Troubleshooting
- 10. Client rollout variables (template)

## 1. Purpose and outcomes

This document defines and implements the Gateway authorization model.

Authentication (token validation) proves WHO the user is (10.40). Authorization determines WHAT they may do.

Outcomes:

- Consistent group-based RBAC.
- Project-scoped permissions (view/edit/owner).
- No metadata leakage across projects.
- Audit-grade allow/deny records for every privileged action.

## 2. Authorization model summary

- Deny-by-default for every endpoint and every project.
- Permissions derive ONLY from validated JWT claims (`groups` claim).
- Authorization is evaluated in layers: Platform role -> Project scope -> Source ACL inheritance.
- Admin routes require multiple gates: Zone E allowlist (network/proxy) + admin group + MFA at IdP.
- If a request cannot be confidently authorized (missing groups, unknown project, unknown ACL), it is denied.

## 3. Roles, groups, and naming conventions (aligned to 04.40)

Platform roles (examples):

- `AI-PLATFORM-ADMINS` (Tier 0): platform administration, policy management.
- `AI-SECURITY-AUDITORS` (Tier 1): read audit logs, compliance reports.
- `AI-OPS-READONLY`: view health/metrics dashboards (non-admin).

Project groups (examples):

- `AI-NC-PROJ-<CODE>-VIEW`: read/search within that project scope.
- `AI-NC-PROJ-<CODE>-EDIT`: create/update documents and metadata within scope.
- `AI-NC-PROJ-<CODE>-OWNER`: manage project-level access, sharing exceptions (governed).

### 3.1 Role precedence

- `OWNER` includes `EDIT`, and `EDIT` includes `VIEW`.
- Platform admin does not automatically grant access to all project content unless explicitly allowed by policy (POPIA).
- Auditor access is read-only; never grants write access.

## 4. Permission layers (platform RBAC + project scope + source ACL inheritance)

### 4.1 Layer L1 - Platform RBAC

- Controls access to admin endpoints, configuration endpoints, and audit endpoints.
- Examples: `/admin/*` requires `AI-PLATFORM-ADMINS`; `/audit/*` requires `AI-SECURITY-AUDITORS`.

### 4.2 Layer L2 - Project scope

- Every content request is scoped to a project code or a derived project identity.
- Project membership is determined by presence of `AI-NC-PROJ-<CODE>-<ROLE>` in the user's groups claim.
- If the request contains a project code the user is not a member of, deny `403`.

### 4.3 Layer L3 - Source ACL inheritance (mandatory)

Search and graph results may draw from multiple sources (Nextcloud, SharePoint/Teams/OneDrive connectors, local devices). The Gateway must never expose an item unless the user has access in the source system.

Enforcement pattern:

- When indexing, each document carries an ACL that includes allowed principals/groups.
- At query time, the user's effective principals are computed (from token claims + mapped groups).
- Results are filtered to only those where `(user principals ∩ document ACL)` is not empty.
- If the ACL is missing or unknown, the item is hidden (fail closed).

### 4.4 Mind-map/graph visibility rule

- A node is visible only if the underlying document/item is visible per ACL.
- An edge is visible only if BOTH connected nodes are visible (both-side rule).
- Redaction: if a node is not visible, do not return partial labels, counts, or hints that leak existence.

## 5. Endpoint classification and required permissions

| Endpoint family | Examples | Auth required | Project scope required | Minimum role | Admin allowlist required | Notes |
|---|---|---|---|---|---|---|
| Public health | `/health`, `/ready` | No (or optional) | No | N/A | No | Return minimal data only; no secrets |
| Identity | `/whoami` | Yes | No | Any authenticated | No | Returns effective roles/scopes (minimized) |
| Search | `/search/query`, `/search/suggest` | Yes | Yes | VIEW | No | Filter results via ACL inheritance; no leakage |
| Graph/mind-map | `/graph/nodes`, `/graph/edges`, `/graph/mindmap` | Yes | Yes | VIEW | No | Both-side visibility rule; redact hidden nodes |
| Ingest | `/ingest/*` | Yes | Yes | EDIT | No | Upload limits, type allowlist; may require re-auth |
| Project admin | `/projects/*` | Yes | Yes | OWNER | Yes (recommended) | Changes to membership require governance |
| Platform admin | `/admin/*` | Yes | No | AI-PLATFORM-ADMINS | Yes (mandatory) | Must also be MFA-protected at IdP |
| Audit | `/audit/*` | Yes | No | AI-SECURITY-AUDITORS | Yes (recommended) | Read-only; retention per 03.40 |

## 6. Step-by-step: Configure Gateway authorization policy

All policy files live under `/opt/gateway/config` and are treated as configuration-as-data. They contain no secrets.

### 6.1 Create /opt/gateway/config/rbac.yaml (full contents)

```yaml
# /opt/gateway/config/rbac.yaml
# Gateway RBAC policy (platform-level roles)

groups_claim: "groups"   # must match 10.40 oidc.yaml

platform_roles:
  PLATFORM_ADMIN:
    required_groups:
      - "AI-PLATFORM-ADMINS"

  SECURITY_AUDITOR:
    required_groups:
      - "AI-SECURITY-AUDITORS"

  OPS_READONLY:
    required_groups:
      - "AI-OPS-READONLY"

# Role precedence and derived roles
role_precedence:
  - "PLATFORM_ADMIN"
  - "SECURITY_AUDITOR"
  - "OPS_READONLY"

# Optional: allow platform admins to view everything (NOT recommended for POPIA by default)
global_bypass_for_platform_admin: false
```

### 6.2 Create /opt/gateway/config/projects.yaml (full contents)

```yaml
# /opt/gateway/config/projects.yaml
# Project registry used for scoping and UI labels (no secrets)

project_group_prefix: "AI-NC-PROJ-"
project_roles:
  VIEW:  "VIEW"
  EDIT:  "EDIT"
  OWNER: "OWNER"

# Projects list (extend per client)
projects:
  - code: "BANANA-PEEL"
    name: "Operation Banana Peel"
    description: "Example project"
  - code: "NIGHT-PENGUIN"
    name: "Project Night Penguin"
    description: "Example project"
  - code: "DAD-JOKE"
    name: "Operation Dad Joke"
    description: "Example project"
  - code: "LASAGNA"
    name: "The Lasagna Protocol"
    description: "Example project"
  - code: "MASTER"
    name: "Master Chuck Norris"
    description: "Primary build / reference project"
```

### 6.3 Create /opt/gateway/config/policy-matrix.yaml (full contents)

```yaml
# /opt/gateway/config/policy-matrix.yaml
# Route families and required permissions (deny-by-default)

defaults:
  deny_by_default: true

route_families:
  health:
    paths:
      - "/health"
      - "/ready"
    auth_required: false
    min_platform_role: ""
    project_scoped: false
    min_project_role: ""

  whoami:
    paths:
      - "/whoami"
    auth_required: true
    min_platform_role: ""
    project_scoped: false
    min_project_role: ""

  search:
    paths:
      - "/search/query"
      - "/search/suggest"
    auth_required: true
    min_platform_role: ""
    project_scoped: true
    min_project_role: "VIEW"
    enforce_source_acl: true
    leak_metadata: false

  graph:
    paths:
      - "/graph/nodes"
      - "/graph/edges"
      - "/graph/mindmap"
    auth_required: true
    min_platform_role: ""
    project_scoped: true
    min_project_role: "VIEW"
    enforce_source_acl: true
    both_side_visibility: true
    leak_metadata: false

  ingest:
    paths:
      - "/ingest/upload"
      - "/ingest/status"
    auth_required: true
    min_platform_role: ""
    project_scoped: true
    min_project_role: "EDIT"
    enforce_source_acl: true

  audit:
    paths:
      - "/audit/events"
      - "/audit/reports"
    auth_required: true
    min_platform_role: "SECURITY_AUDITOR"
    project_scoped: false
    min_project_role: ""

  admin:
    paths:
      - "/admin/*"
    auth_required: true
    min_platform_role: "PLATFORM_ADMIN"
    project_scoped: false
    min_project_role: ""
    admin_allowlist_required: true
    mfa_required: true
```

### 6.4 Apply file permissions and restart services (verification commands)

```bash
sudo chown -R root:root /opt/gateway/config
sudo chmod 0640 /opt/gateway/config/rbac.yaml /opt/gateway/config/projects.yaml /opt/gateway/config/policy-matrix.yaml
sudo ls -la /opt/gateway/config
```

Restart examples:

```bash
sudo systemctl restart ai-gateway.service
sudo systemctl status ai-gateway.service --no-pager

# or
cd /opt/gateway && sudo docker compose up -d
sudo docker ps | grep -i gateway || true
```

## 7. Audit logging rules for authorization decisions

Every request must produce consistent authorization audit fields:

- `correlation_id` (propagated from UI or generated by Gateway)
- `subject` (`sub`) and `preferred_username` (if available)
- `source_ip` (`X-Forwarded-For` evaluated only from trusted proxy)
- route family + path + HTTP method
- `decision`: allow/deny
- `deny_reason`: `missing_token | invalid_token | missing_groups | insufficient_role | project_not_member | acl_filtered | admin_allowlist`
- `project_code` (if scoped)

POPIA rules: do not log document contents, full search queries, or bearer tokens.

## 8. Verification checklist (mandatory)

Prepare four test users:

- User A: Platform Admin (`AI-PLATFORM-ADMINS`)
- User B: Security Auditor (`AI-SECURITY-AUDITORS`)
- User C: Project Editor (`AI-NC-PROJ-<CODE>-EDIT`)
- User D: Project Viewer (`AI-NC-PROJ-<CODE>-VIEW`)

Commands (from AI-FRONTEND01):

```bash
export TOKEN='<PASTE_ACCESS_TOKEN_HERE>'
authcurl() { curl -sk -H "Authorization: Bearer $TOKEN" "$@"; }
```

Test 1 - Missing token returns 401:

```bash
curl -sk https://api.<domain>/whoami -i | head -n 20
```

Test 2 - Viewer can query search for allowed project:

```bash
authcurl "https://api.<domain>/search/query?project=<CODE>&q=test" | head -n 40
```

Test 3 - Viewer cannot ingest (needs EDIT):

```bash
authcurl -X POST "https://api.<domain>/ingest/upload?project=<CODE>" -i | head -n 30
```

Test 4 - Viewer cannot access a different project:

```bash
authcurl "https://api.<domain>/search/query?project=<OTHER_CODE>&q=test" -i | head -n 30
```

Test 5 - Admin endpoint blocked from non-ZoneE workstation:

```powershell
curl -k https://api.<domain>/admin/health
```

Pass: blocked/denied before reaching Gateway (preferred).

Log evidence capture (AI-DATA01):

```bash
sudo docker logs --tail 200 <gateway_container_name> | tail -n 120
# or
sudo journalctl -u ai-gateway.service --no-pager | tail -n 200
```

Pass: `deny_reason` values appear; `correlation_id` present; no tokens logged; no unauthorized metadata leakage.

## 9. Troubleshooting

- 403 for everything: verify `groups_claim` name matches 10.40 and `rbac.yaml`.
- Project access not detected: verify project group naming (`AI-NC-PROJ-<CODE>-ROLE`) matches `projects.yaml`.
- Admin routes reachable from normal LAN: fix proxy allowlist and UFW; confirm Zone E restrictions.
- Metadata leakage: verify `enforce_source_acl: true` and `leak_metadata: false` in `policy-matrix.yaml`.

## 10. Client rollout variables (template)

| Variable | Value |
|---|---|
| Groups claim name | `groups` |
| Project group prefix | `AI-NC-PROJ-` |
| Project codes list | `<list>` |
| Platform admin groups | `AI-PLATFORM-ADMINS` |
| Auditor groups | `AI-SECURITY-AUDITORS` |
| Ops readonly group | `AI-OPS-READONLY` |
| Admin allowlist Zone E | `<CIDR/IP list>` |
| Global admin bypass | `false (default)` |
| Endpoint families enabled | `health, whoami, search, graph, ingest, audit, admin` |
| Search ACL enforcement | `true` |
| Graph both-side visibility | `true` |
| Leak metadata | `false` |
| Ingest requires EDIT | `true` |
| Audit retention profile | `per 03.40` |
| Correlation header names | `X-Correlation-ID / X-Request-ID` |
| Token re-auth requirement for sensitive ops | `<yes/no>` |
| Change control ticketing | `<system>` |
| Evidence repository path | `<secure path>` |
