# AI Platform Deployment Documentation
## 10.80 Backend Gateway - Healthchecks and Watchdog

LAN-only - POPIA-friendly - Two-VM on Proxmox - Ubuntu 24.04

Document Control
- Document ID: `docs/10-Backend-Gateway/10.80-Healthchecks-Watchdog`
- Filename: `docs/10-Backend-Gateway/10.80-Healthchecks-Watchdog.md`
- Version: `v1.0`
- Date: `2026-02-09`
- Owner: Choice IT / DevOps + SRE
- Status: Mandatory; health and watchdog must be active before production handover
- Install Order Position: After `10.40` and `10.50`; before `10.90`
- Runs on: AI-DATA01 (Gateway) and AI-FRONTEND01 (proxy-side checks)
- Primary requirement: Auto-recover from failures; avoid flapping; provide actionable monitoring signals
- Dependencies: Docker Compose stack + systemd unit for gateway runtime
- Related docs: `03.30`, `50.*`, `05.*`, `06.*`
- Security note: Health endpoints must not leak sensitive info
- Evidence requirement: capture `systemctl status`, Docker health status, and probe results

## 1. Purpose and Outcomes
The Gateway must self-diagnose and self-recover in a LAN-only deployment without cloud dependencies.

Outcomes:
- Clear liveness and readiness signals
- Dependency probing (OpenSearch/Postgres/Tika/IdP JWKS)
- Automatic restart behavior on crash or unhealthy state
- Repeatable, evidence-backed operational checks

## 2. Health Model
- Liveness: process responds locally (`/health`)
- Readiness: service can safely serve requests (`/ready`)
- Dependency health: critical and optional upstreams checked with short timeouts

Recommended endpoints:
- `GET /health` -> `200` while process is alive
- `GET /ready` -> `200` only when ready, else `503`

## 3. Health Endpoint Contract
Health endpoints must be safe for frequent polling and must not leak sensitive details.

Must return only:
- status
- service name
- readiness boolean
- minimal dependency booleans
- timestamp and optional correlation ID

Must not return:
- secrets
- config paths
- credentials/tokens
- stack traces
- full dependency URLs

Example response:

```json
{
  "status": "ok",
  "service": "ai-gateway",
  "ready": true,
  "deps": {
    "opensearch": true,
    "postgres": true,
    "tika": true,
    "idp_jwks": true
  },
  "time": "2026-02-09T10:00:00+02:00"
}
```

## 4. Dependency Probe Plan
- OpenSearch (`http://127.0.0.1:9200`) is critical
- IdP discovery/JWKS (`https://id.<domain>/.well-known/openid-configuration`) is critical
- Postgres (`127.0.0.1:5432`) is optional or client-specific
- Tika (`http://127.0.0.1:9998`) is optional unless ingest-critical

Defaults:
- 2-3 second probe timeouts
- fail-closed for readiness-critical dependencies

## 5. Docker Healthcheck Standard
- Every traffic-serving container must include a `HEALTHCHECK`
- Healthcheck should probe local container endpoint/script
- Use short timeout and bounded retries
- Pair healthcheck with restart policy to recover automatically

Recommended defaults:
- `interval: 30s`
- `timeout: 5s`
- `retries: 3`
- `start_period: 30s`

## 6. systemd Watchdog Model
- Use systemd to supervise gateway container/compose stack where applicable
- Configure `Restart=always` and bounded restart delay
- Use `WatchdogSec` only with reliable heartbeat/check mechanics
- Combine systemd supervision with Docker healthchecks

## 7. Required Script Artifacts
Policy scripts are represented as templates under `infrastructure/gateway/` and deployed to `/opt/gateway/scripts` during runtime rollout.

Mandatory script baselines:
- `healthcheck.sh` for liveness probes
- `deps-check.sh` for readiness dependency probes
- `watchdog-log-summary.sh` for safe operator triage output

## 8. Compose and systemd Integration Templates
Compose integration should include:

```yaml
healthcheck:
  test: ["CMD-SHELL", "/opt/gateway/scripts/healthcheck.sh"]
  interval: 30s
  timeout: 5s
  retries: 3
  start_period: 30s
restart: unless-stopped
```

systemd integration should include:
- `Restart=always`
- `RestartSec=10`
- optional `ExecStartPost=/opt/gateway/scripts/deps-check.sh`

## 9. Failure Modes and Recovery Behavior
- Gateway crash: restarted by Docker/systemd policy
- Critical dependency down: `/ready` returns `503`
- CA trust break to IdP: readiness fails until trust fixed
- Healthcheck flapping: tune `start_period` and dependency timing
- UFW/proxy blockage: frontend cannot reach gateway; fail detected by checks

## 10. Verification Checklist
From AI-FRONTEND01:
- `curl -sk https://api.<domain>/health`
- `curl -sk https://api.<domain>/ready`

From AI-DATA01:
- `sudo docker ps`
- `sudo docker inspect --format='{{json .State.Health}}' <gateway_container_name> | head -n 20`
- `sudo systemctl status ai-gateway.service --no-pager`
- `sudo journalctl -u ai-gateway.service --no-pager | tail -n 120`

Expected:
- `/health` is `200`
- `/ready` is `200` when critical dependencies are healthy, `503` when not
- watchdog/restart behavior follows policy without rapid restart loops

## 11. Client Rollout Variables
- GatewayPort: `8443` (default)
- Health endpoints: `/health`, `/ready`
- Healthcheck timing: `30s / 5s / 3`
- Start period: `30s` (adjust as needed)
- Critical dependencies: OpenSearch + IdP JWKS/discovery
- Optional dependencies: Postgres + Tika
- Readiness fail-closed: `true`
- Restart policy: `unless-stopped` + `Restart=always`
- Restart backoff: `RestartSec=10`
- Watchdog enabled: client choice
- Watchdog interval: e.g. `60s`
- Monitoring/alerts: per `50.*`
- Evidence path: client-specific secure location
