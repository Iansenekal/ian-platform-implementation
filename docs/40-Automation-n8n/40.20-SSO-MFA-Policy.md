# AI Platform Deployment Documentation
## 40.20 Automation - n8n (Optional) SSO and MFA Policy

LAN-only runtime - POPIA-friendly - Two-VM on Proxmox - Ubuntu 24.04

Document Control
- Document ID: `docs/40-Automation-n8n/40.20-SSO-MFA-Policy`
- Filename: `docs/40-Automation-n8n/40.20-SSO-MFA-Policy.md`
- Version: `v1.0`
- Date: `2026-02-09`
- Owner: Choice IT / Identity + Security
- Status: Mandatory if n8n is enabled
- Scope: SSO posture, MFA requirements, roles, session policy, and recovery for n8n
- Hard requirements: LAN-only, MFA for admins, least privilege, auditable admin access
- Related docs: `04.*`, `11.*`, `03.30`, `40.10`
- Primary identity mode: OIDC SSO via platform IdP
- Time zone: `Africa/Johannesburg`
- Evidence requirement: SSO login tests, MFA enforcement tests, RBAC deny tests

## 1. Policy Goals
- ensure only authorized users can access and operate n8n
- enforce MFA for privileged roles and least privilege for operators/builders
- support AD-backed and non-directory organizations through central IdP
- preserve auditability for admin access and workflow/credential changes

## 2. Identity Modes
### 2.1 Preferred: OIDC SSO via platform IdP
- n8n authenticates via IdP and uses group claims for role mapping
- MFA enforcement is handled centrally at IdP policy layer

### 2.2 Supported (no-directory): IdP-local users
- users are managed in IdP local directory with MFA and role groups
- n8n is never the primary identity store

### 2.3 Fallback: local n8n users (break-glass only)
- disabled by default and restricted to emergency admin use
- post-use credential rotation and incident review are mandatory

## 3. MFA Requirements by Role
| Role | MFA Required | Methods | Notes |
|---|---|---|---|
| n8n Admin | Yes (mandatory) | WebAuthn preferred, TOTP, recovery codes | restricted membership and allowlisted access |
| n8n Operator | Recommended | WebAuthn or TOTP | operational actions only |
| n8n Builder | Recommended | WebAuthn or TOTP | scoped workflow editing |
| n8n Viewer | Optional | TOTP optional | read-only visibility |

## 4. RBAC Mapping for n8n Roles
- role groups align with platform naming and claim conventions
- baseline groups: `AI-N8N-ADMINS`, `AI-N8N-OPERATORS`, `AI-N8N-BUILDERS`, `AI-N8N-VIEWERS`
- optional project-scoped groups: `AI-N8N-PROJ-<CODE>-BUILDERS/VIEWERS`
- separation of duties: admins minimized; builders/operators separated where feasible

## 5. Session and Login Security
- short admin session lifetime with stricter idle timeout
- re-authentication for sensitive actions
- lockout policy enforced at IdP for repeated failures
- access constrained to LAN allowlisted networks

## 6. Account Lifecycle
1. joiner: create identity, assign least-privilege groups, enforce MFA enrollment
2. mover: update groups and review ownership/permissions
3. leaver: immediate disablement and credential rotation where required
4. quarterly access review for dormant or excessive access

## 7. Break-Glass and Recovery
- maintain one controlled break-glass admin path with dual-control storage
- usage requires ticket + approval + post-incident rotation
- recovery code process is tested periodically

## 8. Audit Requirements
- auth success/failure and MFA events
- group/role changes impacting n8n access
- workflow create/edit/delete and execution retry actions
- credential create/rotate/delete events
- break-glass use plus follow-up rotation evidence

## 9. Verification Checklist
- SSO login and role mapping behave as expected
- MFA enforced for admins and policy-selected operator/builder roles
- RBAC deny tests block non-admin access to admin functions
- break-glass process and recovery-code controls are documented/tested
- audit logs capture privileged and workflow-change actions

## 10. Client Rollout Variables
- n8n enabled
- identity mode (`oidc_sso` / `idp_local` / `break_glass_local`)
- MFA requirements by role
- allowed MFA methods
- n8n IdP group names
- project-scoped groups enabled
- session max lifetimes and idle timeout
- lockout policy
- access allowlist IPs
- break-glass account and storage method
- audit retention days
