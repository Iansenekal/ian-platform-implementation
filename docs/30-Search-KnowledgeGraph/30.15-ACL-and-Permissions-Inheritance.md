# AI Platform Deployment Documentation
## 30.15 Search + Knowledge Graph - ACL and Permissions Inheritance

LAN-only runtime - POPIA-friendly - Two-VM on Proxmox - Ubuntu 24.04

Document Control
- Document ID: `docs/30-Search-KnowledgeGraph/30.15-ACL-and-Permissions-Inheritance`
- Filename: `docs/30-Search-KnowledgeGraph/30.15-ACL-and-Permissions-Inheritance.md`
- Version: `v1.0`
- Date: `2026-02-09`
- Owner: Choice IT / Security Architecture + Search Engineering
- Status: Mandatory security gate
- Scope: ACL capture, principal mapping, inheritance, query-time enforcement, anti-leakage
- Hard requirements: no ACL leakage; deny-by-default; least privilege; auditable changes
- Related docs: `30.00`, `30.10`, `21.37`, `04.40`, `03.30`
- Authoritative permissions: source systems only (Nextcloud/SMB/M365)
- Default stance: unknown or ambiguous ACL means do not index

## 1. Security Goals and Definitions
Security goals:
- zero leakage of existence, title, snippet, path, or graph relationships for unauthorized items
- deny-by-default behavior whenever authorization confidence is incomplete
- permission consistency between source ACLs and search/graph visibility
- auditable ACL mapping and connector-scope changes

Definitions:
- principal: user or group identity that may access content
- ACL: access control list on an item
- effective ACL: ACL after inheritance and explicit exceptions
- index-time ACL: ACL captured and stored with index/graph records
- query-time filter: search API filter using caller principals

## 2. Authoritative Permissions Sources
- Nextcloud ACL/share model is authoritative for Nextcloud content
- SMB share + NTFS ACLs are authoritative for SMB content
- Microsoft Graph/SharePoint permissions are authoritative for M365 content
- Search/KG mirrors and enforces ACLs; it never grants permissions itself

## 3. Principals Model (Recommended)
- group-based authorization is the default model
- canonical project groups follow OWNER/EDIT/VIEW taxonomy
- user-specific grants are exception-only and must be governed
- group claims from IdP are authoritative for query filtering

## 4. Inheritance Rules and Exceptions
- child items inherit ACL from nearest parent container unless explicitly overridden
- project-root ACL is baseline for all descendant visibility
- sensitive folders may break inheritance (Finance/Legal/HR)
- restrictive outcome wins on ACL conflict
- unresolved inheritance or mapping ambiguity results in item exclusion

## 5. ACL Storage Model
Search index records include:
- source type, stable ID, path, project code
- allowed_groups (preferred) and optional allowed_users for approved exceptions

Knowledge graph records include:
- ACL-tagged nodes and edges
- both node and edge visibility constrained by ACL
- entity/topic nodes require at least one authorized supporting source item

Minimization:
- store principal IDs only; avoid personal metadata in ACL fields

## 6. Query-Time Enforcement Model
Mandatory sequence:
1. authenticate caller and read authoritative group claims
2. normalize principals to canonical group format
3. filter where `(doc.allowed_groups âˆ© user.groups) != empty`
4. apply policy filters (source/project/retention/hide)
5. return only safe fields after ACL pass

Field exposure policy:
- safe fields (title/snippet/path/project) only after ACL pass
- restricted fields (`allowed_groups`, raw ACL data, internal IDs) never returned to UI

## 7. Mind-Map Visibility Rules
- node visible only when authorized
- edge visible only when both endpoints are visible
- no placeholders or inferred hidden nodes
- no hidden path/title leakage in tooltips or side panels
- cross-project edges shown only when both sides are authorized

## 8. Deny-by-Default Rules
- ACL unknown: skip item
- principal mapping unknown: skip item
- no recognized user groups: return zero results
- connector scope drift/misconfiguration: pause connector and alert

## 9. ACL Drift Detection and Remediation
- scheduled source-vs-index ACL sampling
- detect renamed/stale groups and mapping drift
- trigger targeted reindex for impacted scope when thresholds breach
- record drift events and remediation actions for audit

## 10. Verification and Regression Testing
Mandatory deny tests:
- no-group user gets zero project results
- Project A-only user cannot see Project B overlap terms
- VIEW user cannot access EDIT-only isolated content

Sampling proof:
- random per-project samples compare source ACL vs search visibility
- mismatches tracked with remediation evidence

Regression cadence:
- rerun after IdP/group mapping/scope changes and major upgrades
- quarterly ACL regression in audit readiness cycle

## 11. Client Rollout Variables
- canonical principal type and group claim name
- project group naming pattern
- sensitive-folder isolation patterns
- max ACL sync lag and drift thresholds
- reindex trigger policy
- graph ACL strategy (node/edge, no placeholders)
- search field exposure policy
- evidence repository and sign-off ownership
