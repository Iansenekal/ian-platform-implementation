# AI Platform Deployment Documentation
## 71.15 Notifications and Mail - Actionable Email (Approve/Reject Links)

LAN-only - POPIA-friendly - Explicit Approve/Reject - MFA enforced at action time

Document Control
- Document ID: `docs/71-Notifications-Mail/71.15-Actionable-Email-Approve-Reject-Links`
- Filename: `docs/71-Notifications-Mail/71.15-Actionable-Email-Approve-Reject-Links.md`
- Version: `v1.0`
- Date: `2026-02-10`
- Owner: Security + Workflow Engineering
- Status: Security standard (mandatory where approvals use email)
- Hard requirements: explicit Approve/Reject; SSO+MFA required; single-use time-limited tokens; forwarding-safe execution; full audit trail
- Related docs: `70.11`, `70.20`, `70.30`, `71.10`, `03.30`

## 1. Purpose
- provide safe, auditable email-initiated approvals without trusting email as a decision channel
- standardize Approve/Reject email behavior across all approval workflows
- reduce decision latency while preserving strong identity assurance and non-repudiation

## 2. Non-Negotiable Rules
- every actionable approval email includes explicit `Approve` and `Reject` actions
- no approval by silence or email-open behavior
- action links initiate authenticated decision flow only; links never directly commit decision
- SSO login and MFA step-up are required at action time
- tokens are short-lived, single-use, and state-checked
- forwarded emails cannot authorize decisions for unauthorized identities
- reject path requires reason capture in authenticated UI

## 3. Threat Model
- forwarded email use by unintended recipients
- token theft from inbox, malware, screenshots, or copied links
- replay attempts against already-used links
- spoofed or phishing approval emails
- token leakage via logs/referrers/query sharing
- stale links from delayed email access

## 4. Security Controls
### 4.1 Token Controls
- default TTL is 15 minutes with explicit expiry
- tokens are single-use and permanently invalidated after redemption
- token scope binds to workflow step and allowed approver scope
- token value is never logged

### 4.2 Identity Binding Controls
- clicked links always validate authenticated IdP identity and approver eligibility
- unauthorized user receives generic denial response and event is audited
- optional strict-recipient mode can require original recipient identity match

### 4.3 Transport and UI Controls
- HTTPS-only links to internal frontend endpoints
- no secrets or PII in URL parameters
- decision submission uses POST + anti-CSRF token

### 4.4 Anti-Spoof Controls
- sender domain and from-addresses are controlled at relay
- enforce SPF/DKIM/DMARC where domain model supports it; otherwise enforce connector allowlists
- include consistent template branding and user warning text

## 5. Standard Email Content
- include `correlation_id`, `document_id`, `document_version`, `workflow_step`, `due_at`
- include `approve_link`, `reject_link`, `view_details_link`
- exclude document attachments, full content, secrets, and unnecessary personal data
- include a security footer stating link expiry and MFA requirement

## 6. Action Flow
1. workflow emits `STEP_ASSIGNED` and pending-decision state
2. system issues separate approve and reject tokens
3. email sends through internal relay with `correlation_id`
4. user clicks link and is redirected to internal frontend
5. SSO and MFA step-up are enforced
6. system validates token status, expiry, step state, and approver authorization
7. reject requires reason before commit
8. decision is committed, token invalidated, evidence receipt stored, audit emitted
9. confirmation page returns receipt reference; optional decision-confirmation email may send

## 7. Edge-Case Handling
- expired token: safe error + authenticated reissue flow
- already decided: show current state without allowing re-decision
- unauthorized user: generic denial response with no workflow details leaked
- mail delivery failure: pending actions remain visible in UI and operational alerting triggers

## 8. Required Audit Events
- `EMAIL_SENT`
- `ACTION_TOKEN_ISSUED` (no token value)
- `ACTION_LINK_CLICKED`
- `ACTION_AUTH_SUCCESS` / `ACTION_AUTH_FAIL`
- `APPROVAL_DECISION_APPROVED` / `APPROVAL_DECISION_REJECTED`
- `TOKEN_REDEEMED` / `TOKEN_EXPIRED` / `TOKEN_REPLAY_BLOCKED`

## 9. Verification Checklist
1. trigger approval email and confirm both Approve and Reject actions are present
2. click Approve and verify redirect to SSO + MFA before decision commit
3. replay same Approve link and verify single-use block behavior
4. test forwarded email to unauthorized user and verify decision is blocked
5. click Reject and verify reason is mandatory and workflow enters rework state
6. wait past TTL and verify expired-token flow + safe reissue path

## 10. Client Rollout Variables
- approval email enabled
- action-link TTL minutes
- strict recipient-binding mode
- allowed sender addresses/domain
- reject-reason categories required
- reminder/escalation thresholds
- decision confirmation email enabled
