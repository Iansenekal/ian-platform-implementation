# AI Platform Deployment Documentation
## 71.10 Notifications and Mail - Mail Architecture (LAN-only)

LAN-only - POPIA-friendly - Internal relay pattern

Document Control
- Document ID: `docs/71-Notifications-Mail/71.10-Mail-Architecture-LAN-Only`
- Filename: `docs/71-Notifications-Mail/71.10-Mail-Architecture-LAN-Only.md`
- Version: `v1.0`
- Date: `2026-02-10`
- Owner: DevOps + Security
- Status: Architecture standard
- Hard requirements: LAN-only; no public SMTP exposure; strict allowlists; mail notification-only; approvals require SSO+MFA
- Related docs: `71.00`, `70.11`, `70.20`, `02.20`

## 1. Goal State Architecture
- apps do not send email directly to internet endpoints
- all mail submits to a dedicated internal relay
- relay forwards to approved internal mail platform connector path
- senders are allowlisted by IP and/or authenticated credentials
- UI-only operation remains available if outbound relay is disabled

## 2. Components
- mail senders (workflow, gateway, monitoring, backup)
- optional notification router for templates/retries
- mandatory SMTP relay when email is enabled
- mailbox target platform (M365, Exchange, or internal SMTP)
- audit sink (central logging + Evidence-Pack metadata)

## 3. Reference Network Layout
- Data/Gateway sends to relay LAN endpoint (for example `10.10.5.170:25/587`)
- Frontend does not send mail directly by default
- relay may connect to upstream mail platform through approved connector
- no inbound internet SMTP to platform LAN

## 4. Trust Boundaries and Security Controls
- relay is privileged boundary, protected by UFW/IP allowlists
- app SMTP secrets stored only in protected secrets path
- email transport is not an approval decision boundary; SSO+MFA required at action time
- templates must minimize sensitive content; attachments disabled by default

## 5. Routing Models
### 5.1 Model A: Dedicated LAN Postfix relay
- recommended default for strict control and auditability

### 5.2 Model B: Existing Exchange relay
- permitted with scoped connectors and equivalent control baselines

### 5.3 Model C: UI-only
- no email dispatch; approvals and notifications remain in-app

## 6. Approve/Reject Link Flow (Email Enabled)
1. Workflow emits approval request with `correlation_id`.
2. Email template renders Approve/Reject links.
3. Links route internally and redirect to IdP login.
4. MFA step-up enforced before decision UI.
5. Decision recorded, token redeemed, audit and receipt persisted.

## 7. SMTP Relay Security Baseline
- allowlist only trusted sender IPs
- disable open relay
- enforce auth and/or IP restrictions
- enforce TLS to upstream where supported
- constrain sender domains/from addresses
- apply rate limits and queue protections
- log minimal metadata; keep sensitive logs scoped and retained by policy

## 8. Ports and Firewall Summary
- relay inbound: `25` or `587` from allowed app IPs only
- relay outbound: relay to approved mail platform on required SMTP ports
- approval link surface: `443` LAN-only to frontend

## 9. Monitoring and Audit Integration
- monitor relay uptime, queue depth, delivery latency, bounce rate
- propagate `correlation_id` through notifications and logs
- alert on sustained queue growth or delivery failure thresholds

## 10. Verification Checklist
1. Validate relay reachable only from allowlisted app IPs.
2. Send test mail from allowed app host and verify delivery.
3. Confirm open-relay checks fail for disallowed source.
4. Trigger workflow approval mail and confirm SSO+MFA enforcement.
5. Simulate upstream outage and confirm queueing + alerting behavior.

## 11. Client Rollout Variables
- routing model (A/B/C)
- relay hostname/IP
- inbound port and auth mode
- upstream TLS requirement
- allowed sender domains/addresses
- rate/retry policy
- relay log retention
