# AI Platform Deployment Documentation
## 71.40 Notifications and Mail - Audit Logging (Mail Events)

LAN-only - POPIA-friendly - Evidence-grade auditing

Document Control
- Document ID: `docs/71-Notifications-Mail/71.40-Audit-Logging-MailEvents`
- Filename: `docs/71-Notifications-Mail/71.40-Audit-Logging-MailEvents.md`
- Version: `v1.0`
- Date: `2026-02-10`
- Owner: Security + Compliance
- Status: Audit standard (mandatory)
- Hard requirements: auditable actions; `correlation_id` everywhere; no secrets in logs; minimal personal data; integrity controls; retention defined
- Related docs: `03.30`, `03.40`, `70.50`, `71.15`

## 1. Purpose
- provide a defensible audit trail for notifications and actionable email decisions
- support POPIA by logging required metadata only while preserving accountability
- support incident response and forensics through end-to-end correlation identifiers

## 2. Audit Design Principles
- correlation-first logging from workflow creation through decision and evidence receipt
- never log secrets (tokens, SMTP credentials, private keys)
- minimize PII (recipient counts or hashes by default)
- centralize logs with restricted access and retention controls
- enforce timezone-aware ISO8601 timestamps with NTP-synchronized hosts

## 3. Event Storage Locations
- primary: centralized audit store (for example OpenSearch) under restricted roles
- secondary: Evidence-Pack summaries/receipts for document workflow evidence
- local: SMTP relay logs retained short-term and optionally shipped redacted

## 4. Minimum Event Taxonomy
- `NOTIF_CREATED`
- `NOTIF_ROUTED`
- `EMAIL_SEND_ATTEMPT`
- `EMAIL_SENT`
- `EMAIL_DELIVERY_STATUS`
- `ACTION_TOKEN_ISSUED`
- `ACTION_LINK_CLICKED`
- `ACTION_AUTH_SUCCESS`
- `ACTION_AUTH_FAIL`
- `APPROVAL_DECISION_APPROVED`
- `APPROVAL_DECISION_REJECTED`
- `TOKEN_EXPIRED`
- `TOKEN_REPLAY_BLOCKED`
- `NOTIF_FAILED`

## 5. Mandatory Common Fields
- `timestamp` (ISO8601, timezone-aware)
- `event_type`
- `correlation_id`
- `source_component`
- `environment`
- `severity`

Recommended fields (policy-driven): `document_id`, `document_version`, `workflow_step_id`, `approver_group`, `recipient_count` or `recipient_hashes`, `message_id`, `template_id`.

## 6. POPIA Data-Handling Rules
- default central logging mode uses `recipient_count` and `approver_group`
- if addresses are required, constrain access and retention; prefer hashed recipients for analytics
- do not log message bodies, attachments, token URLs, or sensitive free-text
- store reject reason category in central logs; detailed free-text only in Evidence-Pack where required

## 7. Integrity and Tamper Controls
- application/service identities append-only from log-writing perspective
- log index deletion restricted to Security/Compliance with change control
- optional signed checkpoints or hash chains for high-assurance deployments

## 8. Retention Policy Baseline
- central notification/mail audit events: 365 days (default)
- SMTP relay local logs: 30-90 days (default)
- Evidence-Pack receipts: per document/compliance retention policy

## 9. Operational Monitoring Signals
- alert on `NOTIF_FAILED` rates and sustained delivery defer/bounce spikes
- alert on growing queue depth and delivery latency
- alert on `TOKEN_REPLAY_BLOCKED` spikes
- monitor token issuance-to-decision conversion for UX/delivery issues

## 10. Verification Checklist
1. trigger approval email and confirm `NOTIF_CREATED`, `EMAIL_SENT`, `ACTION_TOKEN_ISSUED`
2. approve action confirms `ACTION_LINK_CLICKED`, `ACTION_AUTH_SUCCESS`, `APPROVAL_DECISION_APPROVED`
3. replay the same link and confirm `TOKEN_REPLAY_BLOCKED`
4. let token expire and confirm `TOKEN_EXPIRED`
5. confirm no token values or SMTP credentials in logs

## 11. Client Rollout Variables
- central audit retention days
- SMTP relay log retention days
- recipient logging mode (`count` / `hash` / `full_address`)
- reject reason logging mode (`category_only` / `category_plus_evidence_text`)
- high-assurance integrity checkpoint enabled
