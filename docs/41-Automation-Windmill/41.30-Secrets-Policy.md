# AI Platform Deployment Documentation
## 41.30 Automation - Windmill (Optional) Secrets Policy

LAN-only runtime - POPIA-friendly - Two-VM on Proxmox - Ubuntu 24.04

Document Control
- Document ID: `docs/41-Automation-Windmill/41.30-Secrets-Policy`
- Filename: `docs/41-Automation-Windmill/41.30-Secrets-Policy.md`
- Version: `v1.0`
- Date: `2026-02-09`
- Owner: Choice IT / Security + Platform Ops
- Status: Mandatory if Windmill is enabled
- Scope: Windmill secrets handling, credential injection, storage rules, rotation, and incident response
- Hard requirements: no secrets in scripts, no hardcoded tokens, least privilege, auditability
- Related docs: `03.20`, `03.30`, `04.40`, `41.20`
- Default stance: secrets externalized and runtime-injected; per-integration service accounts; regular rotation
- Primary risk: Windmill code execution + secret exposure can create broad compromise
- Time zone: `Africa/Johannesburg`
- Evidence requirement: secret inventory, rotation records, secret scan evidence
- Approver: Security
- Note: if this policy is not met, Windmill must not be enabled

## 1. Policy Goals and Principles
- prevent secrets from appearing in scripts, logs, screenshots, exports, docs, or tickets
- ensure every secret has explicit owner, scope, rotation, and review lifecycle
- prevent uncontrolled secret sprawl in Windmill
- enforce POPIA minimization through safe logging and controlled metadata

## 2. Secret Types and Storage
### 2.1 Host-level secrets (mandatory)
- deployment secrets are stored in `/opt/windmill/secrets` with strict file permissions
- templates reference file paths; secret values are never inline
- examples include DB passwords, app keys, webhook signing keys, and related private keys

### 2.2 Windmill-managed secrets (governed)
- Windmill secret store usage requires encryption at rest and scoped access controls
- only admins or secret custodians can create/update secret material
- builders can reference approved secret names but not view raw values

### 2.3 Prohibited storage locations
- no secrets in scripts, job args, payload examples, docs, or source control
- no secrets in tickets, chat, or email
- no secrets in URLs or query strings

## 3. Injection Rules
- secrets are injected at runtime via approved secret mechanisms
- scripts consume secrets through environment variables or secret references only
- sensitive outputs are redacted; scripts must not print environment or request bodies
- high-risk jobs run with dedicated service identities and constrained egress

## 4. Service Accounts by Integration
### 4.1 Gateway API credentials
- prefer short-lived OIDC tokens or scoped client credentials
- API keys are endpoint-scoped and rotated frequently when used
- each call must retain attributable job/service identity

### 4.2 Nextcloud access
- prefer Gateway-mediated access for policy and audit consistency
- direct access requires dedicated scoped service accounts
- avoid Nextcloud admin privileges for automation accounts

### 4.3 Database credentials
- dedicated least-privilege DB role per script domain
- keep DB access local-only where feasible
- never access IdP databases directly from Windmill jobs

### 4.4 OpenSearch credentials
- default read-only usage for reporting and health
- write access requires explicit approval and index-level scope controls

## 5. Naming and Ownership
- naming format: `WM::<INTEGRATION>::<SCOPE>::<ENV>`
- each secret tracks owner, purpose, scope, create date, rotation date, and review date
- maintain inventory in controlled governance storage

## 6. Secret Creation Procedure
1. script owner requests secret with purpose, scope, classification, and retention impact
2. security approves least-privilege scope and lifecycle controls
3. secret custodian creates account/secret and stores host-level files securely
4. secret entry is registered in Windmill with scoped access
5. least-privilege negative tests validate blocked operations
6. inventory is updated with owner/scope/rotation metadata

## 7. Rotation Policy
- gateway client secrets/API keys: 90 days default
- Nextcloud app credentials: 90 days default
- DB passwords: 180 days default
- webhook signing keys: 180 days default
- immediate rotation on compromise, role change, or scope change

## 8. Code Review Requirements for Privileged Scripts
- privileged/sensitive scripts require peer review before promotion
- review confirms no secrets in code, minimization, safe logging, and scoped access
- high-risk scripts require security approval in addition to peer review

## 9. Secret Exposure Incident Response
1. contain: disable and rotate exposed credential immediately
2. assess: identify leak source and blast radius
3. rotate: issue new credential and update references
4. purge: remove exposed data from repos/logs/artifacts
5. review: audit script/job runs during exposure window
6. prevent: tighten controls, RBAC, and scanning coverage

## 10. Audit Requirements
- log secret create/update/rotate/delete with actor and timestamp
- record approvals and scope in inventory
- audit access to secret-management interfaces where available
- retain rotation evidence and validation outcomes

## 11. Verification Checklist
- no secrets in scripts/repos/docs/outputs; scans are clean
- host secret files have required permissions and are not world-readable
- secret inventory matches active secret usage
- least-privilege tests confirm blocked operations fail
- rotation schedule is defined and evidenced
- incident-response process is documented and tabletop-tested

## 12. Client Rollout Variables
- Windmill enabled
- secret custodian role
- secret naming convention
- gateway credential mode
- Nextcloud integration mode
- service account scopes
- DB usage and scope
- OpenSearch access mode
- rotation intervals by secret type
- secret inventory location
- secret scanning process
