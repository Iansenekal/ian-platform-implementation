# AI Platform Deployment Documentation

## 03.30 Audit Logging

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04  
Audit events, log sources, retention tiers, and verification runbook

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/03-Security-POPIA/03.30-Audit-Logging` |
| Filename (target) | `docs/03-Security-POPIA/03.30-Audit-Logging.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Client Delivery Team |
| Status | Mandatory standard; audit logging required for POPIA-friendly operations |
| Install Order Position | After 03.20 Secrets Standard; before module deployment verification checklists |
| Applies to | Gateway, Identity Provider, Nextcloud, Search/Knowledge Graph, optional n8n/Windmill, OS/system, reverse proxy |
| Primary requirement | Audit must cover identity + access + content actions + admin operations; time must be synchronized |
| Related docs | 03.40 Retention Policy; 50.* Monitoring/Logging; module-specific audit docs (Nextcloud 21.45, Gateway 10.*) |
| Change control | Audit schema and retention changes require approval; never disable audit logging without incident documentation |

## Contents

- 1. Purpose and audit outcomes
- 2. Audit principles (what must be true)
- 3. Time synchronization requirement (critical)
- 4. Audit event model (what to log)
- 5. Log sources and responsibilities by component
- 6. Log transport and storage model (LAN-only)
- 7. Access controls for logs (auditor vs admin vs ops)
- 8. Step-by-step implementation procedure (standard)
- 9. Verification checklist (mandatory commands)
- 10. Incident response linkage (how audit supports IR)
- 11. Client rollout variables (template)

## 1. Purpose and audit outcomes

Audit logging provides evidence of "who did what, when, from where" across identity, API usage, file actions, and privileged changes. For POPIA-friendly operations, audit logs are essential for detecting unauthorized access, investigating incidents, supporting data subject requests, and proving least privilege controls are working.

Audit outcomes we require:

- Identity traceability: authentication attempts, MFA events, group/role changes, session issuance and revocation.
- Content traceability: file uploads/downloads/shares/deletes/permission changes (Nextcloud) and any external sharing exceptions.
- Search traceability: query events and index admin actions (without storing sensitive query content unless required).
- Operational traceability: configuration changes, deployments, firewall changes, and privileged SSH actions.
- Tamper resistance: logs are retained with integrity and protected access (no open log browsing for normal users).

## 2. Audit principles (what must be true)

- A1: Audit is on by default for all modules. Disabling audit requires incident/change control documentation.
- A2: Logs must have correct time. Time sync is mandatory to correlate events across systems.
- A3: Minimum necessary logging. Collect enough for security and compliance but avoid unnecessary PII in logs.
- A4: Privileged actions are always logged (admin operations, role changes, connector changes, reindex, secret rotation).
- A5: Log access is restricted: auditors can read; operators can triage; only a small set can modify retention/config.
- A6: Logs are protected at rest (file permissions, restricted dashboards, backups with encryption).
- A7: Retention is defined and enforced (03.40); logs are deleted/archived per policy.

## 3. Time synchronization requirement (critical)

Without consistent time, audit logs lose forensic value. All platform VMs and the DNS/infra source must maintain correct time.

### 3.1 Standard time rules

- Timezone: Africa/Johannesburg.
- Use a trusted internal NTP source where possible (Windows Server or network time source).
- All hosts must show synchronized time (`timedatectl`).
- Time drift beyond 60 seconds is treated as a high severity operations issue.

### 3.2 Verification commands

Application/terminal: SSH to each VM.

```bash
timedatectl status
chronyc tracking || true
```

Expected: correct timezone and synchronized clock.

## 4. Audit event model (what to log)

Use a consistent event schema across components where possible.

Minimum fields:

- `timestamp` (UTC or local with timezone)
- `event_type` (`login_success`, `login_failure`, `mfa_challenge`, `file_download`, `role_change`, `api_call`, etc.)
- `actor` (user/service identity)
- `actor_groups/roles` (at time of event if available)
- `source_ip` (and user agent where applicable)
- `target` (resource id/path/project)
- `action` (`read`/`write`/`share`/`admin`)
- `result` (`success`/`failure`) + reason for failure
- `correlation_id`/`request_id` (for tracing across proxy -> UI -> Gateway -> backend)

### 4.1 Recommended audit event categories

| Category | Examples | Must be logged by |
|---|---|---|
| Identity events | login, logout, MFA challenge, lockouts, group/role changes | Identity Provider + Gateway |
| API access events | endpoint call, method, status, latency, RBAC decision | Gateway + Reverse proxy |
| File/content events | upload/download/delete/share/permission change | Nextcloud |
| Search/graph events | search query executed, graph view, reindex, connector update | Search service + Gateway |
| Admin/ops events | deployments, config changes, firewall changes, secret rotations | OS logs + change log |

## 5. Log sources and responsibilities by component

This table defines what logs exist and who is responsible for enabling them.

| Component | Log types | Where stored (default) | Access level | Key events | Notes |
|---|---|---|---|---|---|
| Reverse proxy (Frontend) | Access logs, error logs, TLS handshake errors | `/opt/<frontend>/logs/` or container logs | Ops + Auditors (read) | Requests, status codes, source IPs, rate limiting | Must include `request_id`/`correlation_id` |
| Frontend UI (Next.js) | App logs, auth callback logs | container logs + `/opt/<frontend>/logs` | Ops (triage), Auditors (read) | Auth flow, errors, user actions (non-sensitive) | Avoid logging PII; use IDs |
| Gateway API | Audit logs (RBAC decision), API access logs | `/opt/<gateway>/logs` or OpenSearch index | Auditors read; Admins manage | token validation, role checks, connector admin actions | Must be the primary correlation point |
| Identity Provider | Auth events, MFA events, admin changes | IdP internal store + export to OpenSearch | Auditors read; Admins manage | login success/fail, MFA setup, group mapping | Enable admin event logging |
| Nextcloud | File operations, sharing, permission changes, admin actions | Nextcloud logs + app audit events | Auditors + Project Owners (limited) | upload/download/share/delete, link shares, ACL changes | Granular permissions are required |
| Search/Graph services | Ingest logs, query logs, index admin logs | `/opt/<search>/logs` + OpenSearch indices | Auditors read; Admins manage | reindex, connector changes, query events | Do not store full query text unless required |
| Optional n8n/Windmill | Workflow runs, credential access, admin UI access | `/opt/<automation>/logs` | Auditors read; Admins manage | who triggered run, what workflow, result | Credentials access is sensitive |
| OS / systemd | `auth.log`, `syslog`/`journal`, `sudo` usage | `journalctl`, `/var/log` | Admins + Auditors (read) | `sudo`, `ssh`, service start/stop | Centralized collection recommended |

## 6. Log transport and storage model (LAN-only)

### 6.1 Recommended model

- Primary storage: OpenSearch (on AI-DATA01) for searchable logs and dashboards (admin-restricted).
- Secondary storage: local log files under `/opt/<stack>/logs` with strict permissions.
- System logs: `journalctl` retained locally and optionally shipped to OpenSearch via an agent (future module).
- No cloud log shipping. All logging stays on-prem and LAN-only.

### 6.2 Minimal viable approach (MVP)

- Enable audit logging within each application (IdP, Nextcloud, Gateway).
- Keep logs local and readable only by admins/auditors.
- Export to OpenSearch where supported to enable search and dashboards.
- Apply retention (03.40) so logs do not grow unbounded.

## 7. Access controls for logs (auditor vs admin vs ops)

Audit logs are sensitive: they may contain usernames, file paths, project identifiers, and incident evidence. Use least privilege for log access.

| Role | Can view dashboards? | Can export logs? | Can change retention/config? | Notes |
|---|---|---|---|---|
| Platform Admin | Yes | Yes | Yes | Small set; MFA required |
| Security Auditor | Yes (read) | Yes (read) | No | Cannot modify config |
| Operations (Ops) | Yes (limited) | Limited | No | Triage only; escalates to Admin |
| Project Owner | Limited to project audit views where supported | Limited | No | Nextcloud project-level audit only |
| Standard User | No | No | No | No direct log access |

## 8. Step-by-step implementation procedure (standard)

This procedure is a standard rollout sequence. Stack-specific documents will provide the exact configuration files and compose settings, but the process and verification steps here are mandatory.

### Step 1 - Confirm time sync (all hosts)

Application/terminal: SSH to AI-FRONTEND01 and AI-DATA01.

1. Set timezone to Africa/Johannesburg if needed.
2. Confirm NTP is configured and time is synchronized.

Verification commands:

```bash
timedatectl status
```

### Step 2 - Enable audit logging in the Identity Provider

3. Enable admin event logging, auth success/failure logging, MFA event logging, and group/role change logging.
4. Ensure logs include source IP and `correlation_id` where possible.
5. Restrict access to the IdP admin console to admins only (Zone E + MFA).

Verification (conceptual): perform one login + one failed login + one MFA event; confirm logs exist.

### Step 3 - Enable audit logging in the Gateway API

6. Enable per-request access logs (method, path, status, latency) and include `request_id`/`correlation_id`.
7. Enable RBAC decision logging for privileged endpoints.
8. Ensure sensitive payloads are not logged (no tokens, no PII fields).

Verification: call a test endpoint and confirm logs record the request with a correlation id.

### Step 4 - Enable Nextcloud audit logging for file actions

9. Enable Nextcloud file action logs (download/upload/share/delete/permission change).
10. Ensure external sharing events are logged and linked to the exception process record.
11. Restrict Nextcloud admin permissions to the smallest set.

Verification: upload a test file, share it within a project group, and confirm events appear in logs.

### Step 5 - Enable Search/Graph audit logging

12. Log connector changes, ingestion runs, reindex requests, and query executions.
13. Do not store full query text by default; log query metadata (project scope, user id, result count).
14. Ensure ACL enforcement decisions are logged for debugging (without exposing document content).

Verification: run a search query as a restricted user; confirm results and logs reflect ACL scope.

### Step 6 - Centralize logs (recommended) using OpenSearch indices

15. Define OpenSearch indices for audit logs per component (`idp-audit`, `gateway-audit`, `nextcloud-audit`, `search-audit`, `system-audit`).
16. Restrict OpenSearch Dashboards to admins/auditors only (Zone E) and never expose to general LAN users.
17. Apply retention policy (03.40) to each index (rollover + delete).

Verification: confirm indices exist and dashboards show events; confirm user access restrictions.

### Step 7 - Create the audit review routine (Day-2)

18. Define who reviews audit logs and how often (daily triage, weekly review, monthly compliance checks).
19. Define escalation triggers (multiple failed logins, unusual downloads, external shares, admin changes).
20. Record the routine in Day-2 Ops doc (05.20 LogReview).

## 9. Verification Checklist (mandatory commands)

### 9.1 OS logs and authentication events

Application/terminal: SSH to each VM.

```bash
sudo journalctl -u ufw --no-pager | tail -n 50 || true
sudo journalctl -u ssh --no-pager | tail -n 50 || true
sudo journalctl --no-pager -n 50
```

### 9.2 Container logs (spot checks)

```bash
docker ps --format 'table {{.Names}}\t{{.Status}}'
# Replace <container> with names from your stack
# docker logs --tail 100 <container>
```

Expected: audit events appear in the relevant service logs; no secrets are printed.

### 9.3 UFW + boundary checks (proof of isolation)

Application/terminal: Windows workstation PowerShell (non-admin).

```powershell
Test-NetConnection 10.10.5.179 -Port 443
Test-NetConnection 10.10.5.178 -Port 443
```

Expected: Frontend 443 succeeds; backend 443 fails from normal LAN clients.

### 9.4 Log access control checks

Use test accounts to validate log viewing restrictions.

- Standard User: cannot access dashboards/log exports.
- Auditor: can view dashboards and export logs (read-only).
- Platform Admin: can manage indices/retention and view dashboards.

## 10. Incident response linkage (how audit supports IR)

- Audit logs provide the primary timeline for incidents: identity events + file events + API events.
- During an incident: preserve logs (freeze retention changes), export relevant time ranges, and secure backups.
- Use `correlation_id` to trace a user action from ingress -> UI -> Gateway -> data operations.
- Tie external sharing events to the exception process record (approval, expiry, owner).

## 11. Client rollout variables (template)

| Variable | Value |
|---|---|
| Client name | `<ClientName>` |
| Timezone | `Africa/Johannesburg` |
| NTP source | `<Internal NTP or Windows Server>` |
| Audit log storage | OpenSearch on AI-DATA01 + local `/opt/<stack>/logs` |
| Dashboards access | Admins + Auditors only (Zone E allowlist) |
| Audit review owner | `<name/role>` |
| Review cadence | Daily triage / Weekly review / Monthly compliance |
| Escalation triggers | `<failed login threshold, unusual downloads, external sharing, admin changes>` |
| Index names | `<idp-audit, gateway-audit, nextcloud-audit, search-audit, system-audit>` |
| Retention tiers | Defined in 03.40 |
| External sharing exception owner | `<name>` |
| Automation enabled | `n8n: Yes/No; Windmill: Yes/No` |
| Automation audit requirements | Log workflow runs + credential access + triggers |
| Incident response contact | `<name/role>` |
