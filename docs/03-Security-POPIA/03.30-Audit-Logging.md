# AI Platform Deployment Documentation

## 03.30 Audit Logging

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Audit events, log sources, retention tiers, and verification runbook

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/03-Security-POPIA/03.30-Audit-Logging` |
| Filename | `docs/03-Security-POPIA/03.30-Audit-Logging.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Client Delivery Team |
| Status | Mandatory standard |
| Install Order Position | After 03.20; before module verification checklists |
| Applies to | Gateway, IdP, Nextcloud, Search/Graph, optional automation, OS/system, reverse proxy |
| Primary requirement | Identity + access + content + admin operations must be auditable |
| Change control | Schema/retention changes require approval |

## 1) Purpose and Outcomes

Audit logging must prove who did what, when, and from where across identity, API, content, and privileged admin operations.

Required outcomes:

- Identity traceability (auth, MFA, role/group changes, session lifecycle).
- Content traceability (upload/download/share/delete/permission changes).
- Search traceability (query/admin actions with metadata-only where possible).
- Operational traceability (deploy/config/firewall/SSH/admin changes).
- Tamper resistance with protected access and enforced retention.

## 2) Audit Principles

- A1: Audit enabled by default.
- A2: Time sync is mandatory.
- A3: Minimum necessary logging (avoid unnecessary PII).
- A4: Privileged actions always logged.
- A5: Log access is least-privilege.
- A6: Logs protected at rest.
- A7: Retention enforced per 03.40.

## 3) Time Synchronization (Critical)

- Timezone: `Africa/Johannesburg`.
- Trusted internal NTP source preferred.
- Drift > 60 seconds is a high-severity operations issue.

Verification commands:

```bash
timedatectl status
chronyc tracking || true
```

## 4) Audit Event Model

Minimum fields:

- `timestamp`
- `event_type`
- `actor`
- `actor_groups/roles` (if available)
- `source_ip`
- `target`
- `action`
- `result` + failure reason
- `correlation_id` / `request_id`

Recommended categories:

- identity events
- API access events
- file/content events
- search/graph events
- admin/ops events

## 5) Log Sources and Responsibilities

- Reverse proxy: access/error/TLS failures with request correlation IDs.
- Gateway API: access + RBAC decisions + admin actions.
- Identity provider: auth/MFA/admin/group-role changes.
- Nextcloud: file/share/permission/admin actions.
- Search/Graph: ingest/query/reindex/connector events.
- Optional automation: workflow run + credential access events.
- OS/systemd: SSH/sudo/service lifecycle.

## 6) Transport and Storage (LAN-Only)

- Primary: OpenSearch indices on AI-DATA01.
- Secondary: local `/opt/<stack>/logs` with strict permissions.
- System logs retained locally and optionally shipped on-prem.
- No cloud log shipping.

Suggested indices:

- `idp-audit`
- `gateway-audit`
- `nextcloud-audit`
- `search-audit`
- `system-audit`

## 7) Log Access Controls

| Role | View dashboards | Export logs | Change retention/config |
|---|---|---|---|
| Platform Admin | Yes | Yes | Yes |
| Security Auditor | Read-only | Read-only | No |
| Ops | Limited | Limited | No |
| Project Owner | Limited | Limited | No |
| Standard User | No | No | No |

## 8) Standard Implementation Procedure

Use assets in `infrastructure/audit-logging/`:

- `03.30-audit-inputs.env.example`
- `03.30-audit-sources.yml`
- `03.30-audit-verify.sh`
- `03.30-review-routine.template.md`

Flow:

1. Confirm time sync on all hosts.
2. Enable IdP admin/auth/MFA logging.
3. Enable gateway request + RBAC decision logging with `correlation_id`.
4. Enable Nextcloud file/share/permission/admin logging.
5. Enable Search/Graph query/ingest/admin logging (metadata-only by default).
6. Centralize in OpenSearch with restricted dashboards.
7. Define daily/weekly/monthly review routine and escalation thresholds.

## 9) Verification Checklist

OS/system logs:

```bash
sudo journalctl -u ufw --no-pager | tail -n 50 || true
sudo journalctl -u ssh --no-pager | tail -n 50 || true
sudo journalctl --no-pager -n 50
```

Container spot checks:

```bash
docker ps --format 'table {{.Names}}\t{{.Status}}'
# docker logs --tail 100 <container>
```

Boundary proof from non-admin LAN:

```powershell
Test-NetConnection 10.10.5.179 -Port 443
Test-NetConnection 10.10.5.178 -Port 443
```

Access control checks:

- Standard user cannot view/export logs.
- Auditor can read/export, not change settings.
- Platform admin can manage retention and index settings.

## 10) Incident Response Linkage

- Preserve relevant logs and freeze retention changes during incidents.
- Trace using `correlation_id` across ingress → UI → gateway → backend.
- Export bounded timelines and keep chain-of-custody evidence.

## 11) Client Rollout Variables

| Variable | Value |
|---|---|
| Client name | `<ClientName>` |
| Timezone | `Africa/Johannesburg` |
| NTP source | `<internal NTP>` |
| Log storage | `OpenSearch + local /opt/<stack>/logs` |
| Dashboard access | `Admins + Auditors only` |
| Review owner | `<name/role>` |
| Cadence | `daily/weekly/monthly` |
| Escalation triggers | `<thresholds>` |
| Index names | `<idp-audit,gateway-audit,nextcloud-audit,search-audit,system-audit>` |
| Retention tiers | `03.40` |
