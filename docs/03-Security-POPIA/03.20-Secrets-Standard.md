# AI Platform Deployment Documentation

## 03.20 Secrets Standard

LAN-only • POPIA-friendly • Two-VM on Proxmox • Ubuntu 24.04
Secrets storage, permissions, rotation, and verification (no hardcoded passwords)

## Document Control

| Field | Value |
|---|---|
| Document ID | `docs/03-Security-POPIA/03.20-Secrets-Standard` |
| Filename | `docs/03-Security-POPIA/03.20-Secrets-Standard.md` |
| Version | `v1.0` |
| Date | `2026-02-09` |
| Owner | Choice IT / Client Delivery Team |
| Status | Mandatory standard |
| Install Order Position | After 03.10 Least Privilege; before stack deployments |
| Applies to | All platform stacks under `/opt/<stack>/` |
| Primary requirement | No hardcoded secrets in compose/config |
| Change control | Secret changes are logged, rotated, and verified |

## 1) Purpose and Non-Negotiable Rules

This standard defines how secrets are created, stored, accessed, rotated, and verified across all stacks.

- S0: Never hardcode credentials/tokens/keys in compose/config/scripts.
- S1: Secrets live in files under `/opt/<stack>/secrets/`.
- S2: Secrets must never be copied into logs/tickets/screenshots/docs.
- S3: Minimum readers only.
- S4: Rotate on schedule and immediately on suspected compromise.
- S5: Secrets backups must be encrypted and access-restricted.
- S6: Break-glass process must be documented with two-person custody where possible.

## 2) Secret Types and Classification

| Class | Examples | Storage rule | Rotation |
|---|---|---|---|
| C1 Credentials | DB/admin/service passwords | File in `/opt/<stack>/secrets` | 90 days |
| C2 Tokens | OIDC/API/webhook secrets | File in `/opt/<stack>/secrets` | 90 days |
| C3 Keys | TLS/signing/encryption keys | File in `/opt/<stack>/secrets` (`0400`) | Annual |
| C4 Recovery | MFA recovery, break-glass creds | Offline + encrypted | Annual or after use |
| C5 Connector creds | SMB/M365 sync accounts | File + least privilege | 60-90 days |

## 3) Standard Directory Layout

Every stack should use:

- `/opt/<stack>/secrets/`
- `/opt/<stack>/secrets/README.txt` (no secret values)
- `/opt/<stack>/env/.env.template` (non-secret vars only)
- `/opt/<stack>/compose/docker-compose.yml`
- `/opt/<stack>/config/`
- `/opt/<stack>/scripts/`
- `/opt/<stack>/systemd/`

### 3.1 Naming standard

One secret per file. Examples:
`postgres_password.txt`, `oidc_client_secret.txt`, `jwt_signing_key.pem`.

Never store secret values in `.env` files.

## 4) Permissions Model

| Path type | Owner:Group | Dir perm | File perm |
|---|---|---|---|
| `/opt/<stack>/secrets/` | `root:<svcgroup>` | `0750` | n/a |
| Secret file (`.txt`) | `root:<svcgroup>` | n/a | `0440` |
| Private key (`.pem`) | `root:<svcgroup>` | n/a | `0400` preferred |
| `/opt/<stack>/env/` | `root:root` | `0750` | template `0640` |
| `/opt/<stack>/compose/` | `root:root` | `0750` | compose `0640` |

Minimum-readers rule applies for every file.

## 5) Generation Standard

Approved methods:

- `openssl rand -base64 32`
- `openssl rand -hex 64`
- `openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out private_key.pem`

Generate directly on target VM and apply restrictive ownership/permissions immediately.

## 6) Docker Compose Usage (File-Based)

- Compose references secret file paths, never secret values.
- Mount secret files read-only into containers when possible.
- Prefer `secrets:` syntax if app/runtime supports it.

## 7) Rotation Policy

Default schedule:

- Service passwords/tokens: 90 days.
- Internal TLS keys/certs: annual.
- Connector credentials: 60-90 days.
- Break-glass credentials: quarterly test, annual rotation, immediate rotation after use.

Generic rotation flow:

1. Identify dependent services.
2. Generate new secret file with strict perms.
3. Update references only if needed.
4. Restart affected services in order.
5. Verify health/auth success.
6. Record change event (no values).

## 8) Backups and Break-Glass

- Include `/opt/<stack>/secrets` in encrypted backups.
- Restore access is privileged.
- Maintain offline/segregated break-glass custody with two-person process where feasible.

## 9) Incident Response (Suspected Compromise)

1. Contain: disable suspected accounts/tokens.
2. Scope: identify dependent services/logs.
3. Rotate and redeploy affected secrets.
4. Validate controls and access paths.
5. Document incident without secret values.
6. Improve controls to prevent recurrence.

## 10) Step-by-Step Implementation

Use deterministic scripts in `infrastructure/secrets-standard/`:

- `03.20-init-stack-layout.sh`
- `03.20-generate-secret-file.sh`
- `03.20-verify-secrets-standard.sh`

These establish `/opt/<stack>` layout, generate file-based secrets with strict permissions, and verify non-hardcoded controls.

## 11) Verification Checklist (Mandatory)

Permissions:

```bash
sudo find /opt -maxdepth 6 -type f -path '*/secrets/*' -exec stat -c '%a %U:%G %n' {} \;
```

No secrets in configs:

```bash
sudo grep -RIn --exclude-dir=secrets -E 'password=|passwd|secret=|token=|BEGIN PRIVATE KEY' /opt || true
```

Docker inspect spot-check:

```bash
docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}'
```

Expected: no secret values exposed in compose/config/env output.

## 12) Client Rollout Variables

| Variable | Value |
|---|---|
| Client name | `<ClientName>` |
| Stack name | `<stack>` |
| Service group | `<svcgroup>` |
| Owner policy | `root:<svcgroup> (0440/0400)` |
| Rotation interval | `default 90 days` |
| Backup encryption method | `<method>` |
| Backup custodians | `<names>` |
| Break-glass custodians | `<names>` |
| Recovery codes storage | `offline sealed/encrypted vault` |
| Compromise response owner | `<name/role>` |
